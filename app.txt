from flask import Flask, request, jsonify, g
from flask_cors import CORS
import sqlite3, os
import barcode
from barcode.writer import ImageWriter

# Caminho do banco de dados
DB = 'estoque_tabacaria.db'

# Garante que exista a pasta onde vamos salvar os códigos de barras
os.makedirs('barcodes', exist_ok=True)

# Cria o aplicativo Flask
app = Flask(__name__)
CORS(app)

# --- Funções auxiliares ---
def get_db():
    """Conecta ao banco de dados SQLite."""
    db = getattr(g, '_database', None)
    if db is None:
        db = g._database = sqlite3.connect(DB)
        db.row_factory = sqlite3.Row
    return db

@app.teardown_appcontext
def close_connection(exception):
    """Fecha a conexão com o banco quando o app é encerrado."""
    db = getattr(g, '_database', None)
    if db is not None:
        db.close()

# --- Rotas principais ---
@app.route('/api/produtos', methods=['GET', 'POST'])
def produtos():
    db = get_db()
    if request.method == 'GET':
        cur = db.execute('SELECT * FROM produtos ORDER BY nome')
        rows = [dict(r) for r in cur.fetchall()]
        return jsonify(rows)
    else:
        data = request.json
        nome = data.get('nome')
        preco = float(data.get('preco', 0.0))

        # Inserir produto com código temporário
        cur = db.execute(
            'INSERT INTO produtos (nome, preco, codigo_barras) VALUES (?, ?, ?)',
            (nome, preco, 'TEMP')
        )
        db.commit()
        pid = cur.lastrowid

        # Gerar código de barras final (ex: 789000001)
        codigo_def = f"789{pid:06d}"

        # Atualiza o produto com o código final
        db.execute('UPDATE produtos SET codigo_barras=? WHERE id_produto=?', (codigo_def, pid))
        db.commit()

        # Gera imagem do código de barras
        EAN = barcode.get_barcode_class('code128')
        ean = EAN(codigo_def, writer=ImageWriter())
        caminho = f'barcodes/{codigo_def}.png'
        ean.save(caminho)

        return jsonify({
            "id_produto": pid,
            "nome": nome,
            "preco": preco,
            "codigo_barras": codigo_def
        }), 201

@app.route('/api/estoque', methods=['GET'])
def estoque():
    db = get_db()
    cur = db.execute("""
        SELECT p.id_produto, p.nome, p.codigo_barras, p.preco,
               IFNULL(SUM(CASE WHEN m.tipo='entrada' THEN m.quantidade
                               WHEN m.tipo='saida' THEN -m.quantidade
                               ELSE 0 END), 0) AS saldo
        FROM produtos p
        LEFT JOIN movimentacoes m ON p.id_produto = m.id_produto
        GROUP BY p.id_produto
        ORDER BY p.nome
    """)
    rows = [dict(r) for r in cur.fetchall()]
    return jsonify(rows)

# --- Inicializa o servidor ---
if __name__ == '__main__':
    app.run(debug=True)
