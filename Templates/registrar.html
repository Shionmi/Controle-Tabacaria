{% extends "base.html" %}

{% block title %}Cadastrar Produto - Tabacaria{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-title">
        <h1>Cadastrar Novo Produto</h1>
        <p>Preencha os dados do produto</p>
    </div>
</div>

<div class="panel">
    <h2>Cadastro de Produto</h2>

    <form id="form-produto" class="animated-form">
        <div class="form-row">
            <div class="form-group">
                <label for="nome">Nome do Produto*</label>
                <input id="nome" required>
            </div>
            <div class="form-group">
                <label for="categoria">Categoria</label>
                <input id="categoria">
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="preco">Preço (R$)*</label>
                <input id="preco" type="number" step="0.01" min="0" required>
            </div>
            <div class="form-group">
                <label for="quantidade">Quantidade*</label>
                <input id="quantidade" type="number" min="0" required>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Salvar Produto
            </button>
            <button type="button" class="btn btn-secondary" onclick="window.location.href='/estoque'">
                <i class="fas fa-arrow-left"></i> Voltar
            </button>
        </div>
    </form>

    <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true"></div>
</div>
{% endblock %}

            <p id="mensagem" style="margin-top:14px"></p>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/common.js') }}"></script>
    <script>
    const API = '/api/clientes';

    // Formatar CPF automaticamente
    document.getElementById('cpf').addEventListener('input', (e) => {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 11) value = value.slice(0, 11);
        if (value.length > 9) value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
        else if (value.length > 6) value = value.replace(/(\d{3})(\d{3})(\d{3})/, '$1.$2.$3');
        else if (value.length > 3) value = value.replace(/(\d{3})(\d{3})/, '$1.$2');
        e.target.value = value;
    });

    // Formatar telefone automaticamente
    document.getElementById('telefone').addEventListener('input', (e) => {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 11) value = value.slice(0, 11);
        if (value.length > 10) value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
        else if (value.length > 6) value = value.replace(/(\d{2})(\d{4})(\d+)/, '($1) $2-$3');
        else if (value.length > 2) value = value.replace(/(\d{2})(\d+)/, '($1) $2');
        e.target.value = value;
    });

    document.getElementById('form-cliente').addEventListener('submit', async (e)=> {
        e.preventDefault();
        
        const cliente = {
            nome: document.getElementById('nome').value,
            cpf: document.getElementById('cpf').value,
            telefone: document.getElementById('telefone').value,
            email: document.getElementById('email').value,
            endereco: document.getElementById('endereco').value,
            cidade: document.getElementById('cidade').value,
            estado: document.getElementById('estado').value.toUpperCase(),
            observacoes: document.getElementById('observacoes').value
        };

        try {
            const response = await fetch(API, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(cliente)
            });

            if (response.ok) {
                showMessage('Cliente cadastrado com sucesso!', 'success');
                setTimeout(() => window.location.href = '/clientes', 1500);
            } else {
                const error = await response.json();
                showMessage(error.mensagem || 'Erro ao cadastrar cliente', 'error');
            }
        } catch(err) {
            showMessage('Erro ao cadastrar cliente: ' + err.message, 'error');
        }
    });{
      e.preventDefault();

      const nome = document.getElementById('nome').value.trim();
      const categoria = document.getElementById('categoria').value.trim();
      const preco = parseFloat(document.getElementById('preco').value) || 0;
      const quantidade = parseInt(document.getElementById('quantidade').value) || 0;
      const mensagem = document.getElementById('mensagem');

      if(!nome){
        mensagem.textContent = "❌ O nome do produto é obrigatório.";
        mensagem.style.color = "red";
        return;
      }

      try {
        const res = await fetch(API, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({nome, categoria, preco, quantidade})
        });

        const data = await res.json();

        if(res.ok){
          mensagem.textContent = "✅ " + (data.mensagem || 'Produto registrado com sucesso.');
          mensagem.style.color = "green";
          document.getElementById('form-produto').reset();
        } else {
          mensagem.textContent = "❌ " + (data.erro || "Erro ao registrar produto.");
          mensagem.style.color = "red";
        }

      } catch (err) {
        mensagem.textContent = "⚠️ Erro de conexão com o servidor.";
        mensagem.style.color = "red";
      }
    };
    </script>

</body>
</html>
