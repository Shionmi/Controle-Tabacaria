<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Fornecimento - Tabacaria</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="container">
    <div class="header">
      <img src="{{ url_for('static', filename='Images/Logo_tabacaria.png') }}" alt="Logo" class="logo">
      <div>
        <h1>Registro de Fornecimento</h1>
        <p class="muted">Informe o produto e a quantidade recebida do fornecedor</p>
      </div>
      <div class="header-actions">
        <button class="btn btn-secondary" onclick="window.location.href='/'">In√≠cio</button>
        <button class="btn btn-secondary" onclick="window.location.href='/estoque'">Estoque</button>
      </div>
    </div>

    <div class="panel" style="margin-top:16px">
      <h2>ü§ù Novo Fornecimento</h2>

      <form id="fornecimentoForm">
        <div class="form-group">
          <label>Produto</label>
          <select id="productSelect" required>
            <option value="">Carregando produtos...</option>
          </select>
        </div>

        <div class="form-group">
          <label>Fornecedor</label>
          <input id="supplierName" placeholder="Nome do fornecedor (opcional)">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Quantidade Recebida</label>
            <input id="supplyQty" type="number" min="1" value="1" required>
          </div>
          <div class="form-group">
            <label>Data</label>
            <input id="supplyDate" type="date">
          </div>
        </div>

        <div class="form-group">
          <label>Observa√ß√µes</label>
          <textarea id="supplyNote" rows="3" placeholder="Observa√ß√µes... (ex: lote, nota fiscal)"></textarea>
        </div>

        <div class="btn-group">
          <button type="submit" class="btn btn-primary">Registrar Fornecimento</button>
          <button type="button" class="btn btn-secondary" onclick="document.getElementById('fornecimentoForm').reset()">Limpar</button>
        </div>

        <p id="formMessage" style="margin-top:12px"></p>
      </form>
    </div>

  </div>

  <script src="{{ url_for('static', filename='js/common.js') }}"></script>
  <script>
    // Fornecedor page JS: fetch products, increment quantidade via PUT
    const API = '/api/produtos';
    const select = document.getElementById('productSelect');
    const msg = document.getElementById('formMessage');

    async function loadProductsForSupplier(){
      select.innerHTML = '<option value="">Carregando...</option>';
      try{
        const res = await fetch(API);
        if(!res.ok) throw new Error('Erro ao carregar produtos');
        const produtos = await res.json();
        if(!produtos.length){ select.innerHTML = '<option value="">Nenhum produto cadastrado</option>'; return }
        select.innerHTML = '<option value="">-- selecione o produto --</option>' + produtos.map(p=>`<option value="${p.id_produto}" data-qty="${p.quantidade}" data-nome="${p.nome}" data-preco="${p.preco}" data-categoria="${p.categoria||''}">${p.nome} (Qtd atual: ${p.quantidade})</option>`).join('');
      }catch(err){ console.error(err); select.innerHTML = '<option value="">Erro ao carregar</option>'; }
    }

    document.getElementById('fornecimentoForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      msg.textContent = '';
      const prodId = select.value;
      if(!prodId){ msg.textContent = 'Selecione um produto.'; msg.style.color='red'; return }
      const fornecedor = document.getElementById('supplierName').value.trim();
      const qty = parseInt(document.getElementById('supplyQty').value) || 0;
      const date = document.getElementById('supplyDate').value || new Date().toISOString().slice(0,10);
      const note = document.getElementById('supplyNote').value.trim();

      try{
        // fetch current product list and find product
        const r = await fetch(API);
        if(!r.ok) throw new Error('Falha ao obter produto');
        const produtos = await r.json();
        const prod = produtos.find(p=>String(p.id_produto)===String(prodId));
        if(!prod) throw new Error('Produto n√£o encontrado no servidor');

        const newQty = (parseInt(prod.quantidade) || 0) + qty;
        // prepare payload - keep other fields unchanged
        const payload = { nome: prod.nome, categoria: prod.categoria || '', preco: Number(prod.preco)||0, quantidade: newQty };

        const res = await fetch(`${API}/${prodId}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        if(!res.ok) {
          const data = await res.json().catch(()=>({erro:'erro'}));
          throw new Error(data.erro || 'Falha ao atualizar estoque');
        }

        // Optionally, you could also log movimenta√ß√£o em outra API se existir
        msg.textContent = `‚úÖ Fornecimento registrado: +${qty} em ${prod.nome}`;
        msg.style.color = 'green';
        document.getElementById('fornecimentoForm').reset();
        loadProductsForSupplier();

      }catch(err){ console.error(err); msg.textContent = '‚ùå ' + (err.message||'Erro'); msg.style.color='red'; }
    });

    // init
    (function init(){
      // set default date to today
      const today = new Date().toISOString().slice(0,10);
      document.getElementById('supplyDate').value = today;
      loadProductsForSupplier();
    })();
  </script>
</body>
</html>
