{% extends "base.html" %}

{% block title %}Histórico de Movimentações{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-title">
        <h1>Histórico de Movimentações</h1>
        <p>Entradas e saídas de estoque</p>
    </div>
</div>

<div class="panel">
    <h2>Filtrar Movimentações</h2>
    <div id="movAlert"></div>

    <div style="display: grid; grid-template-columns: 1fr auto auto auto auto; gap: 12px; align-items: end; margin-bottom: 24px;">
        <div class="form-group" style="margin-bottom: 0;">
            <label>Pesquisar</label>
            <input id="q" placeholder="Produto ou observação..." style="background: rgba(255,255,255,0.05);">
        </div>
        <div class="form-group" style="margin-bottom: 0;">
            <label>Data Início</label>
            <input id="start_date" type="date">
        </div>
        <div class="form-group" style="margin-bottom: 0;">
            <label>Data Fim</label>
            <input id="end_date" type="date">
        </div>
        <button class="btn btn-primary" id="btnFilter" style="height: 46px;">
            <i class="fas fa-filter"></i> Filtrar
        </button>
        <button class="btn btn-secondary" id="btnClear" style="height: 46px;">
            <i class="fas fa-times"></i> Limpar
        </button>
    </div>

    <div style="overflow-x: auto;">
        <table class="table" id="movTable">
            <thead>
                <tr>
                    <th>ID Venda</th>
                    <th>Cliente / Produto</th>
                    <th>Tipo</th>
                    <th>Qtd</th>
                    <th>Data</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                <tr><td colspan="6" style="text-align: center; padding: 20px;">Carregando...</td></tr>
            </tbody>
        </table>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    const API = '/api/movimentacoes';
    const tableBody = document.querySelector('#movTable tbody');
    const movAlert = document.getElementById('movAlert');
    const vendaCache = {};

    function showAlert(msg, ok=true){ 
        movAlert.innerHTML = `<div style="padding: 12px; margin-bottom: 16px; border-radius: var(--radius-sm); background: ${ok ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)'}; color: ${ok ? '#10b981' : '#ef4444'}; border: 1px solid ${ok ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)'};">${msg}</div>`; 
        setTimeout(()=>movAlert.innerHTML='',5000); 
    }

    function escapeHtml(text) {
        if (!text) return text;
        return text.replace(/&/g, "&amp;")
                   .replace(/</g, "&lt;")
                   .replace(/>/g, "&gt;")
                   .replace(/"/g, "&quot;")
                   .replace(/'/g, "&#039;");
    }

    async function loadMov(limit=100){
        tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">Carregando...</td></tr>';
        try{
            const q = document.getElementById('q').value.trim();
            const start = document.getElementById('start_date').value || null;
            const end = document.getElementById('end_date').value || null;
            const params = new URLSearchParams();
            if(limit) params.set('limit', limit);
            if(q) params.set('q', q);
            if(start) params.set('start_date', start + ' 00:00:00');
            if(end) params.set('end_date', end + ' 23:59:59');

            const res = await fetch(API + '?' + params.toString());
            if(!res.ok) throw new Error('Falha ao carregar movimentações');
            const data = await res.json();
            
            if(!data.length) { 
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">Nenhuma movimentação encontrada</td></tr>'; 
                return 
            }

            // Pre-fetch sales info
            const vendaRe = /Venda\s*#(\d+)/i;
            const vendaIds = [];
            
            for(const m of data){
                const match = (m.observacao||'').match(vendaRe);
                if(match){
                    const vendaId = parseInt(match[1]);
                    vendaIds.push({movId: m.id_mov, vendaId});
                }
            }

            await Promise.all(vendaIds.map(async pair => {
                try{
                    if(!vendaCache[pair.vendaId]) {
                        const res = await fetch(`/api/vendas/${pair.vendaId}`);
                        if(res.ok){ vendaCache[pair.vendaId] = await res.json(); }
                    }
                }catch(e){ /* ignore */ }
            }));

            const rowsOut = [];
            for(const m of data){
                const pair = vendaIds.find(v => v.movId === m.id_mov);
                let vendaIdDisplay = '-';
                let mainInfo = m.produto_nome || '?';
                let details = '';

                if(pair){
                    const venda = vendaCache[pair.vendaId] || {};
                    vendaIdDisplay = `<span style="color: var(--accent-gold); font-weight: bold;">#${pair.vendaId}</span>`;
                    mainInfo = venda.cliente_nome || 'Cliente não identificado';
                    
                    // Build details row content
                    if(venda.itens && venda.itens.length){
                        details = `
                            <div style="margin-top: 8px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: var(--radius-sm);">
                                <strong style="color: var(--text-muted); display: block; margin-bottom: 8px;">Itens da Venda:</strong>
                                <ul style="list-style: disc; padding-left: 20px; color: var(--text-muted);">
                                    ${venda.itens.map(i => `<li>${i.produto_nome} (x${i.quantidade}) - R$ ${Number(i.preco_unitario).toFixed(2)}</li>`).join('')}
                                </ul>
                                <div style="margin-top: 8px; text-align: right; font-weight: bold; color: var(--accent-gold);">
                                    Total: R$ ${Number(venda.valor_total).toFixed(2)}
                                </div>
                            </div>
                        `;
                    }
                } else {
                    // Not a sale (manual adjustment, etc)
                    details = `<div style="margin-top: 8px; color: var(--text-muted);">${m.observacao || 'Sem observações'}</div>`;
                }

                rowsOut.push(`
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                        <td>${vendaIdDisplay}</td>
                        <td>
                            <div style="font-weight: 500;">${mainInfo}</div>
                            ${!pair ? `<small style="color: var(--text-muted);">${m.produto_nome}</small>` : ''}
                        </td>
                        <td><span class="badge" style="color: ${m.tipo === 'entrada' ? 'var(--success)' : 'var(--danger)'}">${m.tipo.toUpperCase()}</span></td>
                        <td>${m.quantidade}</td>
                        <td>${m.data_mov}</td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 4px 8px;" onclick="toggleDetails(${m.id_mov})">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </td>
                    </tr>
                    <tr id="details-${m.id_mov}" style="display:none; background: rgba(255,255,255,0.02);">
                        <td colspan="6" style="padding: 0 20px 20px 20px;">
                            ${details}
                        </td>
                    </tr>
                `);
            }
            tableBody.innerHTML = rowsOut.join('');
        } catch(err){
            console.error(err);
            showAlert('Erro ao carregar dados', false);
        }
    }

    function toggleDetails(id){
        const row = document.getElementById(`details-${id}`);
        if(row.style.display === 'none') row.style.display = 'table-row';
        else row.style.display = 'none';
    }

    document.getElementById('btnFilter').addEventListener('click', () => loadMov(100));
    document.getElementById('btnClear').addEventListener('click', () => {
        document.getElementById('q').value = '';
        document.getElementById('start_date').value = '';
        document.getElementById('end_date').value = '';
        loadMov(100);
    });

    loadMov();
</script>
{% endblock %}
