{% extends "base.html" %}

{% block title %}Painel - Controle de Estoque{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-title">
        <h1>Painel de Controle</h1>
        <p>Acesso rápido às áreas principais e histórico recente</p>
    </div>
    <div class="header-actions">
        <button class="btn btn-primary" onclick="window.location.href='/venda'">
            <i class="fas fa-shopping-cart"></i> Nova Venda
        </button>
    </div>
</div>

<div class="panel">
    <h2>Visão Geral</h2>
    <div class="dash-grid">
        <div class="dash-card" onclick="location.href='/estoque'">
            <div class="icon">
                <i class="fas fa-box-open"></i>
            </div>
            <div class="meta">
                <h3>Produtos Cadastrados</h3>
                <p id="countProducts">...</p>
            </div>
        </div>

        <div class="dash-card" onclick="location.href='/estoque'">
            <div class="icon">
                <i class="fas fa-layer-group"></i>
            </div>
            <div class="meta">
                <h3>Total em Estoque</h3>
                <p id="totalStock">...</p>
            </div>
        </div>

        <div class="dash-card" onclick="location.href='/movimentacoes'">
            <div class="icon">
                <i class="fas fa-history"></i>
            </div>
            <div class="meta">
                <h3>Movimentações</h3>
                <p>Ver histórico</p>
            </div>
        </div>
    </div>
</div>

<div class="panel">
    <h2>Módulos ERP</h2>
    <div class="dash-grid" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));">
        <div class="dash-card" onclick="location.href='/dashboard_financeiro'">
            <div class="icon" style="background: rgba(239, 68, 68, 0.1); color: #ef4444;">
                <i class="fas fa-chart-line"></i>
            </div>
            <div>
                <h3>Dashboard Financeiro</h3>
                <p style="font-size: 0.9rem; font-weight: 400;">KPIs e indicadores</p>
            </div>
        </div>

        <div class="dash-card" onclick="location.href='/fornecedores'">
            <div class="icon" style="background: rgba(239, 68, 68, 0.1); color: #ef4444;">
                <i class="fas fa-truck"></i>
            </div>
            <div>
                <h3>Fornecedores</h3>
                <p style="font-size: 0.9rem; font-weight: 400;">Gestão de fornecedores</p>
            </div>
        </div>

        <div class="dash-card" onclick="location.href='/compras'">
            <div class="icon" style="background: rgba(239, 68, 68, 0.1); color: #ef4444;">
                <i class="fas fa-file-invoice"></i>
            </div>
            <div>
                <h3>Compras</h3>
                <p style="font-size: 0.9rem; font-weight: 400;">Pedidos a fornecedores</p>
            </div>
        </div>

        <div class="dash-card" onclick="location.href='/contas_pagar'">
            <div class="icon" style="background: rgba(239, 68, 68, 0.1); color: #ef4444;">
                <i class="fas fa-money-bill-wave"></i>
            </div>
            <div>
                <h3>Contas a Pagar</h3>
                <p style="font-size: 0.9rem; font-weight: 400;">Gestão de pagamentos</p>
            </div>
        </div>

        <div class="dash-card" onclick="location.href='/contas_receber'">
            <div class="icon" style="background: rgba(16, 185, 129, 0.1); color: #10b981;">
                <i class="fas fa-hand-holding-usd"></i>
            </div>
            <div>
                <h3>Contas a Receber</h3>
                <p style="font-size: 0.9rem; font-weight: 400;">Controle de recebíveis</p>
            </div>
        </div>

        <div class="dash-card" onclick="location.href='/fluxo_caixa'">
            <div class="icon" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6;">
                <i class="fas fa-cash-register"></i>
            </div>
            <div>
                <h3>Fluxo de Caixa</h3>
                <p style="font-size: 0.9rem; font-weight: 400;">Entradas e saídas</p>
            </div>
        </div>

        <div class="dash-card" onclick="location.href='/inventario'">
            <div class="icon" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6;">
                <i class="fas fa-clipboard-list"></i>
            </div>
            <div>
                <h3>Inventário</h3>
                <p style="font-size: 0.9rem; font-weight: 400;">Contagem física</p>
            </div>
        </div>

        <div class="dash-card" onclick="location.href='/relatorios'">
            <div class="icon" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6;">
                <i class="fas fa-chart-bar"></i>
            </div>
            <div>
                <h3>Relatórios</h3>
                <p style="font-size: 0.9rem; font-weight: 400;">Análises e indicadores</p>
            </div>
        </div>
    </div>
</div>

<div class="panel">
    <h2>Últimas Movimentações</h2>
    <table id="recentMovesTable">
        <thead>
            <tr>
                <th>Produto</th>
                <th>Tipo</th>
                <th>Qtd</th>
                <th>Data</th>
            </tr>
        </thead>
        <tbody id="recentMovesBody">
            <tr><td colspan="4">Carregando...</td></tr>
        </tbody>
    </table>
    <div style="text-align:right; margin-top:20px">
        <button class="btn btn-secondary" onclick="location.href='/movimentacoes'">Ver todas</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    async function fetchCounts(){
        try{
            const p = await fetch('/api/produtos');
            const produtos = p.ok? await p.json():[];
            document.getElementById('countProducts').textContent = produtos.length;
            const total = produtos.reduce((s,item)=> s + (parseInt(item.quantidade)||0), 0);
            document.getElementById('totalStock').textContent = total;

            const m = await fetch('/api/movimentacoes?limit=5');
            const moves = m.ok? await m.json():[];
            const tbody = document.getElementById('recentMovesBody');
            
            if(!moves.length) { 
                tbody.innerHTML = '<tr><td colspan="4">Nenhuma movimentação recente</td></tr>'; 
                return 
            }
            
            tbody.innerHTML = moves.map(mi => `
                <tr>
                    <td>${mi.produto_nome||'?'}</td>
                    <td><span class="badge badge-${mi.tipo === 'entrada' ? 'success' : 'danger'}">${mi.tipo}</span></td>
                    <td>${mi.quantidade}</td>
                    <td>${mi.data_mov}</td>
                </tr>
            `).join('');
        }catch(e){ console.error(e); }
    }
    fetchCounts();
</script>
{% endblock %}
