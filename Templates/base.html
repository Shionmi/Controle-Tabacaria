<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Estoque Tabacaria{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- Inter & Poppins fonts (Modern & Clean) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='Images/Logo_tabacaria.png') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='Images/Logo_tabacaria.png') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Mobile Optimizations for Modals (Bottom Sheet Style) */
        @media (max-width: 768px) {
            .modal {
                align-items: flex-end; /* Align to bottom */
                padding: 0;
            }
            
            .modal .modal-content {
                width: 100%;
                max-width: 100%;
                border-radius: 20px 20px 0 0; /* Rounded top corners */
                margin: 0;
                max-height: 85vh;
                overflow-y: auto;
                animation: slideUp 0.3s ease-out;
                padding-bottom: 40px; /* Safe area for bottom */
            }

            @keyframes slideUp {
                from { transform: translateY(100%); }
                to { transform: translateY(0); }
            }
        }

        /* Mobile Action Bubbles (Floating Menu) */
        .mobile-action-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 9999;
            display: none;
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
        }

        .mobile-action-overlay.active {
            display: block;
            animation: fadeInOverlay 0.2s ease-out;
        }

        .mobile-action-container {
            position: absolute;
            display: flex;
            flex-direction: column-reverse; /* Stack upwards */
            gap: 16px;
            align-items: center;
            /* Position set by JS */
            transform: translate(-50%, -100%); /* Anchor bottom-center to the click point */
            padding-bottom: 10px;
        }

        .action-bubble {
            width: 56px; /* Slightly smaller for vertical stack */
            height: 56px;
            border-radius: 50%;
            background: #1e293b;
            border: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #f8fafc;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
            text-decoration: none;
            position: relative;
        }

        .action-bubble:active {
            transform: scale(0.9);
            background: #334155;
        }

        .action-bubble i {
            font-size: 1.2rem;
            margin-bottom: 2px;
        }

        .action-bubble span {
            font-size: 0.6rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Bubble Colors */
        .bubble-details { color: #38bdf8; border-color: rgba(56, 189, 248, 0.3); } /* Sky Blue */
        .bubble-edit { color: #fbbf24; border-color: rgba(251, 191, 36, 0.3); } /* Amber */
        .bubble-delete { color: #f87171; border-color: rgba(248, 113, 113, 0.3); } /* Red */
        .bubble-print { color: #4ade80; border-color: rgba(74, 222, 128, 0.3); } /* Green */

        @keyframes slideUpBubble {
            0% { transform: translateY(20px) scale(0.5); opacity: 0; }
            70% { transform: translateY(-5px) scale(1.05); opacity: 1; }
            100% { transform: translateY(0) scale(1); opacity: 1; }
        }

        @keyframes fadeInOverlay {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
    {% block extra_css %}{% endblock %}
</head>
<body>
    <div class="app-layout">
        <!-- Mobile Drawer Handle (Outside Nav) -->
        <div class="drawer-handle"></div>

        <!-- Side Drawer Navigation -->
        <nav class="side-drawer">
            
            <div class="drawer-logo">
                <img src="{{ url_for('static', filename='images/Logo_tabacaria.png') }}" alt="Logo">
            </div>

            <a href="/" class="nav-item {% if request.endpoint == 'index' %}active{% endif %}">
                <i class="fas fa-home"></i> Início
            </a>
            
            <a href="/estoque" class="nav-item {% if request.endpoint == 'estoque' %}active{% endif %}">
                <i class="fas fa-box-open"></i> Estoque
            </a>
            
            <a href="/venda" class="nav-item {% if request.endpoint == 'venda' %}active{% endif %}">
                <i class="fas fa-shopping-cart"></i> Nova Venda
            </a>
            
            <a href="/movimentacoes" class="nav-item {% if request.endpoint == 'movimentacoes_page' %}active{% endif %}">
                <i class="fas fa-exchange-alt"></i> Movimentações
            </a>
            
            <div class="nav-group">
                <span class="nav-group-title">Consultas</span>
                <a href="/clientes" class="nav-item {% if request.endpoint == 'listar_clientes' %}active{% endif %}">
                    <i class="fas fa-users"></i> Clientes
                </a>
            </div>

            <div class="nav-group">
                <span class="nav-group-title">Compras</span>
                <a href="/fornecedores" class="nav-item {% if request.endpoint == 'fornecedores_page' %}active{% endif %}">
                    <i class="fas fa-truck"></i> Fornecedores
                </a>
                <a href="/compras" class="nav-item {% if request.endpoint == 'compras_page' %}active{% endif %}">
                    <i class="fas fa-file-invoice"></i> Pedidos de Compra
                </a>
            </div>

            <div class="nav-group">
                <span class="nav-group-title">Financeiro</span>
                <a href="/dashboard_financeiro" class="nav-item {% if request.endpoint == 'dashboard_financeiro' %}active{% endif %}">
                    <i class="fas fa-chart-line"></i> Dashboard
                </a>
                <a href="/contas_pagar" class="nav-item {% if request.endpoint == 'contas_pagar_page' %}active{% endif %}">
                    <i class="fas fa-money-bill-wave"></i> Contas a Pagar
                </a>
                <a href="/contas_receber" class="nav-item {% if request.endpoint == 'contas_receber_page' %}active{% endif %}">
                    <i class="fas fa-hand-holding-usd"></i> Contas a Receber
                </a>
                <a href="/fluxo_caixa" class="nav-item {% if request.endpoint == 'fluxo_caixa_page' %}active{% endif %}">
                    <i class="fas fa-cash-register"></i> Fluxo de Caixa
                </a>
            </div>

            <div class="nav-group">
                <span class="nav-group-title">Gestão</span>
                <a href="/inventario" class="nav-item {% if request.endpoint == 'inventario_page' %}active{% endif %}">
                    <i class="fas fa-clipboard-list"></i> Inventário
                </a>
                <a href="/relatorios" class="nav-item {% if request.endpoint == 'relatorios_page' %}active{% endif %}">
                    <i class="fas fa-chart-bar"></i> Relatórios
                </a>
            </div>
        </nav>

        <main class="main-content">
            {% block content %}{% endblock %}
        </main>
    </div>

    {% block extra_js %}{% endblock %}
    
    <!-- Mobile Action Overlay HTML -->
    <div class="mobile-action-overlay" id="mobileActionOverlay" onclick="closeMobileActions(event)">
        <div class="mobile-action-container" id="mobileActionContainer">
            <!-- Bubbles injected via JS -->
        </div>
    </div>

    <script>
        // --- Mobile Bubble Menu Functions (Global) ---
        function showMobileActions(row) {
            const container = document.getElementById('mobileActionContainer');
            container.innerHTML = ''; // Clear previous

            // Position the container relative to the clicked row
            const rect = row.getBoundingClientRect();
            const centerX = rect.left + (rect.width / 2);
            const centerY = rect.top + (rect.height / 2);
            
            container.style.left = `${centerX}px`;
            container.style.top = `${centerY}px`;

            // Extract actions from the row
            const buttons = row.querySelectorAll('button, a.btn');
            
            if (buttons.length === 0) return;

            Array.from(buttons).forEach((btn, index) => {
                if (btn.style.display === 'none' || btn.disabled || btn.offsetParent === null) return;

                const bubble = document.createElement('div');
                bubble.className = 'action-bubble';
                
                bubble.onclick = (e) => {
                    e.stopPropagation();
                    bubble.style.transform = 'scale(0.9)';
                    setTimeout(() => {
                        btn.click();
                        closeMobileActions();
                    }, 100);
                };

                let iconClass = 'fas fa-circle';
                let label = 'Ação';
                let colorClass = '';

                const btnHtml = btn.innerHTML.toLowerCase();
                const btnTitle = (btn.title || '').toLowerCase();
                const btnText = btn.innerText.toLowerCase();

                if (btnHtml.includes('fa-eye') || btnTitle.includes('detalhes') || btnText.includes('detalhes')) {
                    iconClass = 'fas fa-eye';
                    label = 'Ver';
                    colorClass = 'bubble-details';
                } else if (btnHtml.includes('fa-edit') || btnTitle.includes('editar') || btnText.includes('editar')) {
                    iconClass = 'fas fa-edit';
                    label = 'Editar';
                    colorClass = 'bubble-edit';
                } else if (btnHtml.includes('fa-trash') || btnTitle.includes('excluir') || btnText.includes('excluir')) {
                    iconClass = 'fas fa-trash';
                    label = 'Excluir';
                    colorClass = 'bubble-delete';
                } else if (btnHtml.includes('fa-print') || btnTitle.includes('imprimir') || btnText.includes('imprimir')) {
                    iconClass = 'fas fa-print';
                    label = 'Print';
                    colorClass = 'bubble-print';
                } else {
                    if (btnHtml.includes('fa-')) {
                        const match = btnHtml.match(/fa-[a-z0-9-]+/);
                        if (match) iconClass = 'fas ' + match[0];
                    }
                }

                if (colorClass) bubble.classList.add(colorClass);
                bubble.innerHTML = `<i class="${iconClass}"></i><span>${label}</span>`;
                bubble.style.animation = `slideUpBubble 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) ${index * 0.08}s backwards`;
                container.appendChild(bubble);
            });

            const overlay = document.getElementById('mobileActionOverlay');
            overlay.classList.add('active');
            if (navigator.vibrate) navigator.vibrate(50);
        }

        function closeMobileActions(e) {
            if (e && e.target !== document.getElementById('mobileActionOverlay')) return;
            const overlay = document.getElementById('mobileActionOverlay');
            overlay.classList.remove('active');
        }

        // Add touch support for mobile
        document.addEventListener('DOMContentLoaded', function() {
            const drawer = document.querySelector('.side-drawer');
            const handle = document.querySelector('.drawer-handle');
            
            // Prevent page scroll on navigation
            document.documentElement.style.scrollBehavior = 'auto';

            // --- Mobile Double-Tap Interaction for Tables ---
            let lastTap = 0;
            document.addEventListener('touchend', function(e) {
                const currentTime = new Date().getTime();
                const tapLength = currentTime - lastTap;
                
                if (tapLength < 500 && tapLength > 0) {
                    const row = e.target.closest('tr');
                    if (row) {
                        e.preventDefault();
                        showMobileActions(row);
                    }
                }
                lastTap = currentTime;
            });
            
            document.addEventListener('dblclick', function(e) {
                const row = e.target.closest('tr');
                if (row) {
                    showMobileActions(row);
                }
            });
            
            handle.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                drawer.classList.toggle('active');
            });
            
            // Close drawer when clicking on nav links (mobile)
            const navLinks = drawer.querySelectorAll('.nav-item');
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    // Save SIDEBAR scroll position before navigation
                    const sidebarScrollPos = drawer.scrollTop;
                    sessionStorage.setItem('sidebarScrollPos', sidebarScrollPos);
                    
                    // Only close drawer on mobile (when drawer is active)
                    if (drawer.classList.contains('active')) {
                        drawer.classList.remove('active');
                    }
                });
            });
            
            // Restore SIDEBAR scroll position after page load
            const savedSidebarScrollPos = sessionStorage.getItem('sidebarScrollPos');
            if (savedSidebarScrollPos) {
                drawer.scrollTop = parseInt(savedSidebarScrollPos);
                // We don't remove it immediately in case the user refreshes? 
                // Actually, usually we keep it. But if they navigate away and back?
                // Let's keep it in sessionStorage until overwritten.
            }
            
            // Close drawer when clicking outside
            document.addEventListener('click', (e) => {
                if (!drawer.contains(e.target) && !handle.contains(e.target) && drawer.classList.contains('active')) {
                    drawer.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>