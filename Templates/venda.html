{% extends "base.html" %}

{% block title %}Registrar Venda{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-title">
        <h1>Registrar Venda</h1>
        <p>Selecione os produtos e finalize a venda</p>
    </div>
</div>

<div class="panel">
    <h2>Nova Venda</h2>
    <div id="alertBox"></div>

    <form id="saleForm" autocomplete="off">
        <!-- Cliente Section -->
        <div class="form-group" style="background: rgba(255,255,255,0.02); padding: 20px; border-radius: var(--radius-md); border: 1px solid rgba(255,255,255,0.05);">
            <label style="font-size: 1.1rem; color: var(--accent-gold); margin-bottom: 16px;">Cliente</label>
            
            <div style="display:flex; gap:24px; align-items:center; margin-bottom:16px">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="radio" name="cliente_mode" value="existing" checked> 
                    <span>Cliente cadastrado</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="radio" name="cliente_mode" value="manual"> 
                    <span>Digitar nome</span>
                </label>
            </div>

            <div id="clienteExisting">
                <div style="position:relative">
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="clienteNome" placeholder="Buscar cliente cadastrado..." autocomplete="off">
                        <button type="button" id="clienteToggle" class="btn btn-secondary" style="padding: 0 16px;">▼</button>
                    </div>
                    <div id="clienteList" style="display:none; position:absolute; top: 100%; left:0; right:0; background: var(--bg-card); border:1px solid var(--accent-gold); border-radius: var(--radius-sm); margin-top:4px; max-height:200px; overflow-y:auto; z-index:50; box-shadow: var(--shadow-md);"></div>
                </div>
                <div id="clienteDetails" style="display:none; margin-top:12px; background: rgba(239, 68, 68, 0.1); padding: 12px; border-radius: var(--radius-sm); border: 1px solid rgba(239, 68, 68, 0.2); color: var(--text-main);"></div>
            </div>

            <div id="clienteManual" style="display:none">
                <input type="text" id="clienteManualNome" placeholder="Digite o nome do cliente">
            </div>
        </div>

        <!-- Items Section -->
        <div class="form-group" style="margin-top: 24px;">
            <label style="font-size: 1.1rem; color: var(--accent-gold); margin-bottom: 16px;">Itens da Venda</label>
            
            <div id="itemsList" style="display: grid; gap: 12px;">
                <div class="item-row" style="display: grid; grid-template-columns: 1fr 100px 40px; gap: 12px; align-items: center;">
                    <select class="produto-select" required>
                        <option value="">Selecione um produto...</option>
                    </select>
                    <input type="number" class="quantidade-input" min="1" placeholder="Qtd" required>
                    <button type="button" class="btn btn-danger btn-remove" onclick="this.closest('.item-row').remove(); updatePreview()" style="display:none; padding: 8px;">&times;</button>
                </div>
            </div>
            
            <button type="button" class="btn btn-secondary" style="margin-top: 16px; width: 100%; border-style: dashed;" onclick="addItemRow()">
                <i class="fas fa-plus"></i> Adicionar Item
            </button>
        </div>

        <!-- Preview Section -->
        <div style="background: rgba(0,0,0,0.2); padding: 24px; border-radius: var(--radius-md); margin-top: 24px; border: 1px solid rgba(255,255,255,0.05);">
            <h3 style="margin-bottom: 16px; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted);">Resumo</h3>
            
            <div id="previewItems" style="margin-bottom: 16px; font-size: 0.9rem; color: var(--text-muted);"></div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; font-size: 1.1rem;">
                <span>Subtotal:</span>
                <span>R$ <span id="previewTotal">0,00</span></span>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <label style="font-size: 0.9rem;">Desconto (%):</label>
                    <input type="number" id="discountPercent" placeholder="0" style="width: 80px; padding: 8px;">
                </div>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 1.5rem; font-weight: bold; color: var(--accent-gold);">
                <span>Total Final:</span>
                <span>R$ <span id="previewTotalAfter">0,00</span></span>
            </div>
        </div>

        <div class="form-group" style="margin-top: 24px;">
            <label>Observações</label>
            <textarea id="observacao" rows="3" placeholder="Notas adicionais..."></textarea>
        </div>

        <div style="text-align:right; margin-top:32px">
            <button type="submit" class="btn btn-primary" style="padding: 16px 32px; font-size: 1.1rem;">
                <i class="fas fa-check"></i> Finalizar Venda
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Global state
    let produtos = [];
    let clientes = [];
    let selectedCliente = null;

    function showAlert(message, success=true) {
        const box = document.getElementById('alertBox');
        box.innerHTML = `<div style="padding: 12px; border-radius: var(--radius-sm); background: ${success ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)'}; color: ${success ? '#10b981' : '#ef4444'}; border: 1px solid ${success ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)'}; margin-bottom: 20px;">${message}</div>`;
        setTimeout(() => box.innerHTML = '', 6000);
    }

    async function loadProdutos() {
        try {
            const res = await fetch('/api/produtos');
            if (!res.ok) throw new Error('Falha ao carregar produtos');
            produtos = await res.json();
            updateProdutoSelects();
        } catch(err) {
            console.error(err);
            showAlert('Erro ao carregar produtos.', false);
        }
    }

    async function loadClientes() {
        try {
            const res = await fetch('/api/clientes');
            if (!res.ok) throw new Error('Falha ao carregar clientes');
            clientes = await res.json();
        } catch(err) {
            console.error(err);
        }
    }

    function updateProdutoSelects() {
        document.querySelectorAll('.produto-select').forEach(select => {
            const currentVal = select.value;
            select.innerHTML = '<option value="">Selecione um produto...</option>';
            produtos.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id_produto;
                option.textContent = `${p.nome} (Estoque: ${p.quantidade}) - R$ ${Number(p.preco).toFixed(2)}`;
                option.dataset.price = p.preco;
                option.dataset.stock = p.quantidade;
                select.appendChild(option);
            });
            select.value = currentVal;
        });
    }

    function addItemRow() {
        const div = document.createElement('div');
        div.className = 'item-row';
        div.style.cssText = 'display: grid; grid-template-columns: 1fr 100px 40px; gap: 12px; align-items: center;';
        div.innerHTML = `
            <select class="produto-select" required>
                <option value="">Selecione um produto...</option>
            </select>
            <input type="number" class="quantidade-input" min="1" placeholder="Qtd" required>
            <button type="button" class="btn btn-danger btn-remove" onclick="this.closest('.item-row').remove(); updatePreview()" style="padding: 8px;">&times;</button>
        `;
        document.getElementById('itemsList').appendChild(div);
        
        // Populate select
        const select = div.querySelector('.produto-select');
        produtos.forEach(p => {
            const option = document.createElement('option');
            option.value = p.id_produto;
            option.textContent = `${p.nome} (Estoque: ${p.quantidade}) - R$ ${Number(p.preco).toFixed(2)}`;
            option.dataset.price = p.preco;
            option.dataset.stock = p.quantidade;
            select.appendChild(option);
        });

        // Add listeners
        select.addEventListener('change', updatePreview);
        div.querySelector('.quantidade-input').addEventListener('input', updatePreview);
        
        // Show remove buttons if > 1 row
        document.querySelectorAll('.btn-remove').forEach(btn => btn.style.display = 'block');
    }

    function updatePreview() {
        let total = 0;
        const previewDiv = document.getElementById('previewItems');
        previewDiv.innerHTML = '';
        
        document.querySelectorAll('.item-row').forEach(row => {
            const select = row.querySelector('.produto-select');
            const qtdInput = row.querySelector('.quantidade-input');
            const qtd = parseInt(qtdInput.value) || 0;
            
            if (select.value && qtd > 0) {
                const option = select.selectedOptions[0];
                const price = parseFloat(option.dataset.price);
                const sub = price * qtd;
                total += sub;
                
                previewDiv.innerHTML += `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                        <span>${option.text.split(' (')[0]} x${qtd}</span>
                        <span>R$ ${sub.toFixed(2)}</span>
                    </div>
                `;
            }
        });

        document.getElementById('previewTotal').textContent = total.toFixed(2);
        
        const discount = parseFloat(document.getElementById('discountPercent').value) || 0;
        const finalTotal = total * (1 - (discount / 100));
        document.getElementById('previewTotalAfter').textContent = finalTotal.toFixed(2);
    }

    // Cliente Search Logic
    const clienteInput = document.getElementById('clienteNome');
    const clienteList = document.getElementById('clienteList');
    const clienteToggle = document.getElementById('clienteToggle');

    function filterClientes() {
        const term = clienteInput.value.toLowerCase();
        const filtered = clientes.filter(c => c.nome.toLowerCase().includes(term));
        
        clienteList.innerHTML = '';
        if (filtered.length === 0) {
            clienteList.innerHTML = '<div style="padding:8px; color:var(--text-muted)">Nenhum cliente encontrado</div>';
        } else {
            filtered.forEach(c => {
                const div = document.createElement('div');
                div.style.padding = '8px 12px';
                div.style.cursor = 'pointer';
                div.style.borderBottom = '1px solid rgba(255,255,255,0.05)';
                div.onmouseover = () => div.style.background = 'rgba(255,255,255,0.05)';
                div.onmouseout = () => div.style.background = 'transparent';
                div.textContent = c.nome;
                div.onclick = () => selectCliente(c);
                clienteList.appendChild(div);
            });
        }
        clienteList.style.display = 'block';
    }

    function selectCliente(c) {
        selectedCliente = c;
        clienteInput.value = c.nome;
        clienteList.style.display = 'none';
        const details = document.getElementById('clienteDetails');
        details.style.display = 'block';
        details.innerHTML = `<strong>Cliente Selecionado:</strong> ${c.nome} <br> <small>${c.email || ''} - ${c.telefone || ''}</small>`;
    }

    clienteInput.addEventListener('input', filterClientes);
    clienteInput.addEventListener('focus', filterClientes);
    
    clienteToggle.addEventListener('click', () => {
        if (clienteList.style.display === 'none') filterClientes();
        else clienteList.style.display = 'none';
    });

    document.addEventListener('click', (e) => {
        if (!clienteInput.contains(e.target) && !clienteList.contains(e.target) && !clienteToggle.contains(e.target)) {
            clienteList.style.display = 'none';
        }
    });

    // Mode switching
    document.querySelectorAll('input[name="cliente_mode"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            if (e.target.value === 'existing') {
                document.getElementById('clienteExisting').style.display = 'block';
                document.getElementById('clienteManual').style.display = 'none';
            } else {
                document.getElementById('clienteExisting').style.display = 'none';
                document.getElementById('clienteManual').style.display = 'block';
                selectedCliente = null;
                document.getElementById('clienteDetails').style.display = 'none';
                clienteInput.value = '';
            }
        });
    });

    // Discount listener
    document.getElementById('discountPercent').addEventListener('input', updatePreview);

    // Initial listeners for first row
    document.querySelector('.produto-select').addEventListener('change', updatePreview);
    document.querySelector('.quantidade-input').addEventListener('input', updatePreview);
    document.querySelector('.add-item-btn').addEventListener('click', addItemRow);

    // Submit
    document.getElementById('saleForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const mode = document.querySelector('input[name="cliente_mode"]:checked').value;
        let clienteId = null;
        let clienteNome = null;

        if (mode === 'existing') {
            if (!selectedCliente) {
                showAlert('Selecione um cliente da lista ou mude para "Digitar nome"', false);
                return;
            }
            clienteId = selectedCliente.id_cliente;
        } else {
            clienteNome = document.getElementById('clienteManualNome').value.trim();
            if (!clienteNome) {
                showAlert('Digite o nome do cliente', false);
                return;
            }
        }

        const itens = [];
        document.querySelectorAll('.item-row').forEach(row => {
            const prodId = row.querySelector('.produto-select').value;
            const qtd = parseInt(row.querySelector('.quantidade-input').value);
            if (prodId && qtd > 0) {
                itens.push({ id_produto: prodId, quantidade: qtd });
            }
        });

        if (itens.length === 0) {
            showAlert('Adicione pelo menos um produto', false);
            return;
        }

        const obs = document.getElementById('observacao').value;
        const discount = parseFloat(document.getElementById('discountPercent').value) || 0;

        try {
            const res = await fetch('/api/vendas', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    id_cliente: clienteId,
                    cliente_nome_manual: clienteNome,
                    itens: itens,
                    observacao: obs,
                    desconto_percent: discount
                })
            });

            if (res.ok) {
                showAlert('Venda realizada com sucesso!', true);
                document.getElementById('saleForm').reset();
                document.getElementById('itemsList').innerHTML = '';
                addItemRow();
                updatePreview();
                selectedCliente = null;
                document.getElementById('clienteDetails').style.display = 'none';
                loadProdutos(); // Reload stock
            } else {
                const data = await res.json();
                showAlert(data.erro || 'Erro ao realizar venda', false);
            }
        } catch (err) {
            console.error(err);
            showAlert('Erro de conexão', false);
        }
    });

    // Init
    loadProdutos();
    loadClientes();
    </script>
{% endblock %}
