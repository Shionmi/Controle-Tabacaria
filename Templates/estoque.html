{% extends "base.html" %}

{% block title %}Estoque - Tabacaria{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css">
{% endblock %}

{% block content %}
<div class="header">
    <img src="{{ url_for('static', filename='Images/Logo_tabacaria.png') }}" alt="Logo" class="logo">
    <div>
        <h1>Tabacaria - Estoque</h1>
        <p style="color:#999; margin-top:6px;">Visualiza√ß√£o do estoque atual</p>
    </div>
</div>

    <!-- Grid layout for new product + table -->
    <div style="display:grid; grid-template-columns:300px 1fr; gap:20px; align-items:start">
      <!-- New product form -->
      <div class="panel">
        <h2>Novo Produto</h2>
        <form id="newProductForm">
          <div class="form-group">
            <label>Nome *</label>
            <input type="text" id="newName" required>
          </div>
          <div class="form-group">
            <label>Categoria</label>
            <input type="text" id="newCategory">
          </div>
          <div class="form-group">
            <label>Pre√ßo (R$) *</label>
            <input type="number" id="newPrice" step="0.01" required>
          </div>
          <div class="form-group">
            <label>Quantidade Inicial *</label>
            <input type="number" id="newQuantity" required>
          </div>
          <button type="submit" class="btn btn-primary">Cadastrar Produto</button>
        </form>
      </div>

      <!-- Products table -->
      <div class="panel">
        <h2 style="margin-bottom:18px; border-bottom:3px solid var(--accent-1); padding-bottom:8px;">üìã Estoque Atual</h2>
        <div style="overflow-x:auto">
          <table id="tabelaEstoque">
            <thead>
            <tr>
              <th>Nome</th>
              <th>Categoria</th>
              <th>Pre√ßo</th>
              <th>Qtd</th>
              <th>C√≥digo</th>
              <th>Etiqueta</th>
              <th style="width:180px">A√ß√µes</th>
            </tr>
            </thead>
            <tbody id="tabela"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Modal de Edi√ß√£o -->
    <div class="modal" id="editModal">
      <div class="modal-content">
        <h3>Editar Produto</h3>
        <div class="form-group">
          <label>Nome</label>
          <input id="editName" type="text">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Categoria</label>
            <input id="editCategory" type="text">
          </div>
          <div class="form-group">
            <label>Pre√ßo (R$)</label>
            <input id="editPrice" type="number" step="0.01">
          </div>
        </div>
        <div class="form-group">
          <label>Quantidade</label>
          <input id="editQuantity" type="number">
        </div>
        <div class="btn-group">
          <button class="btn-primary" id="saveEditBtn">Salvar</button>
          <button class="btn-secondary" onclick="closeEditModal()">Cancelar</button>
        </div>
      </div>
    </div>
    <!-- Modal de Impress√£o (mesma p√°gina) -->
    <div class="modal" id="printModal">
      <div class="modal-content print-modal-content">
          <div class="print-area" id="printArea">
            <div class="etiqueta">
              <img id="printBarcodeImg" src="" alt="C√≥digo de barras">
              <div id="productName" class="product-name"></div>
            </div>
          </div>
          <div style="text-align:center;margin-top:12px">
            <button class="btn btn-secondary" onclick="closePrintModal()">Fechar</button>
          </div>
      </div>
    </div>
    </div>

    <script src="{{ url_for('static', filename='js/common.js') }}"></script>
    <script>
    async function carregarProdutos(){
      try {
        const res = await fetch('/api/produtos');
        if (!res.ok) throw new Error('Erro ao carregar');
        const produtos = await res.json();
        const tbody = document.getElementById('tabela');
        tbody.innerHTML = '';
        produtos.forEach(p=>{
          tbody.innerHTML += `<tr>
            <td>${p.nome}</td>
            <td>${p.categoria || ''}</td>
            <td>R$ ${Number(p.preco).toFixed(2)}</td>
            <td>${p.quantidade}</td>
            <td>${p.codigo_barras || ''}</td>
            <td>
                <img src="/static/barcodes/${p.codigo_barras}.svg" width="120" alt="etiqueta" onerror="this.style.display='none'"> <br>
                <button class="btn-primary" onclick="imprimirEtiqueta(${p.id_produto})">üñ®Ô∏è Imprimir</button>
            </td>
            <td>
                <button class="btn-primary" onclick="openEditModal(${p.id_produto})">‚úèÔ∏è Editar</button>
                <button class="btn-danger" onclick="deleteProductFromTable(${p.id_produto})">üóëÔ∏è Remover</button>
            </td>
          </tr>`;
        });
      } catch (err) {
        console.error(err);
        const tbody = document.getElementById('tabela');
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#999">Erro ao carregar produtos</td></tr>';
      }
    }

    function openEditModal(id) {
      // busca produto atual
      fetch('/api/produtos')
        .then(r=>r.json())
        .then(list=>{
          const p = list.find(x=>x.id_produto===id);
          if (!p) return alert('Produto n√£o encontrado');
          document.getElementById('editName').value = p.nome || '';
          document.getElementById('editCategory').value = p.categoria || '';
          document.getElementById('editPrice').value = Number(p.preco || 0).toFixed(2);
          document.getElementById('editQuantity').value = p.quantidade || 0;
          document.getElementById('editModal').classList.add('active');
          document.getElementById('saveEditBtn').onclick = () => saveEdit(id);
        })
        .catch(err=>{ console.error(err); alert('Erro ao obter produto'); });
    }

    function closeEditModal(){ document.getElementById('editModal').classList.remove('active'); }
      function closePrintModal(){ document.getElementById('printModal').classList.remove('active'); }

    async function saveEdit(id){
      const nome = document.getElementById('editName').value.trim();
      const categoria = document.getElementById('editCategory').value.trim();
      const preco = parseFloat(document.getElementById('editPrice').value) || 0;
      const quantidade = parseInt(document.getElementById('editQuantity').value) || 0;
      if(!nome){ alert('Nome obrigat√≥rio'); return; }
      try{
        const res = await fetch(`/api/produtos/${id}`, {
          method:'PUT', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({nome, categoria, preco, quantidade})
        });
        if (!res.ok) {
          const data = await res.json().catch(()=>({erro:'erro'}));
          throw new Error(data.erro || 'Falha ao salvar');
        }
        closeEditModal();
        carregarProdutos();
        alert('Produto atualizado');
      } catch (err){ console.error(err); alert('Erro ao atualizar produto'); }
    }

    async function deleteProductFromTable(id){
      if(!confirm('Confirmar remo√ß√£o deste produto?')) return;
      try{
        const res = await fetch(`/api/produtos/${id}`, { method:'DELETE' });
        if (!res.ok) throw new Error('Falha ao remover');
        carregarProdutos();
      } catch(err){ console.error(err); alert('Erro ao remover produto'); }
    }

    carregarProdutos();

  async function imprimirEtiqueta(id) {
    try{
      // Busca produto para obter o nome
      const prodRes = await fetch('/api/produtos');
      if (!prodRes.ok) throw new Error('Erro ao buscar produto');
      const produtos = await prodRes.json();
      const produto = produtos.find(p => p.id_produto === id);
      if (!produto) throw new Error('Produto n√£o encontrado');
      
      // Garante que o SVG exista e recupera caminho
      const res = await fetch(`/api/generate_barcode/${id}`);
      if(!res.ok) throw new Error('N√£o foi poss√≠vel gerar etiqueta');
      const data = await res.json();
      
      const img = document.getElementById('printBarcodeImg');
      img.src = data.path + '?_t=' + Date.now(); // bust cache
      
      // Adiciona o nome do produto
      const nameElement = document.getElementById('productName');
      nameElement.textContent = produto.nome;
      
      const modal = document.getElementById('printModal');
      modal.classList.add('active');

      // Handler after print to close modal
      const after = function(){
        modal.classList.remove('active');
        window.removeEventListener('afterprint', after);
      };
      window.addEventListener('afterprint', after);

      // Aguarda um pouco para garantir renderiza√ß√£o e abre di√°logo de impress√£o
      setTimeout(()=>{
        try{ window.print(); }catch(e){ console.error(e); }
      }, 300);
    }catch(err){ console.error(err); alert('Erro ao preparar etiqueta: '+(err.message||err)); }
  }

    // Recarregar tabela com DataTables
let tabelaDT;

async function carregarProdutos(){
  try {
    const res = await fetch('/api/produtos');
    if (!res.ok) throw new Error('Erro ao carregar');
    const produtos = await res.json();
    const tbody = document.getElementById('tabela');
    tbody.innerHTML = '';

    produtos.forEach(p=>{
      tbody.innerHTML += `<tr>
        <td>${p.nome}</td>
        <td>${p.categoria || ''}</td>
        <td>R$ ${Number(p.preco).toFixed(2)}</td>
        <td>${p.quantidade}</td>
        <td>${p.codigo_barras || ''}</td>
        <td>
            <img src="/static/barcodes/${p.codigo_barras}.svg" width="120" alt="etiqueta" onerror="this.style.display='none'"> <br>
            <button class="btn-primary" onclick="imprimirEtiqueta(${p.id_produto})">üñ®Ô∏è Imprimir</button>
        </td>
        <td>
            <button class="btn-primary" onclick="openEditModal(${p.id_produto})">‚úèÔ∏è Editar</button>
            <button class="btn-danger" onclick="deleteProductFromTable(${p.id_produto})">üóëÔ∏è Remover</button>
        </td>
      </tr>`;
    });

    // Reaplicar DataTable
    if (tabelaDT) {
      tabelaDT.destroy();
    }
    tabelaDT = new DataTable('#tabelaEstoque', {
      language: {
        url: 'https://cdn.datatables.net/plug-ins/1.13.5/i18n/pt-BR.json'
      },
      pageLength: 10,
      ordering: true,
      responsive: true
    });

  } catch (err) {
    console.error(err);
    document.getElementById('tabela').innerHTML = '<tr><td colspan="7">Erro ao carregar produtos</td></tr>';
  }
}

// Handle new product form
document.getElementById('newProductForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const nome = document.getElementById('newName').value.trim();
  const categoria = document.getElementById('newCategory').value.trim();
  const preco = parseFloat(document.getElementById('newPrice').value) || 0;
  const quantidade = parseInt(document.getElementById('newQuantity').value) || 0;

  try {
    const res = await fetch('/api/produtos', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({nome, categoria, preco, quantidade})
    });
    if (!res.ok) {
      const data = await res.json().catch(() => ({}));
      throw new Error(data.erro || 'Falha ao cadastrar');
    }
    // reset form
    e.target.reset();
    carregarProdutos();
    alert('Produto cadastrado com sucesso!');
  } catch(err) {
    console.error(err);
    alert('Erro ao cadastrar produto: ' + (err.message || err));
  }
});

carregarProdutos();
  </script>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsbarcode/3.11.5/JsBarcode.all.min.js"></script>
{% endblock %}
