[33mcommit b9adde343e1ea358d0dca9fdfb141dbab3fe7630[m[33m ([m[1;32mmain[m[33m)[m
Author: Toninho <antonio.faria@sou.fapam.edu.br>
Date:   Thu Nov 6 23:15:20 2025 -0300

    Atualiza√ß√µes de visual

[1mdiff --git a/Iniciar_Sistema.bat b/Iniciar_Sistema.bat[m
[1mnew file mode 100644[m
[1mindex 0000000..6457417[m
[1m--- /dev/null[m
[1m+++ b/Iniciar_Sistema.bat[m
[36m@@ -0,0 +1,4 @@[m
[32m+[m[32m@echo off[m
[32m+[m[32mecho Iniciando Sistema de Controle de Tabacaria...[m
[32m+[m[32mstart /min powershell -ExecutionPolicy Bypass -WindowStyle Hidden -File "%~dp0scripts\start_sistema.ps1"[m
[32m+[m[32mexit[m
\ No newline at end of file[m
[1mdiff --git a/Instalar_Sistema.bat b/Instalar_Sistema.bat[m
[1mnew file mode 100644[m
[1mindex 0000000..7e08f69[m
[1m--- /dev/null[m
[1m+++ b/Instalar_Sistema.bat[m
[36m@@ -0,0 +1,36 @@[m
[32m+[m[32m@echo off[m
[32m+[m[32mecho ================================================[m
[32m+[m[32mecho    Instalacao do Sistema Controle de Tabacaria[m
[32m+[m[32mecho ================================================[m
[32m+[m[32mecho.[m
[32m+[m
[32m+[m[32m:: Verificar se est√° rodando como administrador[m
[32m+[m[32mnet session >nul 2>&1[m
[32m+[m[32mif %errorLevel% == 0 ([m
[32m+[m[32m    echo Executando como administrador... OK[m
[32m+[m[32m) else ([m
[32m+[m[32m    echo Por favor, execute este instalador como administrador![m
[32m+[m[32m    echo Clique com o botao direito e selecione "Executar como administrador"[m
[32m+[m[32m    echo.[m
[32m+[m[32m    pause[m
[32m+[m[32m    exit /b 1[m
[32m+[m[32m)[m
[32m+[m
[32m+[m[32m:: Permitir execu√ß√£o de scripts PowerShell[m
[32m+[m[32mecho Configurando permissoes do PowerShell...[m
[32m+[m[32mpowershell -Command "Set-ExecutionPolicy Bypass -Scope Process -Force"[m
[32m+[m
[32m+[m[32m:: Executar script de instala√ß√£o[m
[32m+[m[32mecho Iniciando instalacao...[m
[32m+[m[32mpowershell -File "%~dp0scripts\setup_client.ps1" -StartApp[m
[32m+[m
[32m+[m[32m:: Se ocorrer algum erro, mostrar e esperar[m
[32m+[m[32mif %errorLevel% neq 0 ([m
[32m+[m[32m    echo.[m
[32m+[m[32m    echo ERRO: A instalacao nao foi concluida corretamente.[m
[32m+[m[32m    echo Por favor, entre em contato com o suporte.[m
[32m+[m[32m    pause[m
[32m+[m[32m    exit /b 1[m
[32m+[m[32m)[m
[32m+[m
[32m+[m[32mexit /b 0[m
\ No newline at end of file[m
[1mdiff --git a/README.md b/README.md[m
[1mnew file mode 100644[m
[1mindex 0000000..3abe99f[m
[1m--- /dev/null[m
[1m+++ b/README.md[m
[36m@@ -0,0 +1,107 @@[m
[32m+[m[32m# Controle-Tabacaria[m
[32m+[m[32mSistema de controle de estoque para tabacaria[m
[32m+[m[32mEste reposit√≥rio cont√©m um sistema simples em Flask para gerenciar produtos, gerar etiquetas (c√≥digos de barras) e registrar movimenta√ß√µes (entradas/sa√≠das).[m
[32m+[m
[32m+[m[32mEste arquivo descreve passo-a-passo o que voc√™ precisa instalar e configurar no computador da cliente (Windows) para rodar a aplica√ß√£o localmente.[m
[32m+[m
[32m+[m[32m## Requisitos (Windows)[m
[32m+[m[32m- Python 3.10 ou 3.11 instalado (64-bit recomendado). Baixe em https://www.python.org/[m
[32m+[m[32m- Git (opcional, para clonar o reposit√≥rio)[m
[32m+[m[32m- Acesso √† internet para baixar depend√™ncias e bibliotecas front-end (cdn)[m
[32m+[m
[32m+[m[32m## Passos de instala√ß√£o[m
[32m+[m
[32m+[m[32m1. Abra PowerShell como o usu√°rio que ir√° rodar a aplica√ß√£o.[m
[32m+[m
[32m+[m[32m2. Navegue at√© a pasta do projeto:[m
[32m+[m
[32m+[m[32m```powershell[m
[32m+[m[32mcd[m[41m [m
[32m+[m[32m```[m
[32m+[m
[32m+[m[32m3. Crie e ative um ambiente virtual Python (recomendado):[m
[32m+[m
[32m+[m[32m```powershell[m
[32m+[m[32mpython -m venv .venv[m
[32m+[m[32m.\.venv\Scripts\Activate.ps1[m
[32m+[m[32m```[m
[32m+[m
[32m+[m[32m4. Instale depend√™ncias:[m
[32m+[m
[32m+[m[32m```powershell[m
[32m+[m[32mpip install -r requirements.txt[m
[32m+[m[32m```[m
[32m+[m
[32m+[m[32m5. Criar banco de dados SQLite usando o schema fornecido (`schema.sql`). Voc√™ pode usar sqlite3 (se tiver) ou um pequeno script Python:[m
[32m+[m
[32m+[m[32mPowerShell + sqlite3 (se instalado):[m
[32m+[m[32m```powershell[m
[32m+[m[32msqlite3 estoque_tabacaria.db < schema.sql[m
[32m+[m[32m```[m
[32m+[m
[32m+[m[32mOu usando Python (sem sqlite3 CLI):[m
[32m+[m[32m```powershell[m
[32m+[m[32mpython - <<'PY'[m
[32m+[m[32mimport sqlite3[m
[32m+[m[32mprint('Criando DB...')[m
[32m+[m[32mconn = sqlite3.connect('estoque_tabacaria.db')[m
[32m+[m[32mwith open('schema.sql','r',encoding='utf-8') as f:[m
[32m+[m	[32mconn.executescript(f.read())[m
[32m+[m[32mconn.commit(); conn.close()[m
[32m+[m[32mprint('Feito')[m
[32m+[m[32mPY[m
[32m+[m[32m```[m
[32m+[m
[32m+[m[32m6. Crie a pasta para c√≥digos de barras (se ainda n√£o existir) e d√™ permiss√£o de escrita:[m
[32m+[m
[32m+[m[32m```powershell[m
[32m+[m[32mmkdir -Force static\barcodes[m
[32m+[m[32m# No Windows a permiss√£o normalmente j√° √© suficiente, mas verifique se o usu√°rio do processo pode escrever nessa pasta.[m
[32m+[m[32m```[m
[32m+[m
[32m+[m[32m7. Coloque o logo da loja em `static/Images/Logo_tabacaria.png`. Se o logo estiver em `Templates/Logo_tabacaria.png` (como em alguns reposit√≥rios), h√° um script de utilidade em `scripts/move_logo.py` que copia o arquivo para `static/Images`.[m
[32m+[m
[32m+[m[32mExecutar script (opcional):[m
[32m+[m[32m```powershell[m
[32m+[m[32mpython .\scripts\move_logo.py[m
[32m+[m[32m```[m
[32m+[m
[32m+[m[32m8. Rodar a aplica√ß√£o (desenvolvimento):[m
[32m+[m
[32m+[m[32m```powershell[m
[32m+[m[32m# Ative o venv se necess√°rio[m
[32m+[m[32mpython app.py[m
[32m+[m[32m```[m
[32m+[m
[32m+[m[32mAbra no navegador: http://127.0.0.1:5000[m
[32m+[m
[32m+[m[32m## Notas sobre impress√£o de etiquetas[m
[32m+[m[32m- A aplica√ß√£o gera imagens PNG do c√≥digo de barras em `static/barcodes/` no momento em que um produto √© registrado. A p√°gina de impress√£o mostra apenas a imagem do c√≥digo de barras (sem o nome), e a regra `@media print` foi configurada para imprimir somente a etiqueta no tamanho aproximado de 50mm x 30mm.[m
[32m+[m[32m- Se o di√°logo de impress√£o n√£o apresentar o tamanho correto, verifique as configura√ß√µes da impressora (escala/pixels por polegada). Ajustes finos podem ser feitos no CSS (`static/style.css`) na classe `.print-area`.[m
[32m+[m
[32m+[m[32m## Depend√™ncias principais[m
[32m+[m[32m- Flask ‚Äî servidor web[m
[32m+[m[32m- python-barcode ‚Äî gera√ß√£o de c√≥digos de barras (gera PNG quando Pillow estiver instalado)[m
[32m+[m[32m- Pillow ‚Äî suporte a imagens[m
[32m+[m[32m- reportlab ‚Äî gera√ß√£o de PDFs (opcional, usado por rota que gera PDF)[m
[32m+[m
[32m+[m[32m## Produ√ß√£o / Deploy[m
[32m+[m[32m- Para produ√ß√£o em Windows, √© comum usar o servidor Waitress ou empacotar como servi√ßo Windows. Exemplo com Waitress:[m
[32m+[m
[32m+[m[32m```powershell[m
[32m+[m[32mpip install waitress[m
[32m+[m[32mpython -m waitress --listen=0.0.0.0:8000 app:app[m
[32m+[m[32m```[m
[32m+[m
[32m+[m[32m## Troubleshooting r√°pido[m
[32m+[m[32m- Erro ao gerar PNG do barcode: verifique se `Pillow` est√° instalado (pip install Pillow) e se a pasta `static/barcodes` √© grav√°vel.[m
[32m+[m[32m- Erro 404 no `/movimentacoes`: verifique se reiniciou o servidor ap√≥s mudan√ßas no c√≥digo.[m
[32m+[m[32m- Depend√™ncias desatualizadas: rode `pip install -U -r requirements.txt` para atualizar.[m
[32m+[m
[32m+[m[32m## O que eu (desenvolvedor) j√° deixei preparado[m
[32m+[m[32m- `requirements.txt` com depend√™ncias.[m
[32m+[m[32m- `scripts/move_logo.py` para mover o logo entre pastas (se necess√°rio).[m
[32m+[m[32m- `schema.sql` com as tabelas `produtos` e `movimentacoes`.[m
[32m+[m[32m- P√°ginas: `/` (index), `/registrar`, `/estoque`, `/venda`, `/movimentacoes`.[m
[32m+[m
[32m+[m[32mSe quiser, eu posso gerar um instalador mais detalhado (PowerShell script) que automatize os passos 2‚Äì8 para a m√°quina da cliente.[m
[1mdiff --git a/Templates/base.html b/Templates/base.html[m
[1mnew file mode 100644[m
[1mindex 0000000..7d55882[m
[1m--- /dev/null[m
[1m+++ b/Templates/base.html[m
[36m@@ -0,0 +1,82 @@[m
[32m+[m[32m<!DOCTYPE html>[m
[32m+[m[32m<html lang="pt-BR">[m
[32m+[m[32m<head>[m
[32m+[m[32m    <meta charset="UTF-8">[m
[32m+[m[32m    <meta name="viewport" content="width=device-width, initial-scale=1.0">[m
[32m+[m[32m    <title>{% block title %}Estoque Tabacaria{% endblock %}</title>[m
[32m+[m[32m    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">[m
[32m+[m[32m    <!-- Inter font for modern/clean UI; Georgia fallback used in CSS font-family -->[m
[32m+[m[32m    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">[m
[32m+[m[32m    <link rel="icon" href="{{ url_for('static', filename='Images/favicon.ico') }}" type="image/x-icon">[m
[32m+[m[32m    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">[m
[32m+[m[32m    {% block extra_css %}{% endblock %}[m
[32m+[m[32m</head>[m
[32m+[m[32m<body>[m
[32m+[m[32m    <!-- Side Drawer Navigation -->[m
[32m+[m[32m    <nav class="side-drawer">[m
[32m+[m[32m        <div class="drawer-handle"></div>[m
[32m+[m[41m        [m
[32m+[m[32m        <div class="drawer-logo">[m
[32m+[m[32m            <img src="{{ url_for('static', filename='Images/Logo_tabacaria.png') }}" alt="Logo">[m
[32m+[m[32m        </div>[m
[32m+[m
[32m+[m[32m        <a href="/" class="nav-item {% if request.endpoint == 'index' %}active{% endif %}">[m
[32m+[m[32m            <i class="fas fa-home"></i> In√≠cio[m
[32m+[m[32m        </a>[m
[32m+[m[41m        [m
[32m+[m[32m        <a href="/estoque" class="nav-item {% if request.endpoint == 'estoque' %}active{% endif %}">[m
[32m+[m[32m            <i class="fas fa-box-open"></i> Estoque[m
[32m+[m[32m        </a>[m
[32m+[m[41m        [m
[32m+[m[32m        <a href="/venda" class="nav-item {% if request.endpoint == 'venda' %}active{% endif %}">[m
[32m+[m[32m            <i class="fas fa-shopping-cart"></i> Nova Venda[m
[32m+[m[32m        </a>[m
[32m+[m[41m        [m
[32m+[m[32m        <a href="/movimentacoes" class="nav-item {% if request.endpoint == 'movimentacoes_page' %}active{% endif %}">[m
[32m+[m[32m            <i class="fas fa-exchange-alt"></i> Movimenta√ß√µes[m
[32m+[m[32m        </a>[m
[32m+[m[41m        [m
[32m+[m[32m        <div class="nav-group">[m
[32m+[m[32m            <span class="nav-group-title">Cadastros</span>[m
[32m+[m[32m            <a href="/registrar" class="nav-item {% if request.endpoint == 'registrar' %}active{% endif %}">[m
[32m+[m[32m                <i class="fas fa-box-open"></i> Cadastrar Produto[m
[32m+[m[32m            </a>[m
[32m+[m[32m            <a href="/clientes/novo" class="nav-item {% if request.endpoint == 'novo_cliente' %}active{% endif %}">[m
[32m+[m[32m                <i class="fas fa-user-plus"></i> Cadastrar Cliente[m
[32m+[m[32m            </a>[m
[32m+[m[32m        </div>[m
[32m+[m
[32m+[m[32m        <div class="nav-group">[m
[32m+[m[32m            <span class="nav-group-title">Consultas</span>[m
[32m+[m[32m            <a href="/clientes" class="nav-item {% if request.endpoint == 'listar_clientes' %}active{% endif %}">[m
[32m+[m[32m                <i class="fas fa-users"></i> Clientes[m
[32m+[m[32m            </a>[m
[32m+[m[32m        </div>[m
[32m+[m[32m    </nav>[m
[32m+[m
[32m+[m[32m    <div class="container">[m
[32m+[m[32m        {% block content %}{% endblock %}[m
[32m+[m[32m    </div>[m
[32m+[m
[32m+[m[32m    {% block extra_js %}{% endblock %}[m
[32m+[m[41m    [m
[32m+[m[32m    <script>[m
[32m+[m[32m        // Add touch support for mobile[m
[32m+[m[32m        document.addEventListener('DOMContentLoaded', function() {[m
[32m+[m[32m            const drawer = document.querySelector('.side-drawer');[m
[32m+[m[32m            const handle = document.querySelector('.drawer-handle');[m
[32m+[m[41m            [m
[32m+[m[32m            handle.addEventListener('click', () => {[m
[32m+[m[32m                drawer.classList.toggle('active');[m
[32m+[m[32m            });[m
[32m+[m[41m            [m
[32m+[m[32m            // Close drawer when clicking outside[m
[32m+[m[32m            document.addEventListener('click', (e) => {[m
[32m+[m[32m                if (!drawer.contains(e.target) && drawer.classList.contains('active')) {[m
[32m+[m[32m                    drawer.classList.remove('active');[m
[32m+[m[32m                }[m
[32m+[m[32m            });[m
[32m+[m[32m        });[m
[32m+[m[32m    </script>[m
[32m+[m[32m</body>[m
[32m+[m[32m</html>[m
\ No newline at end of file[m
[1mdiff --git a/Templates/clientes.html b/Templates/clientes.html[m
[1mnew file mode 100644[m
[1mindex 0000000..34b1a16[m
[1m--- /dev/null[m
[1m+++ b/Templates/clientes.html[m
[36m@@ -0,0 +1,512 @@[m
[32m+[m[32m{% extends "base.html" %}[m
[32m+[m
[32m+[m[32m{% block title %}Clientes - Tabacaria{% endblock %}[m
[32m+[m
[32m+[m[32m{% block content %}[m
[32m+[m[32m<div class="header">[m
[32m+[m[32m    <img src="{{ url_for('static', filename='Images/Logo_tabacaria.png') }}" alt="Logo" class="logo">[m
[32m+[m[32m    <div>[m
[32m+[m[32m        <h1 style="font-size:20px;">Gerenciamento de Clientes</h1>[m
[32m+[m[32m        <p style="color:#999;margin-top:6px">Lista de clientes cadastrados</p>[m
[32m+[m[32m    </div>[m
[32m+[m[32m</div>[m
[32m+[m
[32m+[m[32m<div class="panel">[m
[32m+[m[32m    <div class="action-bar">[m
[32m+[m[32m    <input type="text" id="busca" placeholder="Buscar cliente..." class="search-input">[m
[32m+[m[32m    <button type="button" class="btn btn-primary" onclick="window.location.href='/registrar_cliente'">Novo Cliente</button>[m
[32m+[m[32m    </div>[m
[32m+[m
[32m+[m[32m    <div class="table-container">[m
[32m+[m[32m        <table>[m
[32m+[m[32m            <thead>[m
[32m+[m[32m                <tr>[m
[32m+[m[32m                    <th>Nome</th>[m
[32m+[m[32m                    <th>CPF</th>[m
[32m+[m[32m                    <th>Telefone</th>[m
[32m+[m[32m                    <th>Email</th>[m
[32m+[m[32m                    <th>Cidade</th>[m
[32m+[m[32m                    <th>Estado</th>[m
[32m+[m[32m                    <th>√öltima Compra</th>[m
[32m+[m[32m                    <th>A√ß√µes</th>[m
[32m+[m[32m                </tr>[m
[32m+[m[32m            </thead>[m
[32m+[m[32m                    <tbody id="lista-clientes">[m
[32m+[m[32m                    </tbody>[m
[32m+[m[32m                </table>[m
[32m+[m[32m            </div>[m
[32m+[m[32m        </div>[m
[32m+[m[41m        [m
[32m+[m[32m        <script>[m
[32m+[m[32m                async function carregarClientes() {[m
[32m+[m[32m            try {[m
[32m+[m[32m                const res = await fetch('/api/clientes');[m
[32m+[m[32m                if (!res.ok) throw new Error('Erro ao carregar clientes');[m
[32m+[m[32m                const clientes = await res.json();[m
[32m+[m[41m        [m
[32m+[m[32m                const tbody = document.getElementById('lista-clientes');[m
[32m+[m[32m                tbody.innerHTML = '';[m
[32m+[m[41m        [m
[32m+[m[32m                clientes.forEach(c => {[m
[32m+[m[32m                    tbody.innerHTML += `[m
[32m+[m[32m                        <tr>[m
[32m+[m[32m                            <td>${c.nome}</td>[m
[32m+[m[32m                            <td>${c.cpf || '-'}</td>[m
[32m+[m[32m                            <td>${c.telefone}</td>[m
[32m+[m[32m                            <td>${c.email || '-'}</td>[m
[32m+[m[32m                            <td>${c.cidade || '-'}</td>[m
[32m+[m[32m                            <td>${c.estado || '-'}</td>[m
[32m+[m[32m                            <td>${c.ultima_compra || '-'}</td>[m
[32m+[m[32m                            <td>[m
[32m+[m[32m                                <button class="btn btn-primary" onclick="editarCliente(${c.id_cliente})">‚úèÔ∏è Editar</button>[m
[32m+[m[32m                                <button class="btn btn-danger" onclick="excluirCliente(${c.id_cliente})">üóëÔ∏è Excluir</button>[m
[32m+[m[32m                            </td>[m
[32m+[m[32m                        </tr>[m
[32m+[m[32m                    `;[m
[32m+[m[32m                });[m
[32m+[m[41m        [m
[32m+[m[32m                if (clientes.length === 0) {[m
[32m+[m[32m                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center">Nenhum cliente cadastrado</td></tr>';[m
[32m+[m[32m                }[m
[32m+[m[41m        [m
[32m+[m[32m            } catch (err) {[m
[32m+[m[32m                console.error(err);[m
[32m+[m[32m                document.getElementById('lista-clientes').innerHTML =[m[41m [m
[32m+[m[32m                    '<tr><td colspan="8" style="text-align:center;color:red">Erro ao carregar clientes</td></tr>';[m
[32m+[m[32m            }[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        // Editar cliente[m
[32m+[m[32m        async function editarCliente(id) {[m
[32m+[m[32m            try {[m
[32m+[m[32m                const res = await fetch(`/api/clientes/${id}`);[m
[32m+[m[32m                if (!res.ok) throw new Error('Cliente n√£o encontrado');[m
[32m+[m[41m        [m
[32m+[m[32m                const cliente = await res.json();[m
[32m+[m[41m        [m
[32m+[m[32m                document.getElementById('edit-id').value = cliente.id_cliente;[m
[32m+[m[32m                document.getElementById('edit-nome').value = cliente.nome || '';[m
[32m+[m[32m                document.getElementById('edit-cpf').value = cliente.cpf || '';[m
[32m+[m[32m                document.getElementById('edit-telefone').value = cliente.telefone || '';[m
[32m+[m[32m                document.getElementById('edit-email').value = cliente.email || '';[m
[32m+[m[32m                document.getElementById('edit-endereco').value = cliente.endereco || '';[m
[32m+[m[32m                document.getElementById('edit-cidade').value = cliente.cidade || '';[m
[32m+[m[32m                document.getElementById('edit-estado').value = cliente.estado || '';[m
[32m+[m[32m                document.getElementById('edit-observacoes').value = cliente.observacoes || '';[m
[32m+[m[41m        [m
[32m+[m[32m                document.getElementById('modal-edicao').classList.add('active');[m
[32m+[m[32m            } catch (err) {[m
[32m+[m[32m                console.error(err);[m
[32m+[m[32m                alert('Erro ao carregar dados do cliente');[m
[32m+[m[32m            }[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        // Excluir cliente[m
[32m+[m[32m        async function excluirCliente(id) {[m
[32m+[m[32m            if (!confirm('Tem certeza que deseja excluir este cliente?')) return;[m
[32m+[m[41m    [m
[32m+[m[32m            try {[m
[32m+[m[32m                const res = await fetch(`/api/clientes/${id}`, { method: 'DELETE' });[m
[32m+[m[32m                if (!res.ok) throw new Error('Erro ao excluir cliente');[m
[32m+[m[41m        [m
[32m+[m[32m                alert('Cliente exclu√≠do com sucesso!');[m
[32m+[m[32m                carregarClientes();[m
[32m+[m[32m            } catch (err) {[m
[32m+[m[32m                console.error(err);[m
[32m+[m[32m                alert('Erro ao excluir cliente');[m
[32m+[m[32m            }[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        // Fechar modal[m
[32m+[m[32m        function fecharModal() {[m
[32m+[m[32m            document.getElementById('modal-edicao').classList.remove('active');[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        // Handle edi√ß√£o[m
[32m+[m[32m        document.getElementById('form-editar').addEventListener('submit', async (e) => {[m
[32m+[m[32m            e.preventDefault();[m
[32m+[m[41m    [m
[32m+[m[32m            const id = document.getElementById('edit-id').value;[m
[32m+[m[32m            const cliente = {[m
[32m+[m[32m                nome: document.getElementById('edit-nome').value.trim(),[m
[32m+[m[32m                cpf: document.getElementById('edit-cpf').value.trim(),[m
[32m+[m[32m                telefone: document.getElementById('edit-telefone').value.trim(),[m
[32m+[m[32m                email: document.getElementById('edit-email').value.trim(),[m
[32m+[m[32m                endereco: document.getElementById('edit-endereco').value.trim(),[m
[32m+[m[32m                cidade: document.getElementById('edit-cidade').value.trim(),[m
[32m+[m[32m                estado: document.getElementById('edit-estado').value.trim().toUpperCase(),[m
[32m+[m[32m                observacoes: document.getElementById('edit-observacoes').value.trim()[m
[32m+[m[32m            };[m
[32m+[m[41m    [m
[32m+[m[32m            try {[m
[32m+[m[32m                const res = await fetch(`/api/clientes/${id}`, {[m
[32m+[m[32m                    method: 'PUT',[m
[32m+[m[32m                    headers: { 'Content-Type': 'application/json' },[m
[32m+[m[32m                    body: JSON.stringify(cliente)[m
[32m+[m[32m                });[m
[32m+[m[41m        [m
[32m+[m[32m                const data = await res.json();[m
[32m+[m[41m        [m
[32m+[m[32m                if (res.ok) {[m
[32m+[m[32m                    alert('Cliente atualizado com sucesso!');[m
[32m+[m[32m                    fecharModal();[m
[32m+[m[32m                    carregarClientes();[m
[32m+[m[32m                } else {[m
[32m+[m[32m                    alert(data.erro || 'Erro ao atualizar cliente');[m
[32m+[m[32m                }[m
[32m+[m[32m            } catch (err) {[m
[32m+[m[32m                console.error(err);[m
[32m+[m[32m                alert('Erro ao atualizar cliente');[m
[32m+[m[32m            }[m
[32m+[m[32m        });[m
[32m+[m
[32m+[m[32m        // Busca[m
[32m+[m[32m        document.getElementById('busca').addEventListener('input', (e) => {[m
[32m+[m[32m            const busca = e.target.value.toLowerCase();[m
[32m+[m[32m            const linhas = document.querySelectorAll('#lista-clientes tr');[m
[32m+[m[41m    [m
[32m+[m[32m            linhas.forEach(linha => {[m
[32m+[m[32m                const texto = linha.textContent.toLowerCase();[m
[32m+[m[32m                linha.style.display = texto.includes(busca) ? '' : 'none';[m
[32m+[m[32m            });[m
[32m+[m[32m        });[m
[32m+[m[32m</script>[m
[32m+[m
[32m+[m[32m                <!-- Preenchido via JavaScript -->[m
[32m+[m[32m            </tbody>[m
[32m+[m[32m        </table>[m
[32m+[m[32m    </div>[m
[32m+[m[32m</div>[m
[32m+[m
[32m+[m[32m<!-- Modal de Edi√ß√£o -->[m
[32m+[m[32m<div id="modal-edicao" class="modal">[m
[32m+[m[32m    <div class="modal-content">[m
[32m+[m[32m        <h2>Editar Cliente</h2>[m
[32m+[m[32m        <form id="form-editar">[m
[32m+[m[32m            <input type="hidden" id="edit-id">[m
[32m+[m[41m            [m
[32m+[m[32m            <div class="form-row">[m
[32m+[m[32m                <div class="form-group">[m
[32m+[m[32m                    <label for="edit-nome">Nome</label>[m
[32m+[m[32m                    <input id="edit-nome" required>[m
[32m+[m[32m                </div>[m
[32m+[m[32m                <div class="form-group">[m
[32m+[m[32m                    <label for="edit-cpf">CPF</label>[m
[32m+[m[32m                    <input id="edit-cpf">[m
[32m+[m[32m                </div>[m
[32m+[m[32m            </div>[m
[32m+[m
[32m+[m[32m            <div class="form-row">[m
[32m+[m[32m                <div class="form-group">[m
[32m+[m[32m                    <label for="edit-telefone">Telefone</label>[m
[32m+[m[32m                    <input id="edit-telefone" required type="tel">[m
[32m+[m[32m                </div>[m
[32m+[m[32m                <div class="form-group">[m
[32m+[m[32m                    <label for="edit-email">E-mail</label>[m
[32m+[m[32m                    <input id="edit-email" type="email">[m
[32m+[m[32m                </div>[m
[32m+[m[32m            </div>[m
[32m+[m
[32m+[m[32m            <div class="form-group">[m
[32m+[m[32m                <label for="edit-endereco">Endere√ßo</label>[m
[32m+[m[32m                <input id="edit-endereco">[m
[32m+[m[32m            </div>[m
[32m+[m
[32m+[m[32m            <div class="form-row">[m
[32m+[m[32m                <div class="form-group">[m
[32m+[m[32m                    <label for="edit-cidade">Cidade</label>[m
[32m+[m[32m                    <input id="edit-cidade">[m
[32m+[m[32m                </div>[m
[32m+[m[32m                <div class="form-group">[m
[32m+[m[32m                    <label for="edit-estado">Estado</label>[m
[32m+[m[32m                    <input id="edit-estado" maxlength="2" style="text-transform: uppercase;">[m
[32m+[m[32m                </div>[m
[32m+[m[32m            </div>[m
[32m+[m
[32m+[m[32m            <div class="form-group">[m
[32m+[m[32m                <label for="edit-observacoes">Observa√ß√µes</label>[m
[32m+[m[32m                <textarea id="edit-observacoes" rows="3"></textarea>[m
[32m+[m[32m            </div>[m
[32m+[m
[32m+[m[32m            <div class="btn-group">[m
[32m+[m[32m                <button type="submit" class="btn btn-primary">Salvar Altera√ß√µes</button>[m
[32m+[m[32m                <button type="button" class="btn btn-secondary" onclick="fecharModal()">Cancelar</button>[m
[32m+[m[32m            </div>[m
[32m+[m[32m        </form>[m
[32m+[m[32m    </div>[m
[32m+[m[32m</div>[m
[32m+[m
[32m+[m[32m<script src="{{ url_for('static', filename='js/common.js') }}"></script>[m
[32m+[m[32m<script>[m
[32m+[m[32mconst API = '/api/clientes';[m
[32m+[m[32mlet clientes = [];[m
[32m+[m
[32m+[m[32m// Formatar datas para exibi√ß√£o[m
[32m+[m[32mfunction formatarData(data) {[m
[32m+[m[32m    if (!data) return '-';[m
[32m+[m[32m    return new Date(data).toLocaleDateString('pt-BR');[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m// Carregar lista de clientes[m
[32m+[m[32masync function carregarClientes() {[m
[32m+[m[32m    try {[m
[32m+[m[32m        const response = await fetch(API);[m
[32m+[m[32m        clientes = await response.json();[m
[32m+[m[32m        renderizarClientes();[m
[32m+[m[32m    } catch (err) {[m
[32m+[m[32m        showMessage('Erro ao carregar clientes: ' + err.message, 'error');[m
[32m+[m[32m    }[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m// Renderizar lista de clientes[m
[32m+[m[32mfunction renderizarClientes() {[m
[32m+[m[32m    const tbody = document.getElementById('lista-clientes');[m
[32m+[m[32m    const busca = document.getElementById('busca').value.toLowerCase();[m
[32m+[m[41m    [m
[32m+[m[32m    const clientesFiltrados = clientes.filter(cliente =>[m[41m [m
[32m+[m[32m        cliente.nome.toLowerCase().includes(busca) ||[m
[32m+[m[32m        (cliente.cpf && cliente.cpf.includes(busca)) ||[m
[32m+[m[32m        (cliente.telefone && cliente.telefone.includes(busca))[m
[32m+[m[32m    );[m
[32m+[m
[32m+[m[32m    tbody.innerHTML = clientesFiltrados.map(cliente => `[m
[32m+[m[32m        <tr>[m
[32m+[m[32m            <td>${cliente.nome}</td>[m
[32m+[m[32m            <td>${cliente.cpf || '-'}</td>[m
[32m+[m[32m            <td>${cliente.telefone || '-'}</td>[m
[32m+[m[32m            <td>${cliente.email || '-'}</td>[m
[32m+[m[32m            <td>${cliente.cidade || '-'}</td>[m
[32m+[m[32m            <td>${cliente.estado || '-'}</td>[m
[32m+[m[32m            <td>${formatarData(cliente.ultima_compra)}</td>[m
[32m+[m[32m            <td>[m
[32m+[m[32m                <button onclick="editarCliente(${cliente.id_cliente})" class="btn-icon" title="Editar">[m
[32m+[m[32m                    <i class="fas fa-edit"></i>[m
[32m+[m[32m                </button>[m
[32m+[m[32m                <button onclick="excluirCliente(${cliente.id_cliente})" class="btn-icon" title="Excluir">[m
[32m+[m[32m                    <i class="fas fa-trash"></i>[m
[32m+[m[32m                </button>[m
[32m+[m[32m            </td>[m
[32m+[m[32m        </tr>[m
[32m+[m[32m    `).join('');[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m// Busca din√¢mica[m
[32m+[m[32mdocument.getElementById('busca').addEventListener('input', renderizarClientes);[m
[32m+[m
[32m+[m[32m// Formatadores de input[m
[32m+[m[32mfunction formatarCPF(e) {[m
[32m+[m[32m    let value = e.target.value.replace(/\D/g, '');[m
[32m+[m[32m    if (value.length > 11) value = value.slice(0, 11);[m
[32m+[m[32m    if (value.length > 9) value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');[m
[32m+[m[32m    else if (value.length > 6) value = value.replace(/(\d{3})(\d{3})(\d{3})/, '$1.$2.$3');[m
[32m+[m[32m    else if (value.length > 3) value = value.replace(/(\d{3})(\d{3})/, '$1.$2');[m
[32m+[m[32m    e.target.value = value;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction formatarTelefone(e) {[m
[32m+[m[32m    let value = e.target.value.replace(/\D/g, '');[m
[32m+[m[32m    if (value.length > 11) value = value.slice(0, 11);[m
[32m+[m[32m    if (value.length > 10) value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');[m
[32m+[m[32m    else if (value.length > 6) value = value.replace(/(\d{2})(\d{4})(\d+)/, '($1) $2-$3');[m
[32m+[m[32m    else if (value.length > 2) value = value.replace(/(\d{2})(\d+)/, '($1) $2');[m
[32m+[m[32m    e.target.value = value;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mdocument.getElementById('edit-cpf').addEventListener('input', formatarCPF);[m
[32m+[m[32mdocument.getElementById('edit-telefone').addEventListener('input', formatarTelefone);[m
[32m+[m
[32m+[m[32m// Fun√ß√µes do modal[m
[32m+[m[32mfunction abrirModal() {[m
[32m+[m[32m    document.getElementById('modal-edicao').style.display = 'block';[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction fecharModal() {[m
[32m+[m[32m    document.getElementById('modal-edicao').style.display = 'none';[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m// Editar cliente[m
[32m+[m[32masync function editarCliente(id) {[m
[32m+[m[32m    try {[m
[32m+[m[32m        const response = await fetch(`${API}/${id}`);[m
[32m+[m[32m        const cliente = await response.json();[m
[32m+[m
[32m+[m[32m        document.getElementById('edit-id').value = cliente.id_cliente;[m
[32m+[m[32m        document.getElementById('edit-nome').value = cliente.nome;[m
[32m+[m[32m        document.getElementById('edit-cpf').value = cliente.cpf || '';[m
[32m+[m[32m        document.getElementById('edit-telefone').value = cliente.telefone || '';[m
[32m+[m[32m        document.getElementById('edit-email').value = cliente.email || '';[m
[32m+[m[32m        document.getElementById('edit-endereco').value = cliente.endereco || '';[m
[32m+[m[32m        document.getElementById('edit-cidade').value = cliente.cidade || '';[m
[32m+[m[32m        document.getElementById('edit-estado').value = cliente.estado || '';[m
[32m+[m[32m        document.getElementById('edit-observacoes').value = cliente.observacoes || '';[m
[32m+[m
[32m+[m[32m        abrirModal();[m
[32m+[m[32m    } catch (err) {[m
[32m+[m[32m        showMessage('Erro ao carregar dados do cliente: ' + err.message, 'error');[m
[32m+[m[32m    }[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m// Excluir cliente[m
[32m+[m[32masync function excluirCliente(id) {[m
[32m+[m[32m    if (!confirm('Tem certeza que deseja excluir este cliente?')) return;[m
[32m+[m
[32m+[m[32m    try {[m
[32m+[m[32m        const response = await fetch(`${API}/${id}`, {[m
[32m+[m[32m            method: 'DELETE'[m
[32m+[m[32m        });[m
[32m+[m
[32m+[m[32m        if (response.ok) {[m
[32m+[m[32m            showMessage('Cliente exclu√≠do com sucesso!', 'success');[m
[32m+[m[32m            carregarClientes();[m
[32m+[m[32m        } else {[m
[32m+[m[32m            const error = await response.json();[m
[32m+[m[32m            showMessage(error.mensagem || 'Erro ao excluir cliente', 'error');[m
[32m+[m[32m        }[m
[32m+[m[32m    } catch (err) {[m
[32m+[m[32m        showMessage('Erro ao excluir cliente: ' + err.message, 'error');[m
[32m+[m[32m    }[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m// Enviar formul√°rio de edi√ß√£o[m
[32m+[m[32mdocument.getElementById('form-editar').addEventListener('submit', async (e) => {[m
[32m+[m[32m    e.preventDefault();[m
[32m+[m[41m    [m
[32m+[m[32m    const id = document.getElementById('edit-id').value;[m
[32m+[m[32m    const cliente = {[m
[32m+[m[32m        nome: document.getElementById('edit-nome').value,[m
[32m+[m[32m        cpf: document.getElementById('edit-cpf').value,[m
[32m+[m[32m        telefone: document.getElementById('edit-telefone').value,[m
[32m+[m[32m        email: document.getElementById('edit-email').value,[m
[32m+[m[32m        endereco: document.getElementById('edit-endereco').value,[m
[32m+[m[32m        cidade: document.getElementById('edit-cidade').value,[m
[32m+[m[32m        estado: document.getElementById('edit-estado').value.toUpperCase(),[m
[32m+[m[32m        observacoes: document.getElementById('edit-observacoes').value[m
[32m+[m[32m    };[m
[32m+[m
[32m+[m[32m    try {[m
[32m+[m[32m        const response = await fetch(`${API}/${id}`, {[m
[32m+[m[32m            method: 'PUT',[m
[32m+[m[32m            headers: {'Content-Type': 'application/json'},[m
[32m+[m[32m            body: JSON.stringify(cliente)[m
[32m+[m[32m        });[m
[32m+[m
[32m+[m[32m        if (response.ok) {[m
[32m+[m[32m            showMessage('Cliente atualizado com sucesso!', 'success');[m
[32m+[m[32m            fecharModal();[m
[32m+[m[32m            carregarClientes();[m
[32m+[m[32m        } else {[m
[32m+[m[32m            const error = await response.json();[m
[32m+[m[32m            showMessage(error.mensagem || 'Erro ao atualizar cliente', 'error');[m
[32m+[m[32m        }[m
[32m+[m[32m    } catch (err) {[m
[32m+[m[32m        showMessage('Erro ao atualizar cliente: ' + err.message, 'error');[m
[32m+[m[32m    }[m
[32m+[m[32m});[m
[32m+[m
[32m+[m[32m// Carregar lista inicial[m
[32m+[m[32mcarregarClientes();[m
[32m+[m[32m</script>[m
[32m+[m
[32m+[m[32m<style>[m
[32m+[m[32m.action-bar {[m
[32m+[m[32m    display: flex;[m
[32m+[m[32m    justify-content: space-between;[m
[32m+[m[32m    align-items: center;[m
[32m+[m[32m    margin-bottom: 20px;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m.search-input {[m
[32m+[m[32m    flex: 1;[m
[32m+[m[32m    max-width: 300px;[m
[32m+[m[32m    margin-right: 20px;[m
[32m+[m[32m    padding: 8px 12px;[m
[32m+[m[32m    border: 1px solid #ddd;[m
[32m+[m[32m    border-radius: 4px;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m.table-container {[m
[32m+[m[32m    overflow-x: auto;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mtable {[m
[32m+[m[32m    width: 100%;[m
[32m+[m[32m    border-collapse: collapse;[m
[32m+[m[32m    margin-bottom: 20px;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mth, td {[m
[32m+[m[32m    padding: 12px;[m
[32m+[m[32m    text-align: left;[m
[32m+[m[32m    border-bottom: 1px solid #ddd;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mth {[m
[32m+[m[32m    background-color: #f5f5f5;[m
[32m+[m[32m    font-weight: 600;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mtr:hover {[m
[32m+[m[32m    background-color: #f9f9f9;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m.btn-icon {[m
[32m+[m[32m    background: none;[m
[32m+[m[32m    border: none;[m
[32m+[m[32m    color: #666;[m
[32m+[m[32m    cursor: pointer;[m
[32m+[m[32m    padding: 4px 8px;[m
[32m+[m[32m    margin: 0 2px;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m.btn-icon:hover {[m
[32m+[m[32m    color: #000;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m/* Modal */[m
[32m+[m[32m.modal {[m
[32m+[m[32m    display: none;[m
[32m+[m[32m    position: fixed;[m
[32m+[m[32m    z-index: 1000;[m
[32m+[m[32m    left: 0;[m
[32m+[m[32m    top: 0;[m
[32m+[m[32m    width: 100%;[m
[32m+[m[32m    height: 100%;[m
[32m+[m[32m    background-color: rgba(0,0,0,0.5);[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m.modal-content {[m
[32m+[m[32m    background-color: #fff;[m
[32m+[m[32m    margin: 50px auto;[m
[32m+[m[32m    padding: 20px;[m
[32m+[m[32m    border-radius: 8px;[m
[32m+[m[32m    width: 90%;[m
[32m+[m[32m    max-width: 600px;[m
[32m+[m[32m    max-height: 90vh;[m
[32m+[m[32m    overflow-y: auto;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m/* Estilos adicionais para o formul√°rio de edi√ß√£o */[m
[32m+[m[32m#form-editar .form-group {[m
[32m+[m[32m    margin-bottom: 15px;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m#form-editar label {[m
[32m+[m[32m    display: block;[m
[32m+[m[32m    margin-bottom: 5px;[m
[32m+[m[32m    color: #666;[m
[32m+[m[32m    font-weight: 500;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m#form-editar input,[m
[32m+[m[32m#form-editar textarea {[m
[32m+[m[32m    width: 100%;[m
[32m+[m[32m    padding: 8px;[m
[32m+[m[32m    border: 1px solid #ddd;[m
[32m+[m[32m    border-radius: 4px;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m#form-editar textarea {[m
[32m+[m[32m    resize: vertical;[m
[32m+[m[32m}[m
[32m+[m[32m</style>[m
[32m+[m[32m{% endblock %}[m
\ No newline at end of file[m
[1mdiff --git a/Templates/error.html b/Templates/error.html[m
[1mnew file mode 100644[m
[1mindex 0000000..14b076f[m
[1m--- /dev/null[m
[1m+++ b/Templates/error.html[m
[36m@@ -0,0 +1,21 @@[m
[32m+[m[32m<!DOCTYPE html>[m
[32m+[m[32m<html lang="pt-BR">[m
[32m+[m[32m<head>[m
[32m+[m[32m    <meta charset="UTF-8">[m
[32m+[m[32m    <meta name="viewport" content="width=device-width, initial-scale=1.0">[m
[32m+[m[32m    <title>Erro - Sistema de Estoque</title>[m
[32m+[m[32m    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">[m
[32m+[m[32m</head>[m
[32m+[m[32m<body>[m
[32m+[m[32m    <div class="container">[m
[32m+[m[32m        <div class="error-container">[m
[32m+[m[32m            <img src="{{ url_for('static', filename='Images/Logo_tabacaria.png') }}" alt="Logo" class="logo">[m
[32m+[m[32m            <h1>Oops! Algo deu errado</h1>[m
[32m+[m[32m            <p class="error-message">{{ error }}</p>[m
[32m+[m[32m            <div class="error-actions">[m
[32m+[m[32m                <a href="{{ url_for('index') }}" class="btn btn-primary">Voltar ao In√≠cio</a>[m
[32m+[m[32m            </div>[m
[32m+[m[32m        </div>[m
[32m+[m[32m    </div>[m
[32m+[m[32m</body>[m
[32m+[m[32m</html>[m
\ No newline at end of file[m
[1mdiff --git a/Templates/estoque.html b/Templates/estoque.html[m
[1mnew file mode 100644[m
[1mindex 0000000..eb01bfd[m
[1m--- /dev/null[m
[1m+++ b/Templates/estoque.html[m
[36m@@ -0,0 +1,317 @@[m
[32m+[m[32m{% extends "base.html" %}[m
[32m+[m
[32m+[m[32m{% block title %}Estoque - Tabacaria{% endblock %}[m
[32m+[m
[32m+[m[32m{% block extra_css %}[m
[32m+[m[32m<link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css">[m
[32m+[m[32m{% endblock %}[m
[32m+[m
[32m+[m[32m{% block content %}[m
[32m+[m[32m<div class="header">[m
[32m+[m[32m    <img src="{{ url_for('static', filename='Images/Logo_tabacaria.png') }}" alt="Logo" class="logo">[m
[32m+[m[32m    <div>[m
[32m+[m[32m        <h1>Tabacaria - Estoque</h1>[m
[32m+[m[32m        <p style="color:#999; margin-top:6px;">Visualiza√ß√£o do estoque atual</p>[m
[32m+[m[32m    </div>[m
[32m+[m[32m</div>[m
[32m+[m
[32m+[m[32m    <!-- Grid layout for new product + table -->[m
[32m+[m[32m    <div style="display:grid; grid-template-columns:300px 1fr; gap:20px; align-items:start">[m
[32m+[m[32m      <!-- New product form -->[m
[32m+[m[32m      <div class="panel">[m
[32m+[m[32m        <h2>Novo Produto</h2>[m
[32m+[m[32m        <form id="newProductForm">[m
[32m+[m[32m          <div class="form-group">[m
[32m+[m[32m            <label>Nome *</label>[m
[32m+[m[32m            <input type="text" id="newName" required>[m
[32m+[m[32m          </div>[m
[32m+[m[32m          <div class="form-group">[m
[32m+[m[32m            <label>Categoria</label>[m
[32m+[m[32m            <input type="text" id="newCategory">[m
[32m+[m[32m          </div>[m
[32m+[m[32m          <div class="form-group">[m
[32m+[m[32m            <label>Pre√ßo (R$) *</label>[m
[32m+[m[32m            <input type="number" id="newPrice" step="0.01" required>[m
[32m+[m[32m          </div>[m
[32m+[m[32m          <div class="form-group">[m
[32m+[m[32m            <label>Quantidade Inicial *</label>[m
[32m+[m[32m            <input type="number" id="newQuantity" required>[m
[32m+[m[32m          </div>[m
[32m+[m[32m          <button type="submit" class="btn btn-primary">Cadastrar Produto</button>[m
[32m+[m[32m        </form>[m
[32m+[m[32m      </div>[m
[32m+[m
[32m+[m[32m      <!-- Products table -->[m
[32m+[m[32m      <div class="panel">[m
[32m+[m[32m        <h2 style="margin-bottom:18px; border-bottom:3px solid var(--accent-1); padding-bottom:8px;">üìã Estoque Atual</h2>[m
[32m+[m[32m        <div style="overflow-x:auto">[m
[32m+[m[32m          <table id="tabelaEstoque">[m
[32m+[m[32m            <thead>[m
[32m+[m[32m            <tr>[m
[32m+[m[32m              <th>Nome</th>[m
[32m+[m[32m              <th>Categoria</th>[m
[32m+[m[32m              <th>Pre√ßo</th>[m
[32m+[m[32m              <th>Qtd</th>[m
[32m+[m[32m              <th>C√≥digo</th>[m
[32m+[m[32m              <th>Etiqueta</th>[m
[32m+[m[32m              <th style="width:180px">A√ß√µes</th>[m
[32m+[m[32m            </tr>[m
[32m+[m[32m            </thead>[m
[32m+[m[32m            <tbody id="tabela"></tbody>[m
[32m+[m[32m          </table>[m
[32m+[m[32m        </div>[m
[32m+[m[32m      </div>[m
[32m+[m[32m    </div>[m
[32m+[m
[32m+[m[32m    <!-- Modal de Edi√ß√£o -->[m
[32m+[m[32m    <div class="modal" id="editModal">[m
[32m+[m[32m      <div class="modal-content">[m
[32m+[m[32m        <h3>Editar Produto</h3>[m
[32m+[m[32m        <div class="form-group">[m
[32m+[m[32m          <label>Nome</label>[m
[32m+[m[32m          <input id="editName" type="text">[m
[32m+[m[32m        </div>[m
[32m+[m[32m        <div class="form-row">[m
[32m+[m[32m          <div class="form-group">[m
[32m+[m[32m            <label>Categoria</label>[m
[32m+[m[32m            <input id="editCategory" type="text">[m
[32m+[m[32m          </div>[m
[32m+[m[32m          <div class="form-group">[m
[32m+[m[32m            <label>Pre√ßo (R$)</label>[m
[32m+[m[32m            <input id="editPrice" type="number" step="0.01">[m
[32m+[m[32m          </div>[m
[32m+[m[32m        </div>[m
[32m+[m[32m        <div class="form-group">[m
[32m+[m[32m          <label>Quantidade</label>[m
[32m+[m[32m          <input id="editQuantity" type="number">[m
[32m+[m[32m        </div>[m
[32m+[m[32m        <div class="btn-group">[m
[32m+[m[32m          <button class="btn-primary" id="saveEditBtn">Salvar</button>[m
[32m+[m[32m          <button class="btn-secondary" onclick="closeEditModal()">Cancelar</button>[m
[32m+[m[32m        </div>[m
[32m+[m[32m      </div>[m
[32m+[m[32m    </div>[m
[32m+[m[32m    <!-- Modal de Impress√£o (mesma p√°gina) -->[m
[32m+[m[32m    <div class="modal" id="printModal">[m
[32m+[m[32m      <div class="modal-content print-modal-content">[m
[32m+[m[32m          <div class="print-area" id="printArea">[m
[32m+[m[32m            <div class="etiqueta">[m
[32m+[m[32m              <img id="printBarcodeImg" src="" alt="C√≥digo de barras">[m
[32m+[m[32m              <div id="productName" class="product-name"></div>[m
[32m+[m[32m            </div>[m
[32m+[m[32m          </div>[m
[32m+[m[32m          <div style="text-align:center;margin-top:12px">[m
[32m+[m[32m            <button class="btn btn-secondary" onclick="closePrintModal()">Fechar</button>[m
[32m+[m[32m          </div>[m
[32m+[m[32m      </div>[m
[32m+[m[32m    </div>[m
[32m+[m[32m    </div>[m
[32m+[m
[32m+[m[32m    <script src="{{ url_for('static', filename='js/common.js') }}"></script>[m
[32m+[m[32m    <script>[m
[32m+[m[32m    async function carregarProdutos(){[m
[32m+[m[32m      try {[m
[32m+[m[32m        const res = await fetch('/api/produtos');[m
[32m+[m[32m        if (!res.ok) throw new Error('Erro ao carregar');[m
[32m+[m[32m        const produtos = await res.json();[m
[32m+[m[32m        const tbody = document.getElementById('tabela');[m
[32m+[m[32m        tbody.innerHTML = '';[m
[32m+[m[32m        produtos.forEach(p=>{[m
[32m+[m[32m          tbody.innerHTML += `<tr>[m
[32m+[m[32m            <td>${p.nome}</td>[m
[32m+[m[32m            <td>${p.categoria || ''}</td>[m
[32m+[m[32m            <td>R$ ${Number(p.preco).toFixed(2)}</td>[m
[32m+[m[32m            <td>${p.quantidade}</td>[m
[32m+[m[32m            <td>${p.codigo_barras || ''}</td>[m
[32m+[m[32m            <td>[m
[32m+[m[32m                <img src="/static/barcodes/${p.codigo_barras}.svg" width="120" alt="etiqueta" onerror="this.style.display='none'"> <br>[m
[32m+[m[32m                <button class="btn-primary" onclick="imprimirEtiqueta(${p.id_produto})">üñ®Ô∏è Imprimir</button>[m
[32m+[m[32m            </td>[m
[32m+[m[32m            <td>[m
[32m+[m[32m                <button class="btn-primary" onclick="openEditModal(${p.id_produto})">‚úèÔ∏è Editar</button>[m
[32m+[m[32m                <button class="btn-danger" onclick="deleteProductFromTable(${p.id_produto})">üóëÔ∏è Remover</button>[m
[32m+[m[32m            </td>[m
[32m+[m[32m          </tr>`;[m
[32m+[m[32m        });[m
[32m+[m[32m      } catch (err) {[m
[32m+[m[32m        console.error(err);[m
[32m+[m[32m        const tbody = document.getElementById('tabela');[m
[32m+[m[32m        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#999">Erro ao carregar produtos</td></tr>';[m
[32m+[m[32m      }[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    function openEditModal(id) {[m
[32m+[m[32m      // busca produto atual[m
[32m+[m[32m      fetch('/api/produtos')[m
[32m+[m[32m        .then(r=>r.json())[m
[32m+[m[32m        .then(list=>{[m
[32m+[m[32m          const p = list.find(x=>x.id_produto===id);[m
[32m+[m[32m          if (!p) return alert('Produto n√£o encontrado');[m
[32m+[m[32m          document.getElementById('editName').value = p.nome || '';[m
[32m+[m[32m          document.getElementById('editCategory').value = p.categoria || '';[m
[32m+[m[32m          document.getElementById('editPrice').value = Number(p.preco || 0).toFixed(2);[m
[32m+[m[32m          document.getElementById('editQuantity').value = p.quantidade || 0;[m
[32m+[m[32m          document.getElementById('editModal').classList.add('active');[m
[32m+[m[32m          document.getElementById('saveEditBtn').onclick = () => saveEdit(id);[m
[32m+[m[32m        })[m
[32m+[m[32m        .catch(err=>{ console.error(err); alert('Erro ao obter produto'); });[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    function closeEditModal(){ document.getElementById('editModal').classList.remove('active'); }[m
[32m+[m[32m      function closePrintModal(){ document.getElementById('printModal').classList.remove('active'); }[m
[32m+[m
[32m+[m[32m    async function saveEdit(id){[m
[32m+[m[32m      const nome = document.getElementById('editName').value.trim();[m
[32m+[m[32m      const categoria = document.getElementById('editCategory').value.trim();[m
[32m+[m[32m      const preco = parseFloat(document.getElementById('editPrice').value) || 0;[m
[32m+[m[32m      const quantidade = parseInt(document.getElementById('editQuantity').value) || 0;[m
[32m+[m[32m      if(!nome){ alert('Nome obrigat√≥rio'); return; }[m
[32m+[m[32m      try{[m
[32m+[m[32m        const res = await fetch(`/api/produtos/${id}`, {[m
[32m+[m[32m          method:'PUT', headers:{'Content-Type':'application/json'},[m
[32m+[m[32m          body: JSON.stringify({nome, categoria, preco, quantidade})[m
[32m+[m[32m        });[m
[32m+[m[32m        if (!res.ok) {[m
[32m+[m[32m          const data = await res.json().catch(()=>({erro:'erro'}));[m
[32m+[m[32m          throw new Error(data.erro || 'Falha ao salvar');[m
[32m+[m[32m        }[m
[32m+[m[32m        closeEditModal();[m
[32m+[m[32m        carregarProdutos();[m
[32m+[m[32m        alert('Produto atualizado');[m
[32m+[m[32m      } catch (err){ console.error(err); alert('Erro ao atualizar produto'); }[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    async function deleteProductFromTable(id){[m
[32m+[m[32m      if(!confirm('Confirmar remo√ß√£o deste produto?')) return;[m
[32m+[m[32m      try{[m
[32m+[m[32m        const res = await fetch(`/api/produtos/${id}`, { method:'DELETE' });[m
[32m+[m[32m        if (!res.ok) throw new Error('Falha ao remover');[m
[32m+[m[32m        carregarProdutos();[m
[32m+[m[32m      } catch(err){ console.error(err); alert('Erro ao remover produto'); }[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    carregarProdutos();[m
[32m+[m
[32m+[m[32m  async function imprimirEtiqueta(id) {[m
[32m+[m[32m    try{[m
[32m+[m[32m      // Busca produto para obter o nome[m
[32m+[m[32m      const prodRes = await fetch('/api/produtos');[m
[32m+[m[32m      if (!prodRes.ok) throw new Error('Erro ao buscar produto');[m
[32m+[m[32m      const produtos = await prodRes.json();[m
[32m+[m[32m      const produto = produtos.find(p => p.id_produto === id);[m
[32m+[m[32m      if (!produto) throw new Error('Produto n√£o encontrado');[m
[32m+[m[41m      [m
[32m+[m[32m      // Garante que o SVG exista e recupera caminho[m
[32m+[m[32m      const res = await fetch(`/api/generate_barcode/${id}`);[m
[32m+[m[32m      if(!res.ok) throw new Error('N√£o foi poss√≠vel gerar etiqueta');[m
[32m+[m[32m      const data = await res.json();[m
[32m+[m[41m      [m
[32m+[m[32m      const img = document.getElementById('printBarcodeImg');[m
[32m+[m[32m      img.src = data.path + '?_t=' + Date.now(); // bust cache[m
[32m+[m[41m      [m
[32m+[m[32m      // Adiciona o nome do produto[m
[32m+[m[32m      const nameElement = document.getElementById('productName');[m
[32m+[m[32m      nameElement.textContent = produto.nome;[m
[32m+[m[41m      [m
[32m+[m[32m      const modal = document.getElementById('printModal');[m
[32m+[m[32m      modal.classList.add('active');[m
[32m+[m
[32m+[m[32m      // Handler after print to close modal[m
[32m+[m[32m      const after = function(){[m
[32m+[m[32m        modal.classList.remove('active');[m
[32m+[m[32m        window.removeEventListener('afterprint', after);[m
[32m+[m[32m      };[m
[32m+[m[32m      window.addEventListener('afterprint', after);[m
[32m+[m
[32m+[m[32m      // Aguarda um pouco para garantir renderiza√ß√£o e abre di√°logo de impress√£o[m
[32m+[m[32m      setTimeout(()=>{[m
[32m+[m[32m        try{ window.print(); }catch(e){ console.error(e); }[m
[32m+[m[32m      }, 300);[m
[32m+[m[32m    }catch(err){ console.error(err); alert('Erro ao preparar etiqueta: '+(err.message||err)); }[m
[32m+[m[32m  }[m
[32m+[m
[32m+[m[32m    // Recarregar tabela com DataTables[m
[32m+[m[32mlet tabelaDT;[m
[32m+[m
[32m+[m[32masync function carregarProdutos(){[m
[32m+[m[32m  try {[m
[32m+[m[32m    const res = await fetch('/api/produtos');[m
[32m+[m[32m    if (!res.ok) throw new Error('Erro ao carregar');[m
[32m+[m[32m    const produtos = await res.json();[m
[32m+[m[32m    const tbody = document.getElementById('tabela');[m
[32m+[m[32m    tbody.innerHTML = '';[m
[32m+[m
[32m+[m[32m    produtos.forEach(p=>{[m
[32m+[m[32m      tbody.innerHTML += `<tr>[m
[32m+[m[32m        <td>${p.nome}</td>[m
[32m+[m[32m        <td>${p.categoria || ''}</td>[m
[32m+[m[32m        <td>R$ ${Number(p.preco).toFixed(2)}</td>[m
[32m+[m[32m        <td>${p.quantidade}</td>[m
[32m+[m[32m        <td>${p.codigo_barras || ''}</td>[m
[32m+[m[32m        <td>[m
[32m+[m[32m            <img src="/static/barcodes/${p.codigo_barras}.svg" width="120" alt="etiqueta" onerror="this.style.display='none'"> <br>[m
[32m+[m[32m            <button class="btn-primary" onclick="imprimirEtiqueta(${p.id_produto})">üñ®Ô∏è Imprimir</button>[m
[32m+[m[32m        </td>[m
[32m+[m[32m        <td>[m
[32m+[m[32m            <button class="btn-primary" onclick="openEditModal(${p.id_produto})">‚úèÔ∏è Editar</button>[m
[32m+[m[32m            <button class="btn-danger" onclick="deleteProductFromTable(${p.id_produto})">üóëÔ∏è Remover</button>[m
[32m+[m[32m        </td>[m
[32m+[m[32m      </tr>`;[m
[32m+[m[32m    });[m
[32m+[m
[32m+[m[32m    // Reaplicar DataTable[m
[32m+[m[32m    if (tabelaDT) {[m
[32m+[m[32m      tabelaDT.destroy();[m
[32m+[m[32m    }[m
[32m+[m[32m    tabelaDT = new DataTable('#tabelaEstoque', {[m
[32m+[m[32m      language: {[m
[32m+[m[32m        url: 'https://cdn.datatables.net/plug-ins/1.13.5/i18n/pt-BR.json'[m
[32m+[m[32m      },[m
[32m+[m[32m      pageLength: 10,[m
[32m+[m[32m      ordering: true,[m
[32m+[m[32m      responsive: true[m
[32m+[m[32m    });[m
[32m+[m
[32m+[m[32m  } catch (err) {[m
[32m+[m[32m    console.error(err);[m
[32m+[m[32m    document.getElementById('tabela').innerHTML = '<tr><td colspan="7">Erro ao carregar produtos</td></tr>';[m
[32m+[m[32m  }[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m// Handle new product form[m
[32m+[m[32mdocument.getElementById('newProductForm').addEventListener('submit', async (e) => {[m
[32m+[m[32m  e.preventDefault();[m
[32m+[m[32m  const nome = document.getElementById('newName').value.trim();[m
[32m+[m[32m  const categoria = document.getElementById('newCategory').value.trim();[m
[32m+[m[32m  const preco = parseFloat(document.getElementById('newPrice').value) || 0;[m
[32m+[m[32m  const quantidade = parseInt(document.getElementById('newQuantity').value) || 0;[m
[32m+[m
[32m+[m[32m  try {[m
[32m+[m[32m    const res = await fetch('/api/produtos', {[m
[32m+[m[32m      method: 'POST',[m
[32m+[m[32m      headers: {'Content-Type': 'application/json'},[m
[32m+[m[32m      body: JSON.stringify({nome, categoria, preco, quantidade})[m
[32m+[m[32m    });[m
[32m+[m[32m    if (!res.ok) {[m
[32m+[m[32m      const data = await res.json().catch(() => ({}));[m
[32m+[m[32m      throw new Error(data.erro || 'Falha ao cadastrar');[m
[32m+[m[32m    }[m
[32m+[m[32m    // reset form[m
[32m+[m[32m    e.target.reset();[m
[32m+[m[32m    carregarProdutos();[m
[32m+[m[32m    alert('Produto cadastrado com sucesso!');[m
[32m+[m[32m  } catch(err) {[m
[32m+[m[32m    console.error(err);[m
[32m+[m[32m    alert('Erro ao cadastrar produto: ' + (err.message || err));[m
[32m+[m[32m  }[m
[32m+[m[32m});[m
[32m+[m
[32m+[m[32mcarregarProdutos();[m
[32m+[m[32m  </script>[m
[32m+[m[32m{% endblock %}[m
[32m+[m
[32m+[m[32m{% block extra_js %}[m
[32m+[m[32m<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>[m
[32m+[m[32m<script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>[m
[32m+[m[32m<script src="https://cdnjs.cloudflare.com/ajax/libs/jsbarcode/3.11.5/JsBarcode.all.min.js"></script>[m
[32m+[m[32m{% endblock %}[m
[1mdiff --git a/Templates/index.html b/Templates/index.html[m
[1mnew file mode 100644[m
[1mindex 0000000..fdee16d[m
[1m--- /dev/null[m
[1m+++ b/Templates/index.html[m
[36m@@ -0,0 +1,96 @@[m
[32m+[m[32m{% extends "base.html" %}[m
[32m+[m
[32m+[m[32m{% block title %}Painel - Controle de Estoque{% endblock %}[m
[32m+[m
[32m+[m[32m{% block extra_css %}[m
[32m+[m[32m<style>[m
[32m+[m[32m    /* small dashboard helpers */[m
[32m+[m[32m    .dash-grid{ display:grid; grid-template-columns:repeat(3,1fr); gap:16px }[m
[32m+[m[32m    @media(max-width:980px){ .dash-grid{ grid-template-columns:repeat(1,1fr) } }[m
[32m+[m[32m    .dash-card{ background:linear-gradient(180deg,#1d1b8dc0,#00000077); padding:18px; border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,0.06); display:flex; align-items:center; gap:12px }[m
[32m+[m[32m    .dash-card .icon{ width:56px; height:56px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:22px }[m
[32m+[m[32m    .dash-card .meta{ flex:1 }[m
[32m+[m[32m    .dash-card h3{ margin:0; font-size:16px }[m
[32m+[m[32m    .dash-card p{ margin:6px 0 0; color:var(--muted) }[m
[32m+[m[32m    .recent-list li{ padding:8px 0; border-bottom:1px dashed #271c1c }[m
[32m+[m[32m</style>[m
[32m+[m[32m{% endblock %}[m
[32m+[m
[32m+[m[32m{% block content %}[m
[32m+[m[32m<div class="header">[m
[32m+[m[32m    <img src="{{ url_for('static', filename='Images/Logo_tabacaria.png') }}" alt="Logo" class="logo">[m
[32m+[m[32m    <div>[m
[32m+[m[32m        <h1>Painel de Controle</h1>[m
[32m+[m[32m        <p class="muted">Acesso r√°pido √†s √°reas principais e hist√≥rico recente</p>[m
[32m+[m[32m    </div>[m
[32m+[m[32m    <div class="header-actions">[m
[32m+[m[32m        <button class="btn btn-secondary" onclick="window.location.href='/'">In√≠cio</button>[m
[32m+[m[32m        <button class="btn btn-secondary" onclick="window.location.href='/registrar'">Registrar</button>[m
[32m+[m[32m        <button class="btn btn-secondary" onclick="window.location.href='/estoque'">Estoque</button>[m
[32m+[m[32m        <button class="btn btn-primary" onclick="window.location.href='/venda'">Nova Venda</button>[m
[32m+[m[32m        <button class="btn btn-secondary" onclick="window.location.href='/movimentacoes'">Movimenta√ß√µes</button>[m
[32m+[m[32m    </div>[m
[32m+[m[32m</div>[m
[32m+[m
[32m+[m[32m<div class="panel" style="margin-top:16px">[m
[32m+[m[32m    <h2>Vis√£o Geral</h2>[m
[32m+[m[32m    <div class="dash-grid">[m
[32m+[m[32m        <div class="dash-card" onclick="location.href='/estoque'" style="cursor:pointer">[m
[32m+[m[32m            <div class="icon" style="background:linear-gradient(90deg,var(--accent-1),var(--accent-2)); color:rgb(223, 214, 214)">[m
[32m+[m[32m                <i class="fa-solid fa-box-open"></i>[m
[32m+[m[32m            </div>[m
[32m+[m[32m            <div class="meta">[m
[32m+[m[32m                <h3>Produtos</h3>[m
[32m+[m[32m                <p id="countProducts">Carregando...</p>[m
[32m+[m[32m            </div>[m
[32m+[m[32m        </div>[m
[32m+[m
[32m+[m[32m        <div class="dash-card" onclick="location.href='/estoque'" style="cursor:pointer">[m
[32m+[m[32m            <div class="icon" style="background:#06b6d4; color:white"><i class="fa-solid fa-warehouse"></i></div>[m
[32m+[m[32m            <div class="meta">[m
[32m+[m[32m                <h3>Quantidade em Estoque</h3>[m
[32m+[m[32m                <p id="totalStock">Carregando...</p>[m
[32m+[m[32m            </div>[m
[32m+[m[32m        </div>[m
[32m+[m
[32m+[m[32m        <div class="dash-card" onclick="location.href='/movimentacoes'" style="cursor:pointer">[m
[32m+[m[32m            <div class="icon" style="background:#10b981; color:white"><i class="fa-solid fa-clock-rotate-left"></i></div>[m
[32m+[m[32m            <div class="meta">[m
[32m+[m[32m                <h3>Movimenta√ß√µes Recentes</h3>[m
[32m+[m[32m                <p>√öltimas a√ß√µes registradas</p>[m
[32m+[m[32m            </div>[m
[32m+[m[32m        </div>[m
[32m+[m[32m    </div>[m
[32m+[m[32m</div>[m
[32m+[m
[32m+[m[32m<div class="panel" style="margin-top:16px">[m
[32m+[m[32m    <h2>√öltimas Movimenta√ß√µes</h2>[m
[32m+[m[32m    <ul class="recent-list" id="recentMoves">[m
[32m+[m[32m        <li>Carregando...</li>[m
[32m+[m[32m    </ul>[m
[32m+[m[32m    <div style="text-align:right; margin-top:12px">[m
[32m+[m[32m        <button class="btn btn-secondary" onclick="location.href='/movimentacoes'">Ver todas</button>[m
[32m+[m[32m    </div>[m
[32m+[m[32m</div>[m
[32m+[m[32m{% endblock %}[m
[32m+[m
[32m+[m[32m{% block extra_js %}[m
[32m+[m[32m<script>[m
[32m+[m[32m    async function fetchCounts(){[m
[32m+[m[32m        try{[m
[32m+[m[32m            const p = await fetch('/api/produtos');[m
[32m+[m[32m            const produtos = p.ok? await p.json():[];[m
[32m+[m[32m            document.getElementById('countProducts').textContent = produtos.length + ' produtos';[m
[32m+[m[32m            const total = produtos.reduce((s,item)=> s + (parseInt(item.quantidade)||0), 0);[m
[32m+[m[32m            document.getElementById('totalStock').textContent = total + ' unidades';[m
[32m+[m
[32m+[m[32m            const m = await fetch('/api/movimentacoes?limit=5');[m
[32m+[m[32m            const moves = m.ok? await m.json():[];[m
[32m+[m[32m            const ul = document.getElementById('recentMoves');[m
[32m+[m[32m            if(!moves.length) { ul.innerHTML = '<li>Nenhuma movimenta√ß√£o recente</li>'; return }[m
[32m+[m[32m            ul.innerHTML = moves.map(mi=>`<li><strong>${mi.produto_nome||'?'}</strong> ‚Äî ${mi.tipo} ${mi.quantidade} <span style="color:var(--muted);">(${mi.data_mov})</span></li>`).join('');[m
[32m+[m[32m        }catch(e){ console.error(e); }[m
[32m+[m[32m    }[m
[32m+[m[32m    fetchCounts();[m
[32m+[m[32m</script>[m
[32m+[m[32m{% endblock %}[m
[1mdiff --git a/Templates/movimentacoes.html b/Templates/movimentacoes.html[m
[1mnew file mode 100644[m
[1mindex 0000000..82340c6[m
[1m--- /dev/null[m
[1m+++ b/Templates/movimentacoes.html[m
[36m@@ -0,0 +1,190 @@[m
[32m+[m[32m{% extends "base.html" %}[m
[32m+[m
[32m+[m[32m{% block title %}Hist√≥rico de Movimenta√ß√µes{% endblock %}[m
[32m+[m
[32m+[m[32m{% block content %}[m
[32m+[m[32m<div class="header">[m
[32m+[m[32m    <img src="{{ url_for('static', filename='Images/Logo_tabacaria.png') }}" alt="Logo" class="logo">[m
[32m+[m[32m    <div>[m
[32m+[m[32m        <h1>Hist√≥rico de Movimenta√ß√µes</h1>[m
[32m+[m[32m        <p class="muted">Entradas e sa√≠das de estoque</p>[m
[32m+[m[32m    </div>[m
[32m+[m[32m</div>[m
[32m+[m
[32m+[m[32m    <div class="panel" style="margin-top:16px">[m
[32m+[m[32m      <h2>√öltimas Movimenta√ß√µes</h2>[m
[32m+[m[32m      <div id="movAlert"></div>[m
[32m+[m
[32m+[m[32m      <div style="display:flex; gap:8px; margin-bottom:12px; align-items:center">[m
[32m+[m[32m        <input id="q" placeholder="Pesquisar produto ou observa√ß√£o" style="flex:1; padding:8px 10px; border-radius:8px; border:1px solid #e6edf3">[m
[32m+[m[32m        <input id="start_date" type="date" style="padding:8px 10px; border-radius:8px; border:1px solid #e6edf3">[m
[32m+[m[32m        <input id="end_date" type="date" style="padding:8px 10px; border-radius:8px; border:1px solid #e6edf3">[m
[32m+[m[32m        <button class="btn btn-primary" id="btnFilter">Filtrar</button>[m
[32m+[m[32m        <button class="btn btn-ghost" id="btnClear">Limpar</button>[m
[32m+[m[32m      </div>[m
[32m+[m
[32m+[m[32m      <table class="table" id="movTable">[m
[32m+[m[32m        <thead>[m
[32m+[m[32m          <tr>[m
[32m+[m[32m            <th>ID Venda</th>[m
[32m+[m[32m            <th>Nome</th>[m
[32m+[m[32m            <th>Data</th>[m
[32m+[m[32m            <th>A√ß√µes</th>[m
[32m+[m[32m          </tr>[m
[32m+[m[32m        </thead>[m
[32m+[m[32m        <tbody>[m
[32m+[m[32m          <tr><td colspan="6">Carregando...</td></tr>[m
[32m+[m[32m        </tbody>[m
[32m+[m[32m      </table>[m
[32m+[m[32m    </div>[m
[32m+[m[32m  </div>[m
[32m+[m
[32m+[m[32m  <script>[m
[32m+[m[32m    const API = '/api/movimentacoes';[m
[32m+[m[32m    const tableBody = document.querySelector('#movTable tbody');[m
[32m+[m[32m    const movAlert = document.getElementById('movAlert');[m
[32m+[m[32m  const vendaCache = {};[m
[32m+[m
[32m+[m[32m    function showAlert(msg, ok=true){ movAlert.innerHTML = `<div class="alert ${ok? 'alert-success':'alert-danger'}">${msg}</div>`; setTimeout(()=>movAlert.innerHTML='',5000); }[m
[32m+[m
[32m+[m[32m    async function loadMov(limit=100){[m
[32m+[m[32m  tableBody.innerHTML = '<tr><td colspan="4">Carregando...</td></tr>';[m
[32m+[m[32m      try{[m
[32m+[m[32m        const q = document.getElementById('q').value.trim();[m
[32m+[m[32m        const start = document.getElementById('start_date').value || null;[m
[32m+[m[32m        const end = document.getElementById('end_date').value || null;[m
[32m+[m[32m        const params = new URLSearchParams();[m
[32m+[m[32m        if(limit) params.set('limit', limit);[m
[32m+[m[32m        if(q) params.set('q', q);[m
[32m+[m[32m        if(start) params.set('start_date', start + ' 00:00:00');[m
[32m+[m[32m        if(end) params.set('end_date', end + ' 23:59:59');[m
[32m+[m
[32m+[m[32m        const res = await fetch(API + '?' + params.toString());[m
[32m+[m[32m        if(!res.ok) throw new Error('Falha ao carregar movimenta√ß√µes');[m
[32m+[m[32m        const data = await res.json();[m
[32m+[m[32m  if(!data.length) { tableBody.innerHTML = '<tr><td colspan="4">Nenhuma movimenta√ß√£o encontrada</td></tr>'; return }[m
[32m+[m[32m        // detect sales and prefetch venda headers so we can display id, cliente and date immediately[m
[32m+[m[32m        const vendaRe = /Venda\s*#(\d+)/i;[m
[32m+[m[32m        const vendaIds = [];[m
[32m+[m[32m        const movMap = {};[m
[32m+[m[32m        for(const m of data){[m
[32m+[m[32m            const match = (m.observacao||'').match(vendaRe);[m
[32m+[m[32m            if(match){[m
[32m+[m[32m                const vendaId = parseInt(match[1]);[m
[32m+[m[32m                vendaIds.push({movId: m.id_mov, vendaId});[m
[32m+[m[32m                movMap[m.id_mov] = m;[m
[32m+[m[32m            }[m
[32m+[m[32m        }[m
[32m+[m[32m    // fetch all vendas in parallel and cache them[m
[32m+[m[32m    await Promise.all(vendaIds.map(async pair => {[m
[32m+[m[32m      try{[m
[32m+[m[32m        const res = await fetch(`/api/vendas/${pair.vendaId}`);[m
[32m+[m[32m        if(res.ok){ vendaCache[pair.movId] = await res.json(); }[m
[32m+[m[32m      }catch(e){ /* ignore */ }[m
[32m+[m[32m    }));[m
[32m+[m
[32m+[m[32m        const rowsOut = [];[m
[32m+[m[32m        for(const m of data){[m
[32m+[m[32m            const pair = vendaIds.find(v => v.movId === m.id_mov);[m
[32m+[m[32m            if(pair){[m
[32m+[m[32m                const venda = vendaCache[m.id_mov] || {};[m
[32m+[m[32m                const clienteNome = venda.cliente_nome || '-';[m
[32m+[m[32m                const vendaId = pair.vendaId;[m
[32m+[m[32m                // row: id da venda, nome, data, actions[m
[32m+[m[32m                rowsOut.push(`[m
[32m+[m[32m                  <tr data-mov="${m.id_mov}" data-venda="${vendaId}">[m
[32m+[m[32m                    <td>${vendaId}</td>[m
[32m+[m[32m                    <td>${escapeHtml(clienteNome)}</td>[m
[32m+[m[32m                    <td>${m.data_mov}</td>[m
[32m+[m[32m                    <td>[m
[32m+[m[32m                      <button class="btn btn-ghost" id="toggle-${m.id_mov}" onclick="toggleDetails(${m.id_mov})">‚ñæ</button>[m
[32m+[m[32m                      <button class="btn btn-danger" onclick="deleteMov(${m.id_mov})">Remover</button>[m
[32m+[m[32m                    </td>[m
[32m+[m[32m                  </tr>[m
[32m+[m[32m                  <tr id="details-${m.id_mov}" style="display:none; background:#fafafa"><td colspan="4">&nbsp;</td></tr>[m
[32m+[m[32m                `);[m
[32m+[m[32m            } else {[m
[32m+[m[32m                rowsOut.push(`[m
[32m+[m[32m                  <tr>[m
[32m+[m[32m                    <td></td>[m
[32m+[m[32m                    <td>${escapeHtml(m.produto_nome||'')}</td>[m
[32m+[m[32m                    <td>${escapeHtml(m.data_mov||'')}</td>[m
[32m+[m[32m                    <td><button class="btn btn-danger" onclick="deleteMov(${m.id_mov})">Remover</button></td>[m
[32m+[m[32m                  </tr>[m
[32m+[m[32m                `);[m
[32m+[m[32m            }[m
[32m+[m[32m        }[m
[32m+[m[32m  tableBody.innerHTML = rowsOut.join('');[m
[32m+[m[32m      }catch(err){ console.error(err); tableBody.innerHTML = '<tr><td colspan="6">Erro ao carregar</td></tr>'; }[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m  // fetch venda data and populate details; called by toggleDetails[m
[32m+[m[32m  async function loadVendaForMov(movId){[m
[32m+[m[32m    try{[m
[32m+[m[32m      const row = document.querySelector(`tr[data-mov="${movId}"]`);[m
[32m+[m[32m      if(!row) return null;[m
[32m+[m[32m      const vendaId = row.getAttribute('data-venda');[m
[32m+[m[32m      if(!vendaId) return null;[m
[32m+[m[32m      // try cache first[m
[32m+[m[32m      let venda = vendaCache[movId] || null;[m
[32m+[m[32m      if(!venda){[m
[32m+[m[32m        const res = await fetch(`/api/vendas/${vendaId}`);[m
[32m+[m[32m        if(!res.ok) return null;[m
[32m+[m[32m        venda = await res.json();[m
[32m+[m[32m        vendaCache[movId] = venda;[m
[32m+[m[32m      }[m
[32m+[m[32m      // build details html[m
[32m+[m[32m      const items = (venda.items||[]).map(it=>`<tr><td style="padding:6px">${escapeHtml(it.produto_nome||'')}</td><td style="padding:6px; text-align:center">${it.quantidade}</td><td style="padding:6px; text-align:right">R$ ${parseFloat(it.preco_unitario||0).toFixed(2)}</td></tr>`).join('');[m
[32m+[m[32m      const total = venda.total ? `R$ ${parseFloat(venda.total).toFixed(2)}` : '-';[m
[32m+[m[32m                // format details as requested: list of '- Produto x QTY UN' and totals + desconto[m
[32m+[m[32m                const totalBruto = (venda.items||[]).reduce((s,it)=> s + (parseFloat(it.preco_unitario||0) * (parseInt(it.quantidade)||0)), 0);[m
[32m+[m[32m                const discountPercent = venda.discount_percent !== undefined && venda.discount_percent !== null ? parseFloat(venda.discount_percent) : 0;[m
[32m+[m[32m                const discountAmount = totalBruto * (Math.abs(discountPercent) / 100);[m
[32m+[m[32m                const totalAfter = totalBruto - discountAmount;[m
[32m+[m[32m                const itemsLines = (venda.items||[]).map(it => `- ${escapeHtml(it.produto_nome||'')} x ${it.quantidade} UN`).join('<br>');[m
[32m+[m[32m                const detailHtml = `[m
[32m+[m[32m        <div style="padding:8px; border-radius:6px; font-size:14px">[m
[32m+[m[32m          <div style="font-weight:700; margin-bottom:8px">Venda #${venda.id_venda} ‚Äî Cliente: ${escapeHtml(venda.cliente_nome||'')}</div>[m
[32m+[m[32m          <div style="margin-bottom:8px">${itemsLines}</div>[m
[32m+[m[32m          <div style="margin-top:8px">Total: <strong>R$ ${totalBruto.toFixed(2)}</strong></div>[m
[32m+[m[32m          <div>Desconto: <strong>${discountPercent ? (discountPercent + '%') : '-'} </strong></div>[m
[32m+[m[32m          <div>Total com Desconto: <strong>R$ ${totalAfter.toFixed(2)}</strong></div>[m
[32m+[m[32m        </div>[m
[32m+[m[32m      `;[m
[32m+[m[32m      const detailsRow = document.getElementById(`details-${movId}`);[m
[32m+[m[32m      if(detailsRow) detailsRow.firstElementChild.innerHTML = detailHtml;[m
[32m+[m[32m      return venda;[m
[32m+[m[32m    }catch(e){ console.error('Erro ao carregar venda', e); return null }[m
[32m+[m[32m  }[m
[32m+[m
[32m+[m[32m  function toggleDetails(movId){[m
[32m+[m[32m    const detailsRow = document.getElementById(`details-${movId}`);[m
[32m+[m[32m    if(!detailsRow) return;[m
[32m+[m[32m    const isHidden = detailsRow.style.display === 'none' || detailsRow.style.display === '';[m
[32m+[m[32m    if(isHidden){[m
[32m+[m[32m      // load data once when opening[m
[32m+[m[32m      if(!detailsRow.dataset.loaded){[m
[32m+[m[32m        loadVendaForMov(movId).then(()=>{ detailsRow.dataset.loaded = '1'; });[m
[32m+[m[32m      }[m
[32m+[m[32m      detailsRow.style.display = 'table-row';[m
[32m+[m[32m      const btn = document.getElementById(`toggle-${movId}`); if(btn) btn.textContent = '‚ñ¥';[m
[32m+[m[32m    } else {[m
[32m+[m[32m      detailsRow.style.display = 'none';[m
[32m+[m[32m      const btn = document.getElementById(`toggle-${movId}`); if(btn) btn.textContent = '‚ñæ';[m
[32m+[m[32m    }[m
[32m+[m[32m  }[m
[32m+[m
[32m+[m[32m    function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>\"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":"&#39;"})[c]); }[m
[32m+[m
[32m+[m[32m    async function deleteMov(id){ if(!confirm('Confirma remover esta movimenta√ß√£o?')) return; try{ const res = await fetch(API+'/'+id,{method:'DELETE'}); const data = await res.json().catch(()=>({})); if(!res.ok){ showAlert(data.erro||'Falha', false); return } showAlert(data.mensagem||'Removido'); loadMov(100); }catch(e){ console.error(e); showAlert('Erro ao comunicar com o servidor', false); } }[m
[32m+[m
[32m+[m[32m  document.getElementById('btnFilter').addEventListener('click', ()=> loadMov(100));[m
[32m+[m[32m  document.getElementById('btnClear').addEventListener('click', ()=>{ document.getElementById('q').value=''; document.getElementById('start_date').value=''; document.getElementById('end_date').value=''; loadMov(100); });[m
[32m+[m[32m  loadMov(100);[m
[32m+[m[32m  </script>[m
[32m+[m[32m  {% endblock %}[m
[32m+[m[32m  {% block scripts %}[m
[32m+[m[32m    <script>[m
[32m+[m[32m      loadMov(100);[m
[32m+[m[32m    </script>[m
[32m+[m[32m  {% endblock %}[m
\ No newline at end of file[m
[1mdiff --git a/Templates/print_label.html b/Templates/print_label.html[m
[1mnew file mode 100644[m
[1mindex 0000000..a2fafb3[m
[1m--- /dev/null[m
[1m+++ b/Templates/print_label.html[m
[36m@@ -0,0 +1,35 @@[m
[32m+[m[32m<!doctype html>[m
[32m+[m[32m<html lang="pt-BR">[m
[32m+[m[32m<head>[m
[32m+[m[32m  <meta charset="utf-8">[m
[32m+[m[32m  <meta name="viewport" content="width=device-width,initial-scale=1">[m
[32m+[m[32m  <title>Etiqueta - {{ codigo_barras }}</title>[m
[32m+[m[32m  <style>[m
[32m+[m[32m    body{ margin:0; padding:18px; font-family: Arial, Helvetica, sans-serif; text-align:center }[m
[32m+[m[32m    .label{ display:inline-block; padding:12px; border-radius:8px; background:#fff; box-shadow:0 6px 18px rgba(0,0,0,0.08) }[m
[32m+[m[32m    .barcode{ max-width:360px; width:100%; height:auto }[m
[32m+[m[32m    .small{ color:#666; font-size:13px }[m
[32m+[m[32m    button{ display:inline-block; margin-top:12px; padding:8px 12px }[m
[32m+[m[32m    @media print {[m
[32m+[m[32m      body { padding: 0; }[m
[32m+[m[32m      .label { box-shadow: none; }[m
[32m+[m[32m    }[m
[32m+[m[32m  </style>[m
[32m+[m[32m</head>[m
[32m+[m[32m<body>[m
[32m+[m[32m  <div class="label">[m
[32m+[m[32m    <div class="barcode">[m
[32m+[m[32m      {{ svg_data | safe }}[m
[32m+[m[32m    </div>[m
[32m+[m[32m  </div>[m
[32m+[m
[32m+[m[32m  <script>[m
[32m+[m[32m    // Abre o di√°logo de impress√£o automaticamente[m
[32m+[m[32m    window.addEventListener('load', ()=>{[m
[32m+[m[32m      setTimeout(()=>{[m
[32m+[m[32m        try{ window.print(); }catch(e){}[m
[32m+[m[32m      }, 250);[m
[32m+[m[32m    });[m
[32m+[m[32m  </script>[m
[32m+[m[32m</body>[m
[32m+[m[32m</html>[m
[1mdiff --git a/Templates/registrar.html b/Templates/registrar.html[m
[1mnew file mode 100644[m
[1mindex 0000000..179e716[m
[1m--- /dev/null[m
[1m+++ b/Templates/registrar.html[m
[36m@@ -0,0 +1,154 @@[m
[32m+[m[32m{% extends "base.html" %}[m
[32m+[m
[32m+[m[32m{% block title %}Cadastrar Produto - Tabacaria{% endblock %}[m
[32m+[m
[32m+[m[32m{% block content %}[m
[32m+[m[32m<div class="header">[m
[32m+[m[32m    <img src="{{ url_for('static', filename='Images/Logo_tabacaria.png') }}" alt="Logo" class="logo">[m
[32m+[m[32m    <div>[m
[32m+[m[32m        <h1>Cadastrar Novo Produto</h1>[m
[32m+[m[32m        <p>Preencha os dados do produto</p>[m
[32m+[m[32m    </div>[m
[32m+[m[32m</div>[m
[32m+[m
[32m+[m[32m<div class="panel">[m
[32m+[m[32m    <h2>Cadastro de Produto</h2>[m
[32m+[m
[32m+[m[32m    <form id="form-produto" class="animated-form">[m
[32m+[m[32m        <div class="form-row">[m
[32m+[m[32m            <div class="form-group">[m
[32m+[m[32m                <label for="nome">Nome do Produto*</label>[m
[32m+[m[32m                <input id="nome" required>[m
[32m+[m[32m            </div>[m
[32m+[m[32m            <div class="form-group">[m
[32m+[m[32m                <label for="categoria">Categoria</label>[m
[32m+[m[32m                <input id="categoria">[m
[32m+[m[32m            </div>[m
[32m+[m[32m        </div>[m
[32m+[m
[32m+[m[32m        <div class="form-row">[m
[32m+[m[32m            <div class="form-group">[m
[32m+[m[32m                <label for="preco">Pre√ßo (R$)*</label>[m
[32m+[m[32m                <input id="preco" type="number" step="0.01" min="0" required>[m
[32m+[m[32m            </div>[m
[32m+[m[32m            <div class="form-group">[m
[32m+[m[32m                <label for="quantidade">Quantidade*</label>[m
[32m+[m[32m                <input id="quantidade" type="number" min="0" required>[m
[32m+[m[32m            </div>[m
[32m+[m[32m        </div>[m
[32m+[m
[32m+[m[32m        <div class="form-actions">[m
[32m+[m[32m            <button type="submit" class="btn btn-primary">[m
[32m+[m[32m                <i class="fas fa-save"></i> Salvar Produto[m
[32m+[m[32m            </button>[m
[32m+[m[32m            <button type="button" class="btn btn-secondary" onclick="window.location.href='/estoque'">[m
[32m+[m[32m                <i class="fas fa-arrow-left"></i> Voltar[m
[32m+[m[32m            </button>[m
[32m+[m[32m        </div>[m
[32m+[m[32m    </form>[m
[32m+[m
[32m+[m[32m    <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true"></div>[m
[32m+[m[32m</div>[m
[32m+[m[32m{% endblock %}[m
[32m+[m
[32m+[m[32m            <p id="mensagem" style="margin-top:14px"></p>[m
[32m+[m[32m        </div>[m
[32m+[m[32m    </div>[m
[32m+[m
[32m+[m[32m    <script src="{{ url_for('static', filename='js/common.js') }}"></script>[m
[32m+[m[32m    <script>[m
[32m+[m[32m    const API = '/api/clientes';[m
[32m+[m
[32m+[m[32m    // Formatar CPF automaticamente[m
[32m+[m[32m    document.getElementById('cpf').addEventListener('input', (e) => {[m
[32m+[m[32m        let value = e.target.value.replace(/\D/g, '');[m
[32m+[m[32m        if (value.length > 11) value = value.slice(0, 11);[m
[32m+[m[32m        if (value.length > 9) value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');[m
[32m+[m[32m        else if (value.length > 6) value = value.replace(/(\d{3})(\d{3})(\d{3})/, '$1.$2.$3');[m
[32m+[m[32m        else if (value.length > 3) value = value.replace(/(\d{3})(\d{3})/, '$1.$2');[m
[32m+[m[32m        e.target.value = value;[m
[32m+[m[32m    });[m
[32m+[m
[32m+[m[32m    // Formatar telefone automaticamente[m
[32m+[m[32m    document.getElementById('telefone').addEventListener('input', (e) => {[m
[32m+[m[32m        let value = e.target.value.replace(/\D/g, '');[m
[32m+[m[32m        if (value.length > 11) value = value.slice(0, 11);[m
[32m+[m[32m        if (value.length > 10) value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');[m
[32m+[m[32m        else if (value.length > 6) value = value.replace(/(\d{2})(\d{4})(\d+)/, '($1) $2-$3');[m
[32m+[m[32m        else if (value.length > 2) value = value.replace(/(\d{2})(\d+)/, '($1) $2');[m
[32m+[m[32m        e.target.value = value;[m
[32m+[m[32m    });[m
[32m+[m
[32m+[m[32m    document.getElementById('form-cliente').addEventListener('submit', async (e)=> {[m
[32m+[m[32m        e.preventDefault();[m
[32m+[m[41m        [m
[32m+[m[32m        const cliente = {[m
[32m+[m[32m            nome: document.getElementById('nome').value,[m
[32m+[m[32m            cpf: document.getElementById('cpf').value,[m
[32m+[m[32m            telefone: document.getElementById('telefone').value,[m
[32m+[m[32m            email: document.getElementById('email').value,[m
[32m+[m[32m            endereco: document.getElementById('endereco').value,[m
[32m+[m[32m            cidade: document.getElementById('cidade').value,[m
[32m+[m[32m            estado: document.getElementById('estado').value.toUpperCase(),[m
[32m+[m[32m            observacoes: document.getElementById('observacoes').value[m
[32m+[m[32m        };[m
[32m+[m
[32m+[m[32m        try {[m
[32m+[m[32m            const response = await fetch(API, {[m
[32m+[m[32m                method: 'POST',[m
[32m+[m[32m                headers: {'Content-Type': 'application/json'},[m
[32m+[m[32m                body: JSON.stringify(cliente)[m
[32m+[m[32m            });[m
[32m+[m
[32m+[m[32m            if (response.ok) {[m
[32m+[m[32m                showMessage('Cliente cadastrado com sucesso!', 'success');[m
[32m+[m[32m                setTimeout(() => window.location.href = '/clientes', 1500);[m
[32m+[m[32m            } else {[m
[32m+[m[32m                const error = await response.json();[m
[32m+[m[32m                showMessage(error.mensagem || 'Erro ao cadastrar cliente', 'error');[m
[32m+[m[32m            }[m
[32m+[m[32m        } catch(err) {[m
[32m+[m[32m            showMessage('Erro ao cadastrar cliente: ' + err.message, 'error');[m
[32m+[m[32m        }[m
[32m+[m[32m    });{[m
[32m+[m[32m      e.preventDefault();[m
[32m+[m
[32m+[m[32m      const nome = document.getElementById('nome').value.trim();[m
[32m+[m[32m      const categoria = document.getElementById('categoria').value.trim();[m
[32m+[m[32m      const preco = parseFloat(document.getElementById('preco').value) || 0;[m
[32m+[m[32m      const quantidade = parseInt(document.getElementById('quantidade').value) || 0;[m
[32m+[m[32m      const mensagem = document.getElementById('mensagem');[m
[32m+[m
[32m+[m[32m      if(!nome){[m
[32m+[m[32m        mensagem.textContent = "‚ùå O nome do produto √© obrigat√≥rio.";[m
[32m+[m[32m        mensagem.style.color = "red";[m
[32m+[m[32m        return;[m
[32m+[m[32m      }[m
[32m+[m
[32m+[m[32m      try {[m
[32m+[m[32m        const res = await fetch(API, {[m
[32m+[m[32m          method:'POST',[m
[32m+[m[32m          headers:{'Content-Type':'application/json'},[m
[32m+[m[32m          body: JSON.stringify({nome, categoria, preco, quantidade})[m
[32m+[m[32m        });[m
[32m+[m
[32m+[m[32m        const data = await res.json();[m
[32m+[m
[32m+[m[32m        if(res.ok){[m
[32m+[m[32m          mensagem.textContent = "‚úÖ " + (data.mensagem || 'Produto registrado com sucesso.');[m
[32m+[m[32m          mensagem.style.color = "green";[m
[32m+[m[32m          document.getElementById('form-produto').reset();[m
[32m+[m[32m        } else {[m
[32m+[m[32m          mensagem.textContent = "‚ùå " + (data.erro || "Erro ao registrar produto.");[m
[32m+[m[32m          mensagem.style.color = "red";[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m      } catch (err) {[m
[32m+[m[32m        mensagem.textContent = "‚ö†Ô∏è Erro de conex√£o com o servidor.";[m
[32m+[m[32m        mensagem.style.color = "red";[m
[32m+[m[32m      }[m
[32m+[m[32m    };[m
[32m+[m[32m    </script>[m
[32m+[m
[32m+[m[32m</body>[m
[32m+[m[32m</html>[m
[1mdiff --git a/Templates/registrar_cliente.html b/Templates/registrar_cliente.html[m
[1mnew file mode 100644[m
[1mindex 0000000..0c30c44[m
[1m--- /dev/null[m
[1m+++ b/Templates/registrar_cliente.html[m
[36m@@ -0,0 +1,124 @@[m
[32m+[m[32m{% extends "base.html" %}[m
[32m+[m
[32m+[m[32m{% block title %}Registrar Cliente - Tabacaria{% endblock %}[m
[32m+[m
[32m+[m[32m{% block content %}[m
[32m+[m[32m<div class="header">[m
[32m+[m[32m    <img src="{{ url_for('static', filename='Images/Logo_tabacaria.png') }}" alt="Logo" class="logo">[m
[32m+[m[32m    <div>[m
[32m+[m[32m        <h1 style="font-size:20px;">Registrar Novo Cliente</h1>[m
[32m+[m[32m        <p style="color:#999;margin-top:6px">Preencha os dados do cliente</p>[m
[32m+[m[32m    </div>[m
[32m+[m[32m</div>[m
[32m+[m
[32m+[m[32m<div class="panel">[m
[32m+[m[32m    <form id="form-cliente" class="form-panel">[m
[32m+[m[32m        <div class="form-row">[m
[32m+[m[32m            <div class="form-group">[m
[32m+[m[32m                <label for="nome">Nome *</label>[m
[32m+[m[32m                <input type="text" id="nome" required>[m
[32m+[m[32m            </div>[m
[32m+[m[32m            <div class="form-group">[m
[32m+[m[32m                <label for="cpf">CPF</label>[m
[32m+[m[32m                <input type="text" id="cpf" pattern="\d{3}\.?\d{3}\.?\d{3}-?\d{2}">[m
[32m+[m[32m            </div>[m
[32m+[m[32m        </div>[m
[32m+[m
[32m+[m[32m        <div class="form-row">[m
[32m+[m[32m            <div class="form-group">[m
[32m+[m[32m                <label for="telefone">Telefone *</label>[m
[32m+[m[32m                <input type="tel" id="telefone" required>[m
[32m+[m[32m            </div>[m
[32m+[m[32m            <div class="form-group">[m
[32m+[m[32m                <label for="email">E-mail</label>[m
[32m+[m[32m                <input type="email" id="email">[m
[32m+[m[32m            </div>[m
[32m+[m[32m        </div>[m
[32m+[m
[32m+[m[32m        <div class="form-group">[m
[32m+[m[32m            <label for="endereco">Endere√ßo</label>[m
[32m+[m[32m            <input type="text" id="endereco">[m
[32m+[m[32m        </div>[m
[32m+[m
[32m+[m[32m        <div class="form-row">[m
[32m+[m[32m            <div class="form-group">[m
[32m+[m[32m                <label for="cidade">Cidade</label>[m
[32m+[m[32m                <input type="text" id="cidade">[m
[32m+[m[32m            </div>[m
[32m+[m[32m            <div class="form-group">[m
[32m+[m[32m                <label for="estado">Estado</label>[m
[32m+[m[32m                <input type="text" id="estado" maxlength="2" style="text-transform: uppercase;">[m
[32m+[m[32m            </div>[m
[32m+[m[32m        </div>[m
[32m+[m
[32m+[m[32m        <div class="form-group">[m
[32m+[m[32m            <label for="observacoes">Observa√ß√µes</label>[m
[32m+[m[32m            <textarea id="observacoes" rows="3"></textarea>[m
[32m+[m[32m        </div>[m
[32m+[m
[32m+[m[32m        <div class="btn-group">[m
[32m+[m[32m            <button type="submit" class="btn btn-primary">Cadastrar Cliente</button>[m
[32m+[m[32m            <button type="button" class="btn btn-secondary" onclick="window.location.href='/clientes'">Voltar</button>[m
[32m+[m[32m        </div>[m
[32m+[m[32m    </form>[m
[32m+[m[32m</div>[m
[32m+[m
[32m+[m[32m<script>[m
[32m+[m[32mdocument.getElementById('form-cliente').addEventListener('submit', async (e) => {[m
[32m+[m[32m    e.preventDefault();[m
[32m+[m[41m    [m
[32m+[m[32m    const cliente = {[m
[32m+[m[32m        nome: document.getElementById('nome').value.trim(),[m
[32m+[m[32m        cpf: document.getElementById('cpf').value.trim(),[m
[32m+[m[32m        telefone: document.getElementById('telefone').value.trim(),[m
[32m+[m[32m        email: document.getElementById('email').value.trim(),[m
[32m+[m[32m        endereco: document.getElementById('endereco').value.trim(),[m
[32m+[m[32m        cidade: document.getElementById('cidade').value.trim(),[m
[32m+[m[32m        estado: document.getElementById('estado').value.trim().toUpperCase(),[m
[32m+[m[32m        observacoes: document.getElementById('observacoes').value.trim()[m
[32m+[m[32m    };[m
[32m+[m[41m    [m
[32m+[m[32m    try {[m
[32m+[m[32m        const res = await fetch('/api/clientes', {[m
[32m+[m[32m            method: 'POST',[m
[32m+[m[32m            headers: { 'Content-Type': 'application/json' },[m
[32m+[m[32m            body: JSON.stringify(cliente)[m
[32m+[m[32m        });[m
[32m+[m[41m        [m
[32m+[m[32m        const data = await res.json();[m
[32m+[m[41m        [m
[32m+[m[32m        if (res.ok) {[m
[32m+[m[32m            alert('Cliente cadastrado com sucesso!');[m
[32m+[m[32m            window.location.href = '/clientes';[m
[32m+[m[32m        } else {[m
[32m+[m[32m            alert(data.erro || 'Erro ao cadastrar cliente');[m
[32m+[m[32m        }[m
[32m+[m[32m    } catch (err) {[m
[32m+[m[32m        console.error(err);[m
[32m+[m[32m        alert('Erro ao cadastrar cliente. Tente novamente.');[m
[32m+[m[32m    }[m
[32m+[m[32m});[m
[32m+[m
[32m+[m[32m// Formatar CPF automaticamente[m
[32m+[m[32mdocument.getElementById('cpf').addEventListener('input', (e) => {[m
[32m+[m[32m    let value = e.target.value.replace(/\D/g, '');[m
[32m+[m[32m    if (value.length <= 11) {[m
[32m+[m[32m        value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");[m
[32m+[m[32m        e.target.value = value;[m
[32m+[m[32m    }[m
[32m+[m[32m});[m
[32m+[m
[32m+[m[32m// Formatar telefone automaticamente[m
[32m+[m[32mdocument.getElementById('telefone').addEventListener('input', (e) => {[m
[32m+[m[32m    let value = e.target.value.replace(/\D/g, '');[m
[32m+[m[32m    if (value.length <= 11) {[m
[32m+[m[32m        if (value.length === 11) {[m
[32m+[m[32m            value = value.replace(/(\d{2})(\d{5})(\d{4})/, "($1) $2-$3");[m
[32m+[m[32m        } else {[m
[32m+[m[32m            value = value.replace(/(\d{2})(\d{4})(\d{4})/, "($1) $2-$3");[m
[32m+[m[32m        }[m
[32m+[m[32m        e.target.value = value;[m
[32m+[m[32m    }[m
[32m+[m[32m});[m
[32m+[m[32m</script>[m
[32m+[m[32m{% endblock %}[m
\ No newline at end of file[m
[1mdiff --git a/Templates/sistema_estoque_marina.html b/Templates/sistema_estoque_marina.html[m
[1mnew file mode 100644[m
[1mindex 0000000..d8e83cc[m
[1m--- /dev/null[m
[1m+++ b/Templates/sistema_estoque_marina.html[m
[36m@@ -0,0 +1,118 @@[m
[32m+[m[32m{% extends "base.html" %}[m
[32m+[m
[32m+[m[32m{% block title %}Sistema de Gest√£o de Produtos{% endblock %}[m
[32m+[m
[32m+[m[32m{% block content %}[m
[32m+[m[32m<!-- Header -->[m
[32m+[m[32m<div class="header">[m
[32m+[m[32m    <img width="100px" src="{{ url_for('static', filename='Images/Logo_tabacaria.png') }}" alt="logo">[m
[32m+[m[32m    <div>[m
[32m+[m[32m        <h1>Gest√£o de Produtos</h1>[m
[32m+[m[32m        <p style="color: #999; margin-top: 5px;">Sistema de Invent√°rio com C√≥digo de Barras</p>[m
[32m+[m[32m    </div>[m
[32m+[m[32m    <div class="header-status">[m
[32m+[m[32m        <div class="status-item">[m
[32m+[m[32m            <div class="status-number" id="totalProducts">0</div>[m
[32m+[m[32m            <div class="status-label">Produtos</div>[m
[32m+[m[32m        </div>[m
[32m+[m[32m        <div class="status-item">[m
[32m+[m[32m            <div class="status-number" id="totalValue">R$ 0</div>[m
[32m+[m[32m            <div class="status-label">Valor Total</div>[m
[32m+[m[32m        </div>[m
[32m+[m[32m    </div>[m
[32m+[m[32m    <div class="header-actions">[m
[32m+[m[32m        <button class="btn btn-secondary" onclick="window.location.href='/registrar'">üì¶ Registrar</button>[m
[32m+[m[32m        <button class="btn btn-secondary" onclick="window.location.href='/estoque'">üìã Estoque</button>[m
[32m+[m[32m        <button class="btn btn-ghost" onclick="window.location.href='/venda'">üõçÔ∏è Nova Venda</button>[m
[32m+[m[32m        <button class="btn btn-ghost" onclick="window.location.href='/movimentacoes'">üìà Movimenta√ß√µes</button>[m
[32m+[m[32m    </div>[m
[32m+[m[32m    <button id="fullscreenBtn" class="btn-secondary" onclick="toggleFullScreen()" style="margin-left:12px; padding:10px 14px;">‚õ∂ Tela Cheia</button>[m
[32m+[m[32m</div>[m
[32m+[m
[32m+[m[32m<!-- Conte√∫do Principal -->[m
[32m+[m[32m<div class="main-content">[m
[32m+[m[32m    <!-- Cadastro de Produtos -->[m
[32m+[m[32m    <div class="panel">[m
[32m+[m[32m        <h2>üìù Cadastro de Produto</h2>[m
[32m+[m[32m        <div id="successMessage"></div>[m
[32m+[m[41m        [m
[32m+[m[32m        <div class="form-group">[m
[32m+[m[32m            <label>Nome do Produto *</label>[m
[32m+[m[32m            <input type="text" id="productName" placeholder="Ex: Camiseta Azul">[m
[32m+[m[32m        </div>[m
[32m+[m
[32m+[m[32m        <div class="form-group">[m
[32m+[m[32m            <label>Descri√ß√£o</label>[m
[32m+[m[32m            <textarea id="productDescription" placeholder="Descreva o produto..." rows="3"></textarea>[m
[32m+[m[32m        </div>[m
[32m+[m
[32m+[m[32m        <div class="form-row">[m
[32m+[m[32m            <div class="form-group">[m
[32m+[m[32m                <label>Pre√ßo (R$) *</label>[m
[32m+[m[32m                <input type="number" id="productPrice" placeholder="0.00" min="0" step="0.01">[m
[32m+[m[32m            </div>[m
[32m+[m[32m            <div class="form-group">[m
[32m+[m[32m                <label>Quantidade *</label>[m
[32m+[m[32m                <input type="number" id="productQuantity" placeholder="0" min="0">[m
[32m+[m[32m            </div>[m
[32m+[m[32m        </div>[m
[32m+[m
[32m+[m[32m        <div class="form-row">[m
[32m+[m[32m            <div class="form-group">[m
[32m+[m[32m                <label>Categoria</label>[m
[32m+[m[32m                <input type="text" id="productCategory" placeholder="Ex: Roupas">[m
[32m+[m[32m            </div>[m
[32m+[m[32m            <div class="form-group">[m
[32m+[m[32m                <label>Unidade de Medida *</label>[m
[32m+[m[32m                <select id="productUnit">[m
[32m+[m[32m                    <option value="">Selecione...</option>[m
[32m+[m[32m                    <option value="Unidade">Unidade</option>[m
[32m+[m[32m                    <option value="Caixa">Caixa</option>[m
[32m+[m[32m                    <option value="Pacote">Pacote</option>[m
[32m+[m[32m                </select>[m
[32m+[m[32m            </div>[m
[32m+[m[32m        </div>[m
[32m+[m
[32m+[m[32m        <div class="btn-group">[m
[32m+[m[32m            <button id="addBtn" class="btn-primary" onclick="addProduct()">+ Adicionar</button>[m
[32m+[m[32m            <button class="btn-secondary" onclick="clearForm()">Limpar</button>[m
[32m+[m[32m        </div>[m
[32m+[m[32m    </div>[m
[32m+[m
[32m+[m[32m    <!-- Lista de Produtos -->[m
[32m+[m[32m    <div class="panel">[m
[32m+[m[32m        <h2>üìä Produtos Cadastrados</h2>[m
[32m+[m[32m        <div id="products"></div>[m
[32m+[m[32m    </div>[m
[32m+[m[32m</div>[m
[32m+[m[32m{% endblock %}[m
[32m+[m
[32m+[m[32m{% block extra_js %}[m
[32m+[m[32m<script src="{{ url_for('static', filename='js/common.js') }}"></script>[m
[32m+[m[32m<script src="https://cdnjs.cloudflare.com/ajax/libs/jsbarcode/3.11.5/JsBarcode.all.min.js"></script>[m
[32m+[m[32m<script src="{{ url_for('static', filename='js/sistema_products.js') }}"></script>[m
[32m+[m[32m<script>[m
[32m+[m[32mfunction updateFullScreenButton() {[m
[32m+[m[32m    const btn = document.getElementById('fullscreenBtn');[m
[32m+[m[32m    const floating = document.getElementById('floatingFullscreen');[m
[32m+[m[32m    const doc = document;[m
[32m+[m[32m    const isFull = !!(doc.fullscreenElement || doc.webkitFullscreenElement || doc.mozFullScreenElement || doc.msFullscreenElement);[m
[32m+[m[32m    btn.textContent = isFull ? '‚§¢ Sair Tela Cheia' : '‚õ∂ Tela Cheia';[m
[32m+[m[32m    if (floating) floating.textContent = isFull ? '‚§¢' : '‚õ∂';[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m// Eventos para atualizar o texto do bot√£o quando o estado de fullscreen mudar[m
[32m+[m[32mdocument.addEventListener('fullscreenchange', updateFullScreenButton);[m
[32m+[m[32mdocument.addEventListener('webkitfullscreenchange', updateFullScreenButton);[m
[32m+[m[32mdocument.addEventListener('mozfullscreenchange', updateFullScreenButton);[m
[32m+[m[32mdocument.addEventListener('MSFullscreenChange', updateFullScreenButton);[m
[32m+[m
[32m+[m[32m// Inicializa ao carregar a p√°gina ‚Äî garante persist√™ncia vis√≠vel ap√≥s reload[m
[32m+[m[32mdocument.addEventListener('DOMContentLoaded', () => {[m
[32m+[m[32m    // Recarrega lista a partir do localStorage (j√° carregado acima)[m
[32m+[m[32m    renderProducts();[m
[32m+[m[32m    updateStats();[m
[32m+[m[32m    updateFullScreenButton();[m
[32m+[m[32m});[m
[32m+[m[32m</script>[m
[32m+[m[32m{% endblock %}[m
\ No newline at end of file[m
[1mdiff --git a/Templates/venda.html b/Templates/venda.html[m
[1mnew file mode 100644[m
[1mindex 0000000..14042d4[m
[1m--- /dev/null[m
[1m+++ b/Templates/venda.html[m
[36m@@ -0,0 +1,410 @@[m
[32m+[m[32m{% extends "base.html" %}[m
[32m+[m
[32m+[m[32m{% block title %}Registrar Venda{% endblock %}[m
[32m+[m
[32m+[m[32m{% block content %}[m
[32m+[m[32m<div class="header">[m
[32m+[m[32m    <img src="{{ url_for('static', filename='Images/Logo_tabacaria.png') }}" alt="Logo" class="logo">[m
[32m+[m[32m    <div>[m
[32m+[m[32m        <h1>Registrar Venda</h1>[m
[32m+[m[32m        <p class="muted">Selecione os produtos e quantidades para venda</p>[m
[32m+[m[32m    </div>[m
[32m+[m[32m</div>[m
[32m+[m
[32m+[m[32m<div class="panel sale-form">[m
[32m+[m[32m    <h2>Nova Venda</h2>[m
[32m+[m[32m    <div id="alertBox"></div>[m
[32m+[m
[32m+[m[32m    <form id="saleForm" autocomplete="off">[m
[32m+[m[32m        <div class="form-group">[m
[32m+[m[32m            <label>Cliente</label>[m
[32m+[m[32m            <div style="display:flex; gap:12px; align-items:center; margin-bottom:8px">[m
[32m+[m[32m                <label><input type="radio" name="cliente_mode" value="existing" checked> Cliente cadastrado</label>[m
[32m+[m[32m                <label><input type="radio" name="cliente_mode" value="manual"> Digitar nome</label>[m
[32m+[m[32m            </div>[m
[32m+[m[32m            <div id="clienteExisting">[m
[32m+[m[32m                <div class="client-combobox" style="display:flex; align-items:center; gap:6px;">[m
[32m+[m[32m                    <div style="flex:1; position:relative">[m
[32m+[m[32m                        <input type="text" id="clienteNome" placeholder="Buscar cliente cadastrado (opcional)" autocomplete="off" style="width:100%; padding-right:28px">[m
[32m+[m[32m                        <!-- dropdown list -->[m
[32m+[m[32m                        <div id="clienteList" style="display:none; position:absolute; left:0; right:0; background:#fff; border:1px solid #e5e7eb; border-radius:8px; margin-top:4px; max-height:200px; overflow-y:auto; z-index:50"></div>[m
[32m+[m[32m                    </div>[m
[32m+[m[32m                    <button id="clienteToggle" type="button" aria-label="Abrir lista de clientes" style="width:32px; height:32px; border-radius:6px; border:1px solid #ddd; background:#fff; cursor:pointer">‚ñæ</button>[m
[32m+[m[32m                </div>[m
[32m+[m[32m                <div id="clienteDetails" style="display:none; margin-top:8px; background:#fafafa; border:1px solid #eee; padding:8px; border-radius:6px; font-size:13px"></div>[m
[32m+[m[32m            </div>[m
[32m+[m[32m            <div id="clienteManual" style="display:none">[m
[32m+[m[32m                <input type="text" id="clienteManualNome" placeholder="Digite o nome do cliente">[m
[32m+[m[32m            </div>[m
[32m+[m[32m        </div>[m
[32m+[m
[32m+[m[32m        <div class="items-list">[m
[32m+[m[32m            <div id="itemsList">[m
[32m+[m[32m                <div class="item-row">[m
[32m+[m[32m                    <select class="produto-select" required>[m
[32m+[m[32m                        <option value="">Selecione um produto...</option>[m
[32m+[m[32m                    </select>[m
[32m+[m[32m                    <input type="number" class="quantidade-input" min="1" placeholder="Qtd." required>[m
[32m+[m[32m                    <button type="button" class="btn btn-danger btn-remove" onclick="this.closest('.item-row').remove(); updatePreview()" style="display:none">&times;</button>[m
[32m+[m[32m                </div>[m
[32m+[m[32m            </div>[m
[32m+[m[32m            <button type="button" class="add-item-btn">+ Adicionar Item</button>[m
[32m+[m
[32m+[m[32m            <div class="preview-panel">[m
[32m+[m[32m                <div id="previewItems"></div>[m
[32m+[m[32m                <div class="preview-total">Total: R$ <span id="previewTotal">0,00</span></div>[m
[32m+[m[32m                <div style="margin-top:8px; display:flex; gap:10px; align-items:center;">[m
[32m+[m[32m                    <label style="font-size:13px; color:var(--muted);">Desconto %</label>[m
[32m+[m[32m                    <input type="text" id="discountPercent" placeholder="ex: -10 ou 10" style="width:100px; padding:8px; border-radius:8px; border:1px solid #e6edf3" />[m
[32m+[m[32m                    <div style="margin-left:auto; font-weight:700">Total com desconto: R$ <span id="previewTotalAfter">0,00</span></div>[m
[32m+[m[32m                </div>[m
[32m+[m[32m            </div>[m
[32m+[m[32m        </div>[m
[32m+[m
[32m+[m[32m        <div class="form-group">[m
[32m+[m[32m            <label>Observa√ß√µes</label>[m
[32m+[m[32m            <textarea id="observacao" rows="2" placeholder="Notas adicionais sobre a venda..."></textarea>[m
[32m+[m[32m        </div>[m
[32m+[m
[32m+[m[32m        <div style="text-align:right; margin-top:20px">[m
[32m+[m[32m            <button type="submit" class="btn btn-primary">Finalizar Venda</button>[m
[32m+[m[32m        </div>[m
[32m+[m[32m    </form>[m
[32m+[m[32m</div>[m
[32m+[m[32m{% endblock %}[m
[32m+[m
[32m+[m[32m{% block extra_js %}[m
[32m+[m[32m    <script>[m
[32m+[m[32m    // Global state[m
[32m+[m[32m    let produtos = [];[m
[32m+[m[32m    let revendedores = [];[m
[32m+[m[32m    let clientes = [];[m
[32m+[m[32m    let selectedRevendedor = null;[m
[32m+[m[32m    let selectedCliente = null;[m
[32m+[m
[32m+[m[32m    function showAlert(message, success=true) {[m
[32m+[m[32m        const box = document.getElementById('alertBox');[m
[32m+[m[32m        box.innerHTML = `<div class="alert ${success?'alert-success':'alert-danger'}">${message}</div>`;[m
[32m+[m[32m        setTimeout(() => box.innerHTML = '', 6000);[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    async function loadProdutos() {[m
[32m+[m[32m        try {[m
[32m+[m[32m            const res = await fetch('/api/produtos');[m
[32m+[m[32m            if (!res.ok) throw new Error('Falha ao carregar produtos');[m
[32m+[m[32m            produtos = await res.json();[m
[32m+[m[32m            updateProdutoSelects();[m
[32m+[m[32m        } catch(err) {[m
[32m+[m[32m            console.error(err);[m
[32m+[m[32m            showAlert('Erro ao carregar produtos. Tente recarregar a p√°gina.', false);[m
[32m+[m[32m        }[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    async function loadClientes() {[m
[32m+[m[32m        try {[m
[32m+[m[32m            const res = await fetch('/api/clientes');[m
[32m+[m[32m            if (!res.ok) throw new Error('Falha ao carregar clientes');[m
[32m+[m[32m            clientes = await res.json();[m
[32m+[m[32m            console.log('loadClientes: carregados', clientes.length, 'clientes');[m
[32m+[m[32m        } catch(err) {[m
[32m+[m[32m            console.error('N√£o foi poss√≠vel carregar clientes', err);[m
[32m+[m[32m            clientes = [];[m
[32m+[m[32m        }[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    function updateProdutoSelects() {[m
[32m+[m[32m        document.querySelectorAll('.produto-select').forEach(select => {[m
[32m+[m[32m            const currentVal = select.value;[m
[32m+[m[32m            select.innerHTML = '<option value="">Selecione um produto...</option>' +[m
[32m+[m[32m                produtos.map(p => `<option value="${p.id_produto}" ${p.id_produto==currentVal?'selected':''}>${p.nome} (R$ ${p.preco.toFixed(2)})</option>`).join('');[m
[32m+[m[32m        });[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    function addItemRow() {[m
[32m+[m[32m        const row = document.createElement('div');[m
[32m+[m[32m        row.className = 'item-row';[m
[32m+[m[32m        row.innerHTML = `[m
[32m+[m[32m            <select class="produto-select" required>[m
[32m+[m[32m                <option value="">Selecione um produto...</option>[m
[32m+[m[32m                ${produtos.map(p => `<option value="${p.id_produto}">${p.nome} (R$ ${p.preco.toFixed(2)})</option>`).join('')}[m
[32m+[m[32m            </select>[m
[32m+[m[32m            <input type="number" class="quantidade-input" min="1" placeholder="Qtd." required>[m
[32m+[m[32m            <button type="button" class="btn btn-danger btn-remove" onclick="this.closest('.item-row').remove(); updatePreview()">&times;</button>[m
[32m+[m[32m        `;[m
[32m+[m[32m        document.getElementById('itemsList').appendChild(row);[m
[32m+[m[32m        const selects = document.querySelectorAll('.produto-select');[m
[32m+[m[32m        if (selects.length > 1) {[m
[32m+[m[32m            document.querySelectorAll('.btn-remove').forEach(btn => btn.style.display = '');[m
[32m+[m[32m        }[m
[32m+[m[32m        row.querySelector('select').addEventListener('change', updatePreview);[m
[32m+[m[32m        row.querySelector('input').addEventListener('input', updatePreview);[m
[32m+[m[32m        // mark listeners attached to avoid double-binding if we scan rows later[m
[32m+[m[32m        row.dataset.listenersAttached = '1';[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    function updatePreview() {[m
[32m+[m[32m        const items = [];[m
[32m+[m[32m        let total = 0;[m
[32m+[m[32m        document.querySelectorAll('.item-row').forEach(row => {[m
[32m+[m[32m            const select = row.querySelector('.produto-select');[m
[32m+[m[32m            const qty = parseInt(row.querySelector('.quantidade-input').value) || 0;[m
[32m+[m[32m            if (select.value && qty > 0) {[m
[32m+[m[32m                const produto = produtos.find(p => p.id_produto == select.value);[m
[32m+[m[32m                if (produto) {[m
[32m+[m[32m                    const subtotal = produto.preco * qty;[m
[32m+[m[32m                    items.push({ nome: produto.nome, quantidade: qty, preco: produto.preco, subtotal });[m
[32m+[m[32m                    total += subtotal;[m
[32m+[m[32m                }[m
[32m+[m[32m            }[m
[32m+[m[32m        });[m
[32m+[m[32m        document.getElementById('previewItems').innerHTML = items.map(item => `[m
[32m+[m[32m            <div class="preview-item"><div>${item.quantidade}x ${item.nome}</div><div>R$ ${item.subtotal.toFixed(2)}</div></div>[m
[32m+[m[32m        `).join('');[m
[32m+[m[32m        // compute discount if provided (accept negative like '-10' as 10%)[m
[32m+[m[32m        let discountPercent = 0;[m
[32m+[m[32m        const discountEl = document.getElementById('discountPercent');[m
[32m+[m[32m        if (discountEl) {[m
[32m+[m[32m            const raw = (discountEl.value || '').toString().trim();[m
[32m+[m[32m            if (raw !== '') {[m
[32m+[m[32m                const parsed = parseFloat(raw.replace(',', '.'));[m
[32m+[m[32m                if (!isNaN(parsed)) {[m
[32m+[m[32m                    discountPercent = Math.abs(parsed);[m
[32m+[m[32m                    if (discountPercent > 100) discountPercent = 100;[m
[32m+[m[32m                }[m
[32m+[m[32m            }[m
[32m+[m[32m        }[m
[32m+[m[32m        const discountAmount = total * (discountPercent / 100);[m
[32m+[m[32m        const totalAfter = Math.max(0, total - discountAmount);[m
[32m+[m[32m        document.getElementById('previewTotal').textContent = total.toFixed(2);[m
[32m+[m[32m        const afterEl = document.getElementById('previewTotalAfter');[m
[32m+[m[32m        if (afterEl) afterEl.textContent = totalAfter.toFixed(2);[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    document.addEventListener('submit', (e) => {}, true);[m
[32m+[m
[32m+[m[32m    document.getElementById('saleForm').addEventListener('submit', async (e) => {[m
[32m+[m[32m        e.preventDefault();[m
[32m+[m[32m        const items = [];[m
[32m+[m[32m        document.querySelectorAll('.item-row').forEach(row => {[m
[32m+[m[32m            const pid = row.querySelector('.produto-select').value;[m
[32m+[m[32m            const qty = parseInt(row.querySelector('.quantidade-input').value);[m
[32m+[m[32m            if (pid && qty > 0) items.push({ id_produto: parseInt(pid), quantidade: qty });[m
[32m+[m[32m        });[m
[32m+[m[32m        if (!items.length) { showAlert('Adicione pelo menos um item √† venda.', false); return; }[m
[32m+[m[32m        const payload = { items, observacao: document.getElementById('observacao').value.trim() };[m
[32m+[m[32m        // revendedor (opcional)[m
[32m+[m[32m        if (selectedRevendedor) {[m
[32m+[m[32m            payload.id_revendedor = selectedRevendedor.id_revendedor;[m
[32m+[m[32m        } else {[m
[32m+[m[32m            const revendedorEl = document.getElementById('revendedorNome');[m
[32m+[m[32m            const nomeRev = revendedorEl ? revendedorEl.value.trim() : '';[m
[32m+[m[32m            if (nomeRev) {[m
[32m+[m[32m                try {[m
[32m+[m[32m                    const res = await fetch('/api/revendedores', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({nome: nomeRev}) });[m
[32m+[m[32m                    if (!res.ok) throw new Error('Falha ao criar revendedor');[m
[32m+[m[32m                    const data = await res.json();[m
[32m+[m[32m                    payload.id_revendedor = data.id_revendedor;[m
[32m+[m[32m                } catch(err) {[m
[32m+[m[32m                    console.error(err);[m
[32m+[m[32m                    showAlert('Erro ao criar revendedor. Tente novamente.', false);[m
[32m+[m[32m                    return;[m
[32m+[m[32m                }[m
[32m+[m[32m            }[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        // cliente: prefer selectedCliente (existing) else manual name[m
[32m+[m[32m        if (selectedCliente) {[m
[32m+[m[32m            payload.id_cliente = selectedCliente.id_cliente;[m
[32m+[m[32m        } else {[m
[32m+[m[32m            const clienteManual = document.getElementById('clienteManualNome').value.trim();[m
[32m+[m[32m            if (clienteManual) payload.cliente_nome = clienteManual;[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        // compute totals and discount to include in payload[m
[32m+[m[32m        try {[m
[32m+[m[32m            let total = 0;[m
[32m+[m[32m            items.forEach(it => {[m
[32m+[m[32m                const p = produtos.find(pr => pr.id_produto == it.id_produto);[m
[32m+[m[32m                if (p) total += (p.preco || 0) * (it.quantidade || 0);[m
[32m+[m[32m            });[m
[32m+[m[32m            // parse discount (accept -10 or 10 meaning 10%)[m
[32m+[m[32m            let discountPercent = 0;[m
[32m+[m[32m            const discountEl = document.getElementById('discountPercent');[m
[32m+[m[32m            if (discountEl) {[m
[32m+[m[32m                const raw = (discountEl.value || '').toString().trim();[m
[32m+[m[32m                if (raw !== '') {[m
[32m+[m[32m                    const parsed = parseFloat(raw.replace(',', '.'));[m
[32m+[m[32m                    if (!isNaN(parsed)) {[m
[32m+[m[32m                        discountPercent = Math.abs(parsed);[m
[32m+[m[32m                        if (discountPercent > 100) discountPercent = 100;[m
[32m+[m[32m                    }[m
[32m+[m[32m                }[m
[32m+[m[32m            }[m
[32m+[m[32m            const discountAmount = total * (discountPercent / 100);[m
[32m+[m[32m            const totalAfter = Math.max(0, total - discountAmount);[m
[32m+[m[32m            payload.discount_percent = discountPercent;[m
[32m+[m[32m            payload.total = parseFloat(totalAfter.toFixed(2));[m
[32m+[m[32m        } catch (err) {[m
[32m+[m[32m            console.error('Erro ao calcular total/discount:', err);[m
[32m+[m[32m        }[m
[32m+[m[32m        try {[m
[32m+[m[32m            const res = await fetch('/api/vendas', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });[m
[32m+[m[32m            const data = await res.json(); if (!res.ok) { showAlert(data.erro || 'Falha ao registrar venda.', false); return; }[m
[32m+[m[32m            showAlert(`Venda #${data.id_venda} registrada com sucesso!`);[m
[32m+[m[32m            document.querySelectorAll('.item-row').forEach((row,idx)=>{ if(idx===0){ row.querySelector('select').value=''; row.querySelector('input').value=''; } else row.remove(); });[m
[32m+[m[32m            const obsEl = document.getElementById('observacao'); if (obsEl) obsEl.value='';[m
[32m+[m[32m            const revEl = document.getElementById('revendedorNome'); if (revEl) revEl.value='';[m
[32m+[m[32m            selectedRevendedor=null; updatePreview();[m
[32m+[m[32m        } catch(err) { console.error(err); showAlert('Erro ao comunicar com o servidor.', false); }[m
[32m+[m[32m    });[m
[32m+[m
[32m+[m[32m    document.addEventListener('click', (e)=>{ if (e.target.matches('.add-item-btn')) addItemRow(); });[m
[32m+[m
[32m+[m[32m    async function loadRevendedores() {[m
[32m+[m[32m        try { const res = await fetch('/api/revendedores'); if (!res.ok) throw new Error(); revendedores = await res.json(); } catch(e){ revendedores = []; }[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    // revendedor fields are optional in the form; guard access so missing elements don't break the script[m
[32m+[m[32m    const revendedorInput = document.getElementById('revendedorNome');[m
[32m+[m[32m    const revendedorList = document.getElementById('revendedorList');[m
[32m+[m[32m    if (revendedorInput && revendedorList) {[m
[32m+[m[32m        revendedorInput.addEventListener('input', () => {[m
[32m+[m[32m            const val = revendedorInput.value.trim().toLowerCase(); if(!val){ revendedorList.style.display='none'; selectedRevendedor=null; return; }[m
[32m+[m[32m            const matches = revendedores.filter(r => r.nome.toLowerCase().includes(val)).slice(0,5);[m
[32m+[m[32m            if(!matches.length){ revendedorList.style.display='none'; selectedRevendedor=null; return; }[m
[32m+[m[32m            revendedorList.innerHTML = matches.map(r=>`<div class="typeahead-item" style="padding:8px 12px; cursor:pointer; border-bottom:1px solid #f3f3f3" onclick="selectRevendedor(${r.id_revendedor}, '${r.nome.replace("'","\\'")}')">${r.nome}</div>`).join('');[m
[32m+[m[32m            revendedorList.style.display='block';[m
[32m+[m[32m        });[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    // Client typeahead[m
[32m+[m[32m    const clienteInput = document.getElementById('clienteNome');[m
[32m+[m[32m    const clienteList = document.getElementById('clienteList');[m
[32m+[m[32m    const clienteManualInput = document.getElementById('clienteManualNome');[m
[32m+[m[32m    document.getElementsByName('cliente_mode').forEach(r => r.addEventListener('change', (e)=>{[m
[32m+[m[32m        if (e.target.value === 'existing') { document.getElementById('clienteExisting').style.display=''; document.getElementById('clienteManual').style.display='none'; }[m
[32m+[m[32m        else { document.getElementById('clienteExisting').style.display='none'; document.getElementById('clienteManual').style.display=''; selectedCliente=null; clienteList.style.display='none'; }[m
[32m+[m[32m    }));[m
[32m+[m
[32m+[m[32m    clienteInput.addEventListener('input', ()=>{[m
[32m+[m[32m        const val = clienteInput.value.trim().toLowerCase();[m
[32m+[m[32m        if(!val){ clienteList.style.display='none'; selectedCliente=null; return; }[m
[32m+[m[32m        const matches = clientes.filter(c => (c.nome||'').toLowerCase().includes(val)).slice(0,6);[m
[32m+[m[32m        if(!matches.length){[m
[32m+[m[32m            clienteList.innerHTML = '<div style="padding:8px 12px;color:#666">Nenhum cliente encontrado</div>';[m
[32m+[m[32m            clienteList.style.display='block';[m
[32m+[m[32m            selectedCliente=null; return;[m
[32m+[m[32m        }[m
[32m+[m[32m        // build list with clickable rows[m
[32m+[m[32m        clienteList.innerHTML = matches.map(c=>`<div class="typeahead-item" tabindex="0" style="padding:8px 12px; cursor:pointer; border-bottom:1px solid #f3f3f3" data-id="${c.id_cliente}" data-nome="${(c.nome||'').replace("'","\\'")}">${c.nome}</div>`).join('');[m
[32m+[m[32m        clienteList.style.display='block';[m
[32m+[m[32m        // attach keyboard/click handlers[m
[32m+[m[32m        clienteList.querySelectorAll('.typeahead-item').forEach(it=>{[m
[32m+[m[32m            it.addEventListener('click', ()=> selectCliente(it.dataset.id, it.dataset.nome));[m
[32m+[m[32m            it.addEventListener('keydown', (ev)=>{ if(ev.key==='Enter') selectCliente(it.dataset.id, it.dataset.nome); });[m
[32m+[m[32m        });[m
[32m+[m[32m    });[m
[32m+[m
[32m+[m[32m    function selectCliente(id,nome){[m
[32m+[m[32m        selectedCliente={id_cliente:parseInt(id),nome};[m
[32m+[m[32m        clienteInput.value=nome;[m
[32m+[m[32m        clienteList.style.display='none';[m
[32m+[m[32m        // load full cliente info and display[m
[32m+[m[32m        loadAndFillClient(parseInt(id));[m
[32m+[m[32m        // close toggle state[m
[32m+[m[32m        dropdownOpen = false; clienteToggle.textContent = '‚ñæ';[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    // Load cliente details and show in panel[m
[32m+[m[32m    async function loadAndFillClient(id){[m
[32m+[m[32m        try{[m
[32m+[m[32m            const res = await fetch(`/api/clientes/${id}`);[m
[32m+[m[32m            if(!res.ok) throw new Error('Cliente n√£o encontrado');[m
[32m+[m[32m            const c = await res.json();[m
[32m+[m[32m            const details = document.getElementById('clienteDetails');[m
[32m+[m[32m            details.innerHTML = `[m
[32m+[m[32m                <div style="font-weight:700">${c.nome || ''}</div>[m
[32m+[m[32m                <div>CPF: ${c.cpf || '-'}</div>[m
[32m+[m[32m                <div>Telefone: ${c.telefone || '-'}</div>[m
[32m+[m[32m                <div>E-mail: ${c.email || '-'}</div>[m
[32m+[m[32m                <div>${(c.endereco|| '-')}, ${(c.cidade||'-')} ${(c.estado||'')}</div>[m
[32m+[m[32m            `;[m
[32m+[m[32m            details.style.display = '';[m
[32m+[m[32m            // store selectedCliente with full data[m
[32m+[m[32m            selectedCliente = c;[m
[32m+[m[32m        }catch(err){ console.error(err); }[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    // Unified click handler that safely hides optional typeahead lists when clicking outside.[m
[32m+[m[32m    document.addEventListener('click',(e)=>{[m
[32m+[m[32m        try {[m
[32m+[m[32m            if (revendedorList && revendedorInput && !revendedorList.contains(e.target) && e.target !== revendedorInput) revendedorList.style.display = 'none';[m
[32m+[m[32m        } catch(_){}[m
[32m+[m[32m        try {[m
[32m+[m[32m            if (clienteList && clienteInput && !clienteList.contains(e.target) && e.target !== clienteInput) clienteList.style.display = 'none';[m
[32m+[m[32m        } catch(_){}[m
[32m+[m[32m    });[m
[32m+[m
[32m+[m[32m    function selectRevendedor(id,nome){ selectedRevendedor={id_revendedor:id,nome}; if(revendedorInput) revendedorInput.value=nome; if(revendedorList) revendedorList.style.display='none'; }[m
[32m+[m
[32m+[m[32m    // keyboard support: Enter selects first match[m
[32m+[m[32m    clienteInput.addEventListener('keydown', (e)=>{[m
[32m+[m[32m        if(e.key === 'Enter'){[m
[32m+[m[32m            if(clienteList.style.display === 'block'){[m
[32m+[m[32m                e.preventDefault();[m
[32m+[m[32m                const first = clienteList.querySelector('.typeahead-item');[m
[32m+[m[32m                if(first){[m
[32m+[m[32m                    first.click();[m
[32m+[m[32m                } else {[m
[32m+[m[32m                    // try exact match[m
[32m+[m[32m                    const val = clienteInput.value.trim().toLowerCase();[m
[32m+[m[32m                    const exact = clientes.find(c => (c.nome||'').toLowerCase() === val);[m
[32m+[m[32m                    if(exact) selectCliente(exact.id_cliente, exact.nome);[m
[32m+[m[32m                }[m
[32m+[m[32m            } else {[m
[32m+[m[32m                // if no dropdown visible, try to find exact[m
[32m+[m[32m                const val = clienteInput.value.trim().toLowerCase();[m
[32m+[m[32m                const exact = clientes.find(c => (c.nome||'').toLowerCase() === val);[m
[32m+[m[32m                if(exact){ e.preventDefault(); selectCliente(exact.id_cliente, exact.nome); }[m
[32m+[m[32m            }[m
[32m+[m[32m        }[m
[32m+[m[32m    });[m
[32m+[m
[32m+[m[32m    // arrow toggle behaviour[m
[32m+[m[32m    const clienteToggle = document.getElementById('clienteToggle');[m
[32m+[m[32m    let dropdownOpen = false;[m
[32m+[m[32m    clienteToggle.addEventListener('click', ()=>{[m
[32m+[m[32m        if(dropdownOpen){ clienteList.style.display='none'; dropdownOpen=false; clienteToggle.textContent='‚ñæ'; return; }[m
[32m+[m[32m        // show first N clients[m
[32m+[m[32m        const matches = clientes.slice(0,12);[m
[32m+[m[32m        if(!matches.length){ clienteList.innerHTML = '<div style="padding:8px 12px;color:#666">Nenhum cliente cadastrado</div>'; clienteList.style.display='block'; clienteToggle.textContent='‚ñ¥'; dropdownOpen=true; return; }[m
[32m+[m[32m        clienteList.innerHTML = matches.map(c=>`<div class="typeahead-item" tabindex="0" style="padding:8px 12px; cursor:pointer; border-bottom:1px solid #f3f3f3" data-id="${c.id_cliente}" data-nome="${(c.nome||'').replace("'","\\'")}">${c.nome}</div>`).join('');[m
[32m+[m[32m        clienteList.style.display='block'; clienteToggle.textContent='‚ñ¥'; dropdownOpen=true;[m
[32m+[m[32m        clienteList.querySelectorAll('.typeahead-item').forEach(it=>{[m
[32m+[m[32m            it.addEventListener('click', ()=> selectCliente(it.dataset.id, it.dataset.nome));[m
[32m+[m[32m            it.addEventListener('keydown', (ev)=>{ if(ev.key==='Enter') selectCliente(it.dataset.id, it.dataset.nome); });[m
[32m+[m[32m        });[m
[32m+[m[32m    });[m
[32m+[m
[32m+[m[32m    // Attach listeners to existing item rows (for the initial static row)[m
[32m+[m[32m    function attachItemRowListeners(){[m
[32m+[m[32m        document.querySelectorAll('.item-row').forEach(row=>{[m
[32m+[m[32m            // avoid attaching twice[m
[32m+[m[32m            if(row.dataset.listenersAttached) return;[m
[32m+[m[32m            const sel = row.querySelector('.produto-select');[m
[32m+[m[32m            const qty = row.querySelector('.quantidade-input');[m
[32m+[m[32m            if(sel) sel.addEventListener('change', updatePreview);[m
[32m+[m[32m            if(qty) qty.addEventListener('input', updatePreview);[m
[32m+[m[32m            row.dataset.listenersAttached = '1';[m
[32m+[m[32m        });[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    // Init: load data, then attach listeners so the initial row updates immediately[m
[32m+[m[32m    loadProdutos().then(()=> attachItemRowListeners());[m
[32m+[m[32m    loadRevendedores(); loadClientes();[m
[32m+[m
[32m+[m[32m    // discount input updates preview[m
[32m+[m[32m    const discountInputEl = document.getElementById('discountPercent');[m
[32m+[m[32m    if (discountInputEl) discountInputEl.addEventListener('input', updatePreview);[m
[32m+[m[32m</script>[m
[32m+[m[32m{% endblock %}[m
\ No newline at end of file[m
[1mdiff --git a/__pycache__/app.cpython-313.pyc b/__pycache__/app.cpython-313.pyc[m
[1mnew file mode 100644[m
[1mindex 0000000..2654879[m
Binary files /dev/null and b/__pycache__/app.cpython-313.pyc differ
[1mdiff --git a/app.py b/app.py[m
[1mnew file mode 100644[m
[1mindex 0000000..b79f18a[m
[1m--- /dev/null[m
[1m+++ b/app.py[m
[36m@@ -0,0 +1,1046 @@[m
[32m+[m[32mfrom flask import send_file[m
[32m+[m[32mfrom flask import Flask, render_template, request, jsonify[m
[32m+[m[32mimport sqlite3[m
[32m+[m[32mimport os[m
[32m+[m[32mimport barcode[m
[32m+[m[32mfrom barcode.writer import ImageWriter[m
[32m+[m[32mfrom reportlab.pdfgen import canvas[m
[32m+[m[32mfrom reportlab.lib.pagesizes import mm[m
[32m+[m[32mfrom reportlab.lib.units import mm[m
[32m+[m[32mimport io[m
[32m+[m
[32m+[m[32mapp = Flask(__name__)[m
[32m+[m
[32m+[m[32m@app.route('/imprimir_etiqueta/<int:id_produto>')[m
[32m+[m[32mdef imprimir_etiqueta(id_produto):[m
[32m+[m[32m    try:[m
[32m+[m[32m        # Conex√£o com o banco de dados[m
[32m+[m[32m        conn = get_db()[m
[32m+[m[32m        cur = conn.cursor()[m
[32m+[m[32m        cur.execute("SELECT nome, codigo_barras FROM produtos WHERE id_produto=?", (id_produto,))[m
[32m+[m[32m        produto = cur.fetchone()[m
[32m+[m[32m        conn.close()[m
[32m+[m
[32m+[m[32m        if not produto:[m
[32m+[m[32m            app.logger.error(f"Produto n√£o encontrado: {id_produto}")[m
[32m+[m[32m            return "Produto n√£o encontrado", 404[m
[32m+[m
[32m+[m[32m        nome, codigo_barras = produto[m
[32m+[m
[32m+[m[32m        # Validar e formatar o c√≥digo de barras[m
[32m+[m[32m        if not isinstance(codigo_barras, str):[m
[32m+[m[32m            codigo_barras = str(codigo_barras)[m
[32m+[m[32m        codigo_barras = codigo_barras.strip()[m
[32m+[m
[32m+[m[32m        # Gerar o c√≥digo de barras em SVG[m
[32m+[m[32m        from barcode import Code128[m
[32m+[m[32m        from barcode.writer import SVGWriter[m
[32m+[m[41m        [m
[32m+[m[32m        # Configurar o writer SVG para um resultado mais compacto[m
[32m+[m[32m        writer = SVGWriter()[m
[32m+[m[32m        writer.set_options({[m
[32m+[m[32m            'module_width': 0.4,[m
[32m+[m[32m            'module_height': 15.0,[m
[32m+[m[32m            'quiet_zone': 3.0,[m
[32m+[m[32m            'font_size': 10,[m
[32m+[m[32m            'text_distance': 5.0,[m
[32m+[m[32m            'background': 'white'[m
[32m+[m[32m        })[m
[32m+[m[41m        [m
[32m+[m[32m        # Gerar SVG em mem√≥ria[m
[32m+[m[32m        ean = Code128(codigo_barras, writer=writer)[m
[32m+[m[32m        svg_data = ean.render()[m
[32m+[m
[32m+[m[32m        # Criar PDF em mem√≥ria usando svglib para converter SVG para PDF[m
[32m+[m[32m        from svglib.svglib import svg2rlg[m
[32m+[m[32m        from reportlab.graphics import renderPDF[m
[32m+[m[32m        import tempfile[m
[32m+[m
[32m+[m[32m        # Criar arquivo SVG tempor√°rio em mem√≥ria[m
[32m+[m[32m        with tempfile.NamedTemporaryFile(suffix='.svg', delete=False, mode='w+') as f:[m
[32m+[m[32m            f.write(svg_data)[m
[32m+[m[32m            temp_svg = f.name[m
[32m+[m
[32m+[m[32m        try:[m
[32m+[m[32m            # Converter SVG para PDF[m
[32m+[m[32m            drawing = svg2rlg(temp_svg)[m
[32m+[m[41m            [m
[32m+[m[32m            # Criar PDF em mem√≥ria[m
[32m+[m[32m            buffer = io.BytesIO()[m
[32m+[m[32m            largura, altura = 50 * mm, 30 * mm[m
[32m+[m[41m            [m
[32m+[m[32m            # Ajustar escala do desenho para caber na etiqueta[m
[32m+[m[32m            scale_x = (40 * mm) / drawing.width[m
[32m+[m[32m            scale_y = (20 * mm) / drawing.height[m
[32m+[m[32m            scale = min(scale_x, scale_y)[m
[32m+[m[32m            drawing.scale(scale, scale)[m
[32m+[m[41m            [m
[32m+[m[32m            # Centralizar na etiqueta[m
[32m+[m[32m            drawing.translate([m
[32m+[m[32m                ((largura - drawing.width * scale) / 2),[m
[32m+[m[32m                ((altura - drawing.height * scale) / 2)[m
[32m+[m[32m            )[m
[32m+[m[41m            [m
[32m+[m[32m            renderPDF.drawToFile(drawing, buffer)[m
[32m+[m[32m            buffer.seek(0)[m
[32m+[m[41m            [m
[32m+[m[32m            return send_file([m
[32m+[m[32m                buffer,[m
[32m+[m[32m                as_attachment=True,[m
[32m+[m[32m                download_name=f"etiqueta_{codigo_barras}.pdf",[m
[32m+[m[32m                mimetype='application/pdf'[m
[32m+[m[32m            )[m
[32m+[m[32m        finally:[m
[32m+[m[32m            # Limpar arquivo tempor√°rio[m
[32m+[m[32m            try:[m
[32m+[m[32m                os.unlink(temp_svg)[m
[32m+[m[32m            except:[m
[32m+[m[32m                pass[m
[32m+[m
[32m+[m[32m    except Exception as e:[m
[32m+[m[32m        app.logger.error(f"Erro ao gerar etiqueta para produto {id_produto}: {str(e)}")[m
[32m+[m[32m        return jsonify({"error": "Erro ao gerar etiqueta", "details": str(e)}), 500[m
[32m+[m
[32m+[m
[32m+[m[32m@app.route('/imprimir_etiqueta_html/<int:id_produto>')[m
[32m+[m[32mdef imprimir_etiqueta_html(id_produto):[m
[32m+[m[32m    try:[m
[32m+[m[32m        # Renderiza uma p√°gina simples com o c√≥digo de barras em SVG[m
[32m+[m[32m        conn = get_db()[m
[32m+[m[32m        cur = conn.cursor()[m
[32m+[m[32m        cur.execute("SELECT nome, codigo_barras FROM produtos WHERE id_produto=?", (id_produto,))[m
[32m+[m[32m        produto = cur.fetchone()[m
[32m+[m[32m        conn.close()[m
[32m+[m
[32m+[m[32m        if not produto:[m
[32m+[m[32m            return "Produto n√£o encontrado", 404[m
[32m+[m
[32m+[m[32m        nome, codigo_barras = produto[m
[32m+[m
[32m+[m[32m        # Validar e formatar o c√≥digo de barras[m
[32m+[m[32m        if not isinstance(codigo_barras, str):[m
[32m+[m[32m            codigo_barras = str(codigo_barras)[m
[32m+[m[32m        codigo_barras = codigo_barras.strip()[m
[32m+[m
[32m+[m[32m        # Gerar o c√≥digo de barras em SVG[m
[32m+[m[32m        from barcode import Code128[m
[32m+[m[32m        from barcode.writer import SVGWriter[m
[32m+[m[41m        [m
[32m+[m[32m        # Configurar o writer SVG para um resultado mais compacto[m
[32m+[m[32m        writer = SVGWriter()[m
[32m+[m[32m        writer.set_options({[m
[32m+[m[32m            'module_width': 0.4,[m
[32m+[m[32m            'module_height': 15.0,[m
[32m+[m[32m            'quiet_zone': 3.0,[m
[32m+[m[32m            'font_size': 10,[m
[32m+[m[32m            'text_distance': 5.0,[m
[32m+[m[32m            'background': 'white'[m
[32m+[m[32m        })[m
[32m+[m[41m        [m
[32m+[m[32m        # Gerar SVG em mem√≥ria[m
[32m+[m[32m        ean = Code128(codigo_barras, writer=writer)[m
[32m+[m[32m        svg_data = ean.render()[m
[32m+[m
[32m+[m[32m        # Retornar o template com o SVG[m
[32m+[m[32m        return render_template('print_label.html',[m[41m [m
[32m+[m[32m                            nome=nome,[m[41m [m
[32m+[m[32m                            codigo_barras=codigo_barras,[m
[32m+[m[32m                            svg_data=svg_data)[m
[32m+[m
[32m+[m[32m    except Exception as e:[m
[32m+[m[32m        app.logger.error(f"Erro ao gerar etiqueta HTML para produto {id_produto}: {str(e)}")[m
[32m+[m[32m        return f"Erro ao gerar etiqueta: {str(e)}", 500[m
[32m+[m
[32m+[m[32m# Configura√ß√µes da aplica√ß√£o[m
[32m+[m[32mDB = 'estoque_tabacaria.db'[m
[32m+[m[32mBARCODE_DIR = os.path.join('static', 'barcodes')[m
[32m+[m[32mos.makedirs(BARCODE_DIR, exist_ok=True)[m
[32m+[m
[32m+[m[32mdef ensure_schema():[m
[32m+[m[32m    """Create required tables if they don't exist"""[m
[32m+[m[32m    conn = sqlite3.connect(DB)[m
[32m+[m[32m    cur = conn.cursor()[m
[32m+[m[41m    [m
[32m+[m[32m    # clientes[m[41m [m
[32m+[m[32m    cur.execute('''[m
[32m+[m[32m        CREATE TABLE IF NOT EXISTS clientes ([m
[32m+[m[32m            id_cliente INTEGER PRIMARY KEY AUTOINCREMENT,[m
[32m+[m[32m            nome TEXT NOT NULL,[m
[32m+[m[32m            cpf TEXT UNIQUE,[m
[32m+[m[32m            telefone TEXT,[m
[32m+[m[32m            email TEXT,[m
[32m+[m[32m            endereco TEXT,[m
[32m+[m[32m            cidade TEXT,[m
[32m+[m[32m            estado TEXT,[m
[32m+[m[32m            observacoes TEXT,[m
[32m+[m[32m            ultima_compra TIMESTAMP,[m
[32m+[m[32m            criado_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP,[m
[32m+[m[32m            atualizado_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP[m
[32m+[m[32m        )[m
[32m+[m[32m    ''')[m
[32m+[m
[32m+[m[32m    # vendas: sale header[m
[32m+[m[32m    cur.execute('''[m
[32m+[m[32m        CREATE TABLE IF NOT EXISTS vendas ([m
[32m+[m[32m            id_venda INTEGER PRIMARY KEY AUTOINCREMENT,[m
[32m+[m[32m            id_revendedor INTEGER,[m
[32m+[m[32m            data_venda TIMESTAMP DEFAULT CURRENT_TIMESTAMP,[m
[32m+[m[32m            observacao TEXT,[m
[32m+[m[32m            FOREIGN KEY(id_revendedor) REFERENCES revendedores(id_revendedor)[m
[32m+[m[32m        )[m
[32m+[m[32m    ''')[m
[32m+[m
[32m+[m[32m    # venda_items: items per sale[m
[32m+[m[32m    cur.execute('''[m
[32m+[m[32m        CREATE TABLE IF NOT EXISTS venda_items ([m
[32m+[m[32m            id_item INTEGER PRIMARY KEY AUTOINCREMENT,[m
[32m+[m[32m            id_venda INTEGER NOT NULL,[m
[32m+[m[32m            id_produto INTEGER NOT NULL,[m
[32m+[m[32m            quantidade INTEGER NOT NULL,[m
[32m+[m[32m            preco_unitario REAL,[m
[32m+[m[32m            FOREIGN KEY(id_venda) REFERENCES vendas(id_venda),[m
[32m+[m[32m            FOREIGN KEY(id_produto) REFERENCES produtos(id_produto)[m
[32m+[m[32m        )[m
[32m+[m[32m    ''')[m
[32m+[m
[32m+[m[32m    # logs / audit trail with enhanced detail[m
[32m+[m[32m    cur.execute('''[m
[32m+[m[32m        CREATE TABLE IF NOT EXISTS logs ([m
[32m+[m[32m            id_log INTEGER PRIMARY KEY AUTOINCREMENT,[m
[32m+[m[32m            criado_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP,[m
[32m+[m[32m            acao TEXT NOT NULL,[m
[32m+[m[32m            tipo TEXT CHECK(tipo IN ('venda', 'entrada', 'saida', 'produto', 'sistema')) NOT NULL,[m
[32m+[m[32m            quantidade INTEGER,[m
[32m+[m[32m            valor REAL,[m
[32m+[m[32m            produto_id INTEGER,[m
[32m+[m[32m            detalhe TEXT,[m
[32m+[m[32m            FOREIGN KEY(produto_id) REFERENCES produtos(id_produto)[m
[32m+[m[32m        )[m
[32m+[m[32m    ''')[m
[32m+[m
[32m+[m[32m    conn.commit()[m
[32m+[m[32m    conn.close()[m
[32m+[m
[32m+[m[32m# Ensure schema on startup[m
[32m+[m[32mensure_schema()[m
[32m+[m
[32m+[m[32m# ===== Fun√ß√£o para conectar ao banco de dados =====[m
[32m+[m[32mdef get_db():[m
[32m+[m[32m    conn = sqlite3.connect(DB)[m
[32m+[m[32m    conn.row_factory = sqlite3.Row[m
[32m+[m[32m    return conn[m
[32m+[m
[32m+[m[32m# ===== P√°gina inicial =====[m
[32m+[m[32m@app.route('/')[m
[32m+[m[32mdef index():[m
[32m+[m[32m    return render_template('index.html')[m
[32m+[m
[32m+[m[32m# ===== P√°gina de registrar produtos =====[m
[32m+[m[32m@app.route('/registrar')[m
[32m+[m[32mdef registrar():[m
[32m+[m[32m    return render_template('registrar.html')[m
[32m+[m
[32m+[m[32m# ===== P√°gina de clientes =====[m
[32m+[m[32m@app.route('/clientes')[m
[32m+[m[32mdef clientes():[m
[32m+[m[32m    return render_template('clientes.html')[m
[32m+[m
[32m+[m
[32m+[m[32m@app.route('/venda')[m
[32m+[m[32mdef venda():[m
[32m+[m[32m    return render_template('venda.html')[m
[32m+[m
[32m+[m[32m# ===== P√°gina de estoque =====[m
[32m+[m[32m@app.route('/estoque')[m
[32m+[m[32mdef estoque():[m
[32m+[m[32m    return render_template('estoque.html')[m
[32m+[m
[32m+[m
[32m+[m[32m@app.route('/movimentacoes')[m
[32m+[m[32mdef movimentacoes_page():[m
[32m+[m[32m    return render_template('movimentacoes.html')[m
[32m+[m
[32m+[m[32m# ===== API para listar clientes =====[m
[32m+[m[32m@app.route('/api/clientes', methods=['GET'])[m
[32m+[m[32mdef listar_clientes():[m
[32m+[m[32m    conn = get_db()[m
[32m+[m[32m    cur = conn.execute("SELECT * FROM clientes ORDER BY nome")[m
[32m+[m[32m    clientes = [dict(row) for row in cur.fetchall()][m
[32m+[m[32m    conn.close()[m
[32m+[m[32m    return jsonify(clientes)[m
[32m+[m
[32m+[m[32m# ===== API para adicionar cliente =====[m
[32m+[m[32m@app.route('/api/clientes', methods=['POST'])[m
[32m+[m[32mdef adicionar_cliente():[m
[32m+[m[32m    data = request.json[m
[32m+[m
[32m+[m[32m    nome = data.get('nome', '').strip()[m
[32m+[m[32m    cpf = data.get('cpf', '').strip()[m
[32m+[m[32m    telefone = data.get('telefone', '').strip()[m
[32m+[m[32m    email = data.get('email', '').strip()[m
[32m+[m[32m    endereco = data.get('endereco', '').strip()[m
[32m+[m[32m    cidade = data.get('cidade', '').strip()[m
[32m+[m[32m    estado = data.get('estado', '').strip()[m
[32m+[m[32m    observacoes = data.get('observacoes', '').strip()[m
[32m+[m
[32m+[m[32m    if not nome:[m
[32m+[m[32m        return jsonify({"erro": "O nome do cliente √© obrigat√≥rio."}), 400[m
[32m+[m
[32m+[m[32m    conn = get_db()[m
[32m+[m[32m    cur = conn.cursor()[m
[32m+[m
[32m+[m[32m    try:[m
[32m+[m[32m        cur.execute("""[m
[32m+[m[32m            INSERT INTO clientes ([m
[32m+[m[32m                nome, cpf, telefone, email,[m[41m [m
[32m+[m[32m                endereco, cidade, estado, observacoes[m
[32m+[m[32m            )[m
[32m+[m[32m            VALUES (?, ?, ?, ?, ?, ?, ?, ?)[m
[32m+[m[32m        """, (nome, cpf, telefone, email, endereco, cidade, estado, observacoes))[m
[32m+[m[32m        conn.commit()[m
[32m+[m[32m        cliente_id = cur.lastrowid[m
[32m+[m
[32m+[m[32m        return jsonify({[m
[32m+[m[32m            "mensagem": "Cliente registrado com sucesso!",[m
[32m+[m[32m            "id_cliente": cliente_id[m
[32m+[m[32m        })[m
[32m+[m
[32m+[m[32m    except sqlite3.IntegrityError:[m
[32m+[m[32m        return jsonify({"erro": "CPF j√° cadastrado."}), 400[m
[32m+[m[32m    finally:[m
[32m+[m[32m        conn.close()[m
[32m+[m
[32m+[m[32m# ===== API para buscar cliente =====[m
[32m+[m[32m@app.route('/api/clientes/<int:id_cliente>', methods=['GET'])[m
[32m+[m[32mdef buscar_cliente(id_cliente):[m
[32m+[m[32m    conn = get_db()[m
[32m+[m[32m    cur = conn.execute("SELECT * FROM clientes WHERE id_cliente=?", (id_cliente,))[m
[32m+[m[32m    cliente = cur.fetchone()[m
[32m+[m[32m    conn.close()[m
[32m+[m
[32m+[m[32m    if cliente is None:[m
[32m+[m[32m        return jsonify({"erro": "Cliente n√£o encontrado"}), 404[m
[32m+[m
[32m+[m[32m    return jsonify(dict(cliente))[m
[32m+[m
[32m+[m[32m# ===== API para atualizar cliente =====[m
[32m+[m[32m@app.route('/api/clientes/<int:id_cliente>', methods=['PUT'])[m
[32m+[m[32mdef atualizar_cliente(id_cliente):[m
[32m+[m[32m    data = request.json[m
[32m+[m
[32m+[m[32m    nome = data.get('nome', '').strip()[m
[32m+[m[32m    cpf = data.get('cpf', '').strip()[m
[32m+[m[32m    telefone = data.get('telefone', '').strip()[m
[32m+[m[32m    email = data.get('email', '').strip()[m
[32m+[m[32m    endereco = data.get('endereco', '').strip()[m
[32m+[m[32m    cidade = data.get('cidade', '').strip()[m
[32m+[m[32m    estado = data.get('estado', '').strip()[m
[32m+[m[32m    observacoes = data.get('observacoes', '').strip()[m
[32m+[m
[32m+[m[32m    if not nome:[m
[32m+[m[32m        return jsonify({"erro": "O nome do cliente √© obrigat√≥rio."}), 400[m
[32m+[m
[32m+[m[32m    conn = get_db()[m
[32m+[m[32m    cur = conn.cursor()[m
[32m+[m
[32m+[m[32m    try:[m
[32m+[m[32m        cur.execute("""[m
[32m+[m[32m            UPDATE clientes[m[41m [m
[32m+[m[32m            SET nome=?, cpf=?, telefone=?, email=?,[m
[32m+[m[32m                endereco=?, cidade=?, estado=?, observacoes=?,[m
[32m+[m[32m                atualizado_em=CURRENT_TIMESTAMP[m
[32m+[m[32m            WHERE id_cliente=?[m
[32m+[m[32m        """, (nome, cpf, telefone, email, endereco, cidade, estado, observacoes, id_cliente))[m
[32m+[m[32m        conn.commit()[m
[32m+[m
[32m+[m[32m        if cur.rowcount == 0:[m
[32m+[m[32m            return jsonify({"erro": "Cliente n√£o encontrado"}), 404[m
[32m+[m
[32m+[m[32m        return jsonify({"mensagem": "Cliente atualizado com sucesso!"})[m
[32m+[m
[32m+[m[32m    except sqlite3.IntegrityError:[m
[32m+[m[32m        return jsonify({"erro": "CPF j√° cadastrado para outro cliente."}), 400[m
[32m+[m[32m    finally:[m
[32m+[m[32m        conn.close()[m
[32m+[m
[32m+[m[32m# ===== API para excluir cliente =====[m
[32m+[m[32m@app.route('/api/clientes/<int:id_cliente>', methods=['DELETE'])[m
[32m+[m[32mdef excluir_cliente(id_cliente):[m
[32m+[m[32m    conn = get_db()[m
[32m+[m[32m    cur = conn.cursor()[m
[32m+[m[41m    [m
[32m+[m[32m    cur.execute("DELETE FROM clientes WHERE id_cliente=?", (id_cliente,))[m
[32m+[m[32m    conn.commit()[m
[32m+[m[41m    [m
[32m+[m[32m    if cur.rowcount == 0:[m
[32m+[m[32m        conn.close()[m
[32m+[m[32m        return jsonify({"erro": "Cliente n√£o encontrado"}), 404[m
[32m+[m
[32m+[m[32m    conn.close()[m
[32m+[m[32m    return jsonify({"mensagem": "Cliente exclu√≠do com sucesso!"})[m
[32m+[m
[32m+[m[32m# ===== API para listar produtos =====[m
[32m+[m[32m@app.route('/api/produtos', methods=['GET'])[m
[32m+[m[32mdef listar_produtos():[m
[32m+[m[32m    conn = get_db()[m
[32m+[m[32m    cur = conn.execute("SELECT * FROM produtos ORDER BY nome")[m
[32m+[m[32m    produtos = [dict(row) for row in cur.fetchall()][m
[32m+[m[32m    conn.close()[m
[32m+[m[32m    return jsonify(produtos)[m
[32m+[m
[32m+[m[32m# ===== Rota para registrar cliente =====[m
[32m+[m[32m@app.route('/api/clientes', methods=['POST'])[m
[32m+[m[32mdef registrar_cliente():[m
[32m+[m[32m    try:[m
[32m+[m[32m        data = request.json[m
[32m+[m[32m        nome = data.get('nome', '').strip()[m
[32m+[m[32m        cpf = data.get('cpf', '').strip()[m
[32m+[m[32m        telefone = data.get('telefone', '').strip()[m
[32m+[m[32m        email = data.get('email', '').strip()[m
[32m+[m[32m        endereco = data.get('endereco', '').strip()[m
[32m+[m[32m        cidade = data.get('cidade', '').strip()[m
[32m+[m[32m        estado = data.get('estado', '').strip()[m
[32m+[m[32m        observacoes = data.get('observacoes', '').strip()[m
[32m+[m
[32m+[m[32m        if not nome:[m
[32m+[m[32m            return jsonify({"erro": "O nome do cliente √© obrigat√≥rio."}), 400[m
[32m+[m
[32m+[m[32m        conn = get_db()[m
[32m+[m[32m        cur = conn.cursor()[m
[32m+[m[32m        cur.execute("""[m
[32m+[m[32m            INSERT INTO clientes (nome, cpf, telefone, email, endereco, cidade, estado, observacoes)[m
[32m+[m[32m            VALUES (?, ?, ?, ?, ?, ?, ?, ?)[m
[32m+[m[32m        """, (nome, cpf, telefone, email, endereco, cidade, estado, observacoes))[m
[32m+[m[32m        conn.commit()[m
[32m+[m[32m        cliente_id = cur.lastrowid[m
[32m+[m
[32m+[m[32m        return jsonify({[m
[32m+[m[32m            "mensagem": "Cliente registrado com sucesso!",[m
[32m+[m[32m            "id_cliente": cliente_id[m
[32m+[m[32m        })[m
[32m+[m
[32m+[m[32m    except sqlite3.IntegrityError:[m
[32m+[m[32m        return jsonify({"erro": "CPF j√° cadastrado."}), 400[m
[32m+[m[32m    finally:[m
[32m+[m[32m        conn.close()[m
[32m+[m
[32m+[m
[32m+[m[32m# ===== API para adicionar produto =====[m
[32m+[m[32m@app.route('/api/produtos', methods=['POST'])[m
[32m+[m[32mdef adicionar_produto():[m
[32m+[m[32m    data = request.json[m
[32m+[m
[32m+[m[32m    nome = data.get('nome', '').strip()[m
[32m+[m[32m    categoria = data.get('categoria', '').strip()[m
[32m+[m[32m    preco = float(data.get('preco', 0.0))[m
[32m+[m[32m    quantidade = int(data.get('quantidade', 0))[m
[32m+[m
[32m+[m[32m    if not nome:[m
[32m+[m[32m        return jsonify({"erro": "O nome do produto √© obrigat√≥rio."}), 400[m
[32m+[m
[32m+[m[32m    conn = get_db()[m
[32m+[m[32m    cur = conn.cursor()[m
[32m+[m[32m    cur.execute("""[m
[32m+[m[32m        INSERT INTO produtos (nome, categoria, preco, quantidade, codigo_barras)[m
[32m+[m[32m        VALUES (?, ?, ?, ?, ?)[m
[32m+[m[32m    """, (nome, categoria, preco, quantidade, 'TEMP'))[m
[32m+[m[32m    conn.commit()[m
[32m+[m[32m    pid = cur.lastrowid[m
[32m+[m
[32m+[m[32m    # Gerar c√≥digo de barras definitivo (ex: 789000 + id)[m
[32m+[m[32m    codigo_def = f"789000{pid:06d}"[m
[32m+[m[32m    conn.execute("UPDATE produtos SET codigo_barras=? WHERE id_produto=?", (codigo_def, pid))[m
[32m+[m[32m    conn.commit()[m
[32m+[m[32m    conn.close()[m
[32m+[m
[32m+[m[32m    # Gera√ß√£o do c√≥digo de barras[m
[32m+[m[32m    from barcode import Code128[m
[32m+[m[32m    from barcode.writer import ImageWriter[m
[32m+[m[32m    ean = Code128(codigo_def, writer=ImageWriter())[m
[32m+[m[32m    caminho = f'static/barcodes/{codigo_def}'[m
[32m+[m[32m    ean.save(caminho)[m
[32m+[m
[32m+[m[32m    return jsonify({[m
[32m+[m[32m        "mensagem": "Produto registrado com sucesso!",[m
[32m+[m[32m        "id_produto": pid,[m
[32m+[m[32m        "codigo_barras": codigo_def[m
[32m+[m[32m    }), 201[m
[32m+[m
[32m+[m
[32m+[m[32m@app.route('/api/produtos/<int:id_produto>', methods=['PUT'])[m
[32m+[m[32mdef atualizar_produto(id_produto):[m
[32m+[m[32m    data = request.json or {}[m
[32m+[m[32m    nome = data.get('nome', '').strip()[m
[32m+[m[32m    categoria = data.get('categoria', '').strip()[m
[32m+[m[32m    preco = float(data.get('preco', 0.0))[m
[32m+[m[32m    quantidade = int(data.get('quantidade', 0))[m
[32m+[m
[32m+[m[32m    if not nome:[m
[32m+[m[32m        return jsonify({"erro": "O nome do produto √© obrigat√≥rio."}), 400[m
[32m+[m
[32m+[m[32m    conn = get_db()[m
[32m+[m[32m    cur = conn.cursor()[m
[32m+[m[32m    cur.execute("SELECT id_produto FROM produtos WHERE id_produto=?", (id_produto,))[m
[32m+[m[32m    if not cur.fetchone():[m
[32m+[m[32m        conn.close()[m
[32m+[m[32m        return jsonify({"erro": "Produto n√£o encontrado."}), 404[m
[32m+[m
[32m+[m[32m    cur.execute("UPDATE produtos SET nome=?, categoria=?, preco=?, quantidade=? WHERE id_produto=?",[m
[32m+[m[32m                (nome, categoria, preco, quantidade, id_produto))[m
[32m+[m[32m    conn.commit()[m
[32m+[m[32m    conn.close()[m
[32m+[m[32m    return jsonify({"mensagem": "Produto atualizado com sucesso."})[m
[32m+[m
[32m+[m
[32m+[m[32m@app.route('/api/produtos/<int:id_produto>', methods=['DELETE'])[m
[32m+[m[32mdef deletar_produto(id_produto):[m
[32m+[m[32m    conn = get_db()[m
[32m+[m[32m    cur = conn.cursor()[m
[32m+[m[41m    [m
[32m+[m[32m    # Get product details before deletion for barcode cleanup[m
[32m+[m[32m    cur.execute("SELECT codigo_barras FROM produtos WHERE id_produto=?", (id_produto,))[m
[32m+[m[32m    produto = cur.fetchone()[m
[32m+[m[41m    [m
[32m+[m[32m    if not produto:[m
[32m+[m[32m        conn.close()[m
[32m+[m[32m        return jsonify({"erro": "Produto n√£o encontrado."}), 404[m
[32m+[m[41m    [m
[32m+[m[32m    try:[m
[32m+[m[32m        # Delete product[m
[32m+[m[32m        cur.execute("DELETE FROM produtos WHERE id_produto=?", (id_produto,))[m
[32m+[m[32m        conn.commit()[m
[32m+[m[41m        [m
[32m+[m[32m        # Clean up barcode images[m
[32m+[m[32m        codigo_barras = produto['codigo_barras'][m
[32m+[m[32m        barcode_path = os.path.join('static', 'barcodes', f"{codigo_barras}.png")[m
[32m+[m[32m        barcode_path_noext = os.path.join('static', 'barcodes', f"{codigo_barras}")[m
[32m+[m[41m        [m
[32m+[m[32m        if os.path.exists(barcode_path):[m
[32m+[m[32m            os.remove(barcode_path)[m
[32m+[m[32m        if os.path.exists(barcode_path_noext):[m
[32m+[m[32m            os.remove(barcode_path_noext)[m
[32m+[m[41m            [m
[32m+[m[32m        log_event('produto_removido', 'produto', produto_id=id_produto,[m[41m [m
[32m+[m[32m                 detalhe=f'Produto {id_produto} removido com c√≥digo de barras {codigo_barras}')[m
[32m+[m[41m            [m
[32m+[m[32m    except Exception as e:[m
[32m+[m[32m        conn.close()[m
[32m+[m[32m        return jsonify({"erro": f"Erro ao remover produto: {str(e)}"}), 500[m
[32m+[m[41m        [m
[32m+[m[32m    conn.close()[m
[32m+[m[32m    return jsonify({"mensagem": "Produto removido com sucesso."})[m
[32m+[m
[32m+[m
[32m+[m[32m@app.route('/registrar_cliente')[m
[32m+[m[32m@app.route('/clientes/novo')[m
[32m+[m[32mdef pagina_registrar_cliente():[m
[32m+[m[32m    return render_template('registrar_cliente.html')[m
[32m+[m
[32m+[m
[32m+[m[32m@app.route('/api/generate_barcode/<int:id_produto>', methods=['GET'])[m
[32m+[m[32mdef api_generate_barcode(id_produto):[m
[32m+[m[32m    """Gera o c√≥digo de barras em PNG com nome do produto."""[m
[32m+[m[32m    try:[m
[32m+[m[32m        conn = get_db()[m
[32m+[m[32m        cur = conn.cursor()[m
[32m+[m[32m        cur.execute("SELECT nome, codigo_barras FROM produtos WHERE id_produto=?", (id_produto,))[m
[32m+[m[32m        row = cur.fetchone()[m
[32m+[m[32m        conn.close()[m
[32m+[m
[32m+[m[32m        if not row:[m
[32m+[m[32m            return jsonify({"error": "Produto n√£o encontrado"}), 404[m
[32m+[m
[32m+[m[32m        nome, codigo_barras = row[m
[32m+[m
[32m+[m[32m        # Validar e formatar o c√≥digo de barras[m
[32m+[m[32m        if not isinstance(codigo_barras, str):[m
[32m+[m[32m            codigo_barras = str(codigo_barras)[m
[32m+[m[32m        codigo_barras = codigo_barras.strip()[m
[32m+[m
[32m+[m[32m        # Criar uma nova imagem para a etiqueta completa[m
[32m+[m[32m        from PIL import Image, ImageDraw, ImageFont[m
[32m+[m[32m        import os[m
[32m+[m
[32m+[m[32m        # Tamanho da etiqueta em pixels (5cm x 3cm em 300 DPI)[m
[32m+[m[32m        width = int(5 * 118.11)  # 5cm em pixels (300 DPI)[m
[32m+[m[32m        height = int(3 * 118.11)  # 3cm em pixels (300 DPI)[m
[32m+[m
[32m+[m[32m        # Criar imagem em branco[m
[32m+[m[32m        label = Image.new('RGB', (width, height), 'white')[m
[32m+[m[32m        draw = ImageDraw.Draw(label)[m
[32m+[m
[32m+[m[32m        # Carregar fonte[m
[32m+[m[32m        try:[m
[32m+[m[32m            font = ImageFont.truetype("arial.ttf", 30)[m
[32m+[m[32m        except:[m
[32m+[m[32m            font = ImageFont.load_default()[m
[32m+[m
[32m+[m[32m        # Desenhar o nome do produto[m
[32m+[m[32m        text_width = draw.textlength(nome, font=font)[m
[32m+[m[32m        text_x = (width - text_width) / 2[m
[32m+[m[32m        draw.text((text_x, 10), nome, fill='black', font=font)[m
[32m+[m
[32m+[m[32m        # Gerar o c√≥digo de barras[m
[32m+[m[32m        from barcode import Code128[m
[32m+[m[32m        from barcode.writer import ImageWriter[m
[32m+[m[41m        [m
[32m+[m[32m        writer = ImageWriter()[m
[32m+[m[32m        writer.set_options({[m
[32m+[m[32m            'module_width': 0.6,[m
[32m+[m[32m            'module_height': 15.0,[m
[32m+[m[32m            'quiet_zone': 6.0,[m
[32m+[m[32m            'font_size': 10,[m
[32m+[m[32m            'text_distance': 5.0,[m
[32m+[m[32m            'background': 'white'[m
[32m+[m[32m        })[m
[32m+[m
[32m+[m[32m        # Gerar PNG do c√≥digo de barras[m
[32m+[m[32m        os.makedirs(os.path.join(app.static_folder, 'barcodes'), exist_ok=True)[m
[32m+[m[32m        temp_path = os.path.join(app.static_folder, 'barcodes', 'temp_' + codigo_barras)[m
[32m+[m[32m        ean = Code128(codigo_barras, writer=writer)[m
[32m+[m[32m        ean.save(temp_path)[m
[32m+[m
[32m+[m[32m        # Carregar o c√≥digo de barras gerado[m
[32m+[m[32m        barcode_img = Image.open(temp_path + '.png')[m
[32m+[m[41m        [m
[32m+[m[32m        # Redimensionar o c√≥digo de barras para caber na etiqueta[m
[32m+[m[32m        barcode_width = int(width * 0.8)  # 80% da largura da etiqueta[m
[32m+[m[32m        ratio = barcode_width / barcode_img.width[m
[32m+[m[32m        barcode_height = int(barcode_img.height * ratio)[m
[32m+[m[32m        barcode_img = barcode_img.resize((barcode_width, barcode_height))[m
[32m+[m
[32m+[m[32m        # Colar o c√≥digo de barras na etiqueta[m
[32m+[m[32m        barcode_x = (width - barcode_width) // 2[m
[32m+[m[32m        barcode_y = height - barcode_height - 10[m
[32m+[m[32m        label.paste(barcode_img, (barcode_x, barcode_y))[m
[32m+[m
[32m+[m[32m        # Salvar a etiqueta final[m
[32m+[m[32m        save_path = os.path.join(app.static_folder, 'barcodes', codigo_barras + '.png')[m
[32m+[m[32m        label.save(save_path, 'PNG')[m
[32m+[m
[32m+[m[32m        # Limpar arquivo tempor√°rio[m
[32m+[m[32m        try:[m
[32m+[m[32m            os.remove(temp_path + '.png')[m
[32m+[m[32m        except:[m
[32m+[m[32m            pass[m
[32m+[m
[32m+[m[32m        # Retornar o caminho relativo do arquivo PNG[m
[32m+[m[32m        return jsonify({[m
[32m+[m[32m            "path": f"/static/barcodes/{codigo_barras}.png",[m
[32m+[m[32m            "nome": nome[m
[32m+[m[32m        })[m
[32m+[m
[32m+[m[32m    except Exception as e:[m
[32m+[m[32m        app.logger.error(f"Erro ao gerar c√≥digo de barras para produto {id_produto}: {str(e)}")[m
[32m+[m[32m        return jsonify({[m
[32m+[m[32m            "error": "Erro ao gerar c√≥digo de barras",[m[41m [m
[32m+[m[32m            "details": str(e)[m
[32m+[m[32m        }), 500[m
[32m+[m
[32m+[m
[32m+[m[32mdef log_event(acao, tipo, quantidade=None, valor=None, produto_id=None, detalhe=None):[m
[32m+[m[32m    try:[m
[32m+[m[32m        conn = sqlite3.connect(DB)[m
[32m+[m[32m        cur = conn.cursor()[m
[32m+[m[32m        cur.execute('''[m
[32m+[m[32m            INSERT INTO logs (acao, tipo, quantidade, valor, produto_id, detalhe)[m
[32m+[m[32m            VALUES (?, ?, ?, ?, ?, ?)[m
[32m+[m[32m        ''', (acao, tipo, quantidade, valor, produto_id, detalhe))[m
[32m+[m[32m        conn.commit()[m
[32m+[m[32m        conn.close()[m
[32m+[m[32m    except Exception:[m
[32m+[m[32m        # best-effort logging, do not break main flow[m
[32m+[m[32m        pass[m
[32m+[m
[32m+[m
[32m+[m[32m@app.route('/api/revendedores', methods=['GET'])[m
[32m+[m[32mdef listar_revendedores():[m
[32m+[m[32m    conn = get_db()[m
[32m+[m[32m    cur = conn.execute('SELECT * FROM revendedores ORDER BY nome')[m
[32m+[m[32m    rows = [dict(r) for r in cur.fetchall()][m
[32m+[m[32m    conn.close()[m
[32m+[m[32m    return jsonify(rows)[m
[32m+[m
[32m+[m
[32m+[m[32m@app.route('/api/revendedores', methods=['POST'])[m
[32m+[m[32mdef criar_revendedor():[m
[32m+[m[32m    data = request.json or {}[m
[32m+[m[32m    nome = (data.get('nome') or '').strip()[m
[32m+[m[32m    if not nome:[m
[32m+[m[32m        return jsonify({'erro': 'Nome √© obrigat√≥rio.'}), 400[m
[32m+[m[32m    contato = (data.get('contato') or '').strip()[m
[32m+[m[32m    telefone = (data.get('telefone') or '').strip()[m
[32m+[m[32m    email = (data.get('email') or '').strip()[m
[32m+[m[32m    endereco = (data.get('endereco') or '').strip()[m
[32m+[m[32m    notas = (data.get('notas') or '').strip()[m
[32m+[m[32m    try:[m
[32m+[m[32m        conn = get_db()[m
[32m+[m[32m        cur = conn.cursor()[m
[32m+[m[32m        cur.execute('''INSERT INTO revendedores (nome, contato, telefone, email, endereco, notas)[m
[32m+[m[32m                       VALUES (?, ?, ?, ?, ?, ?)''', (nome, contato or None, telefone or None, email or None, endereco or None, notas or None))[m
[32m+[m[32m        conn.commit()[m
[32m+[m[32m        rid = cur.lastrowid[m
[32m+[m[32m        conn.close()[m
[32m+[m[32m        # record creation in logs[m
[32m+[m[32m        log_event('revendedor_criado', 'sistema', detalhe=f'id={rid} nome={nome}')[m
[32m+[m[32m        return jsonify({'mensagem': 'Revendedor criado', 'id_revendedor': rid}), 201[m
[32m+[m[32m    except Exception as e:[m
[32m+[m[32m        return jsonify({'erro': 'Falha ao criar revendedor', 'detalhe': str(e)}), 500[m
[32m+[m
[32m+[m
[32m+[m[32m@app.route('/api/vendas', methods=['POST'])[m
[32m+[m[32mdef criar_venda():[m
[32m+[m[32m    data = request.json or {}[m
[32m+[m[32m    revendedor_id = data.get('id_revendedor')[m
[32m+[m[32m    cliente_id = data.get('id_cliente')[m
[32m+[m[32m    cliente_nome = data.get('cliente_nome')[m
[32m+[m[32m    items = data.get('items') or [][m
[32m+[m[32m    observacao = data.get('observacao')[m
[32m+[m
[32m+[m[32m    if not items or not isinstance(items, list):[m
[32m+[m[32m        return jsonify({'erro': 'Lista de itens √© obrigat√≥ria.'}), 400[m
[32m+[m
[32m+[m[32m    # validate items[m
[32m+[m[32m    errors = [][m
[32m+[m[32m    for idx, it in enumerate(items, start=1):[m
[32m+[m[32m        try:[m
[32m+[m[32m            pid = int(it.get('id_produto'))[m
[32m+[m[32m            qty = int(it.get('quantidade'))[m
[32m+[m[32m            if qty <= 0:[m
[32m+[m[32m                errors.append(f'Item {idx}: quantidade inv√°lida')[m
[32m+[m[32m        except Exception:[m
[32m+[m[32m            errors.append(f'Item {idx}: dados inv√°lidos')[m
[32m+[m
[32m+[m[32m    if errors:[m
[32m+[m[32m        return jsonify({'erro': 'Itens inv√°lidos', 'detalhes': errors}), 400[m
[32m+[m
[32m+[m[32m    conn = get_db()[m
[32m+[m[32m    cur = conn.cursor()[m
[32m+[m[32m    try:[m
[32m+[m[32m        # start transaction[m
[32m+[m[32m        cur.execute('BEGIN')[m
[32m+[m[32m        # optional revendedor existence check[m
[32m+[m[32m        if revendedor_id:[m
[32m+[m[32m            cur.execute('SELECT id_revendedor FROM revendedores WHERE id_revendedor=?', (revendedor_id,))[m
[32m+[m[32m            if not cur.fetchone():[m
[32m+[m[32m                conn.rollback(); conn.close()[m
[32m+[m[32m                return jsonify({'erro': 'Revendedor n√£o encontrado.'}), 404[m
[32m+[m
[32m+[m[32m        # optional cliente existence check[m
[32m+[m[32m        if cliente_id is not None:[m
[32m+[m[32m            cur.execute('SELECT id_cliente FROM clientes WHERE id_cliente=?', (cliente_id,))[m
[32m+[m[32m            if not cur.fetchone():[m
[32m+[m[32m                conn.rollback(); conn.close()[m
[32m+[m[32m                return jsonify({'erro': 'Cliente n√£o encontrado.'}), 404[m
[32m+[m
[32m+[m[32m        # Ensure vendas table has optional client columns[m
[32m+[m[32m        cur2 = conn.cursor()[m
[32m+[m[32m        cur2.execute("PRAGMA table_info('vendas')")[m
[32m+[m[32m        cols = [r['name'] for r in cur2.fetchall()][m
[32m+[m[32m        if 'id_cliente' not in cols:[m
[32m+[m[32m            cur2.execute('ALTER TABLE vendas ADD COLUMN id_cliente INTEGER')[m
[32m+[m[32m        if 'cliente_nome' not in cols:[m
[32m+[m[32m            cur2.execute("ALTER TABLE vendas ADD COLUMN cliente_nome TEXT")[m
[32m+[m[32m        # ensure discount and total columns exist so we can persist them when provided[m
[32m+[m[32m        if 'discount_percent' not in cols:[m
[32m+[m[32m            try:[m
[32m+[m[32m                cur2.execute('ALTER TABLE vendas ADD COLUMN discount_percent REAL')[m
[32m+[m[32m            except Exception:[m
[32m+[m[32m                pass[m
[32m+[m[32m        if 'total' not in cols:[m
[32m+[m[32m            try:[m
[32m+[m[32m                cur2.execute('ALTER TABLE vendas ADD COLUMN total REAL')[m
[32m+[m[32m            except Exception:[m
[32m+[m[32m                pass[m
[32m+[m
[32m+[m[32m        # create venda (include optional fields)[m
[32m+[m[32m        insert_cols = ['id_revendedor', 'observacao'][m
[32m+[m[32m        insert_vals = [revendedor_id, observacao][m
[32m+[m[32m        if cliente_id is not None:[m
[32m+[m[32m            insert_cols.append('id_cliente'); insert_vals.append(cliente_id)[m
[32m+[m[32m        if cliente_nome:[m
[32m+[m[32m            insert_cols.append('cliente_nome'); insert_vals.append(cliente_nome)[m
[32m+[m[32m        # optional financial fields[m
[32m+[m[32m        discount_percent = data.get('discount_percent')[m
[32m+[m[32m        total_final = data.get('total')[m
[32m+[m[32m        if discount_percent is not None:[m
[32m+[m[32m            try:[m
[32m+[m[32m                dp = float(discount_percent)[m
[32m+[m[32m                insert_cols.append('discount_percent'); insert_vals.append(dp)[m
[32m+[m[32m            except Exception:[m
[32m+[m[32m                pass[m
[32m+[m[32m        if total_final is not None:[m
[32m+[m[32m            try:[m
[32m+[m[32m                tf = float(total_final)[m
[32m+[m[32m                insert_cols.append('total'); insert_vals.append(tf)[m
[32m+[m[32m            except Exception:[m
[32m+[m[32m                pass[m
[32m+[m
[32m+[m[32m        cols_sql = ','.join(insert_cols)[m
[32m+[m[32m        qmarks = ','.join('?' for _ in insert_vals)[m
[32m+[m[32m        cur.execute(f'INSERT INTO vendas ({cols_sql}) VALUES ({qmarks})', tuple(insert_vals))[m
[32m+[m[32m        venda_id = cur.lastrowid[m
[32m+[m
[32m+[m[32m        # process each item: check stock and decrement[m
[32m+[m[32m        for it in items:[m
[32m+[m[32m            pid = int(it.get('id_produto'))[m
[32m+[m[32m            qty = int(it.get('quantidade'))[m
[32m+[m[32m            # get product and price[m
[32m+[m[32m            cur.execute('SELECT quantidade, preco FROM produtos WHERE id_produto=?', (pid,))[m
[32m+[m[32m            row = cur.fetchone()[m
[32m+[m[32m            if not row:[m
[32m+[m[32m                conn.rollback(); conn.close()[m
[32m+[m[32m                return jsonify({'erro': f'Produto {pid} n√£o encontrado.'}), 404[m
[32m+[m[32m            estoque_atual = row['quantidade'][m
[32m+[m[32m            preco_unit = row['preco'][m
[32m+[m[32m            if estoque_atual < qty:[m
[32m+[m[32m                conn.rollback(); conn.close()[m
[32m+[m[32m                return jsonify({'erro': f'Estoque insuficiente para produto {pid}. Dispon√≠vel: {estoque_atual}'}), 400[m
[32m+[m[32m            # decrement[m
[32m+[m[32m            cur.execute('UPDATE produtos SET quantidade = quantidade - ? WHERE id_produto=?', (qty, pid))[m
[32m+[m[32m            # insert item[m
[32m+[m[32m            cur.execute('INSERT INTO venda_items (id_venda, id_produto, quantidade, preco_unitario) VALUES (?, ?, ?, ?)', (venda_id, pid, qty, preco_unit))[m
[32m+[m
[32m+[m[32m        # Register a single movimentacao summarizing the venda (saida)[m
[32m+[m[32m        try:[m
[32m+[m[32m            total_qty = 0[m
[32m+[m[32m            first_pid = None[m
[32m+[m[32m            for idx, it in enumerate(items):[m
[32m+[m[32m                pid = int(it.get('id_produto'))[m
[32m+[m[32m                qty = int(it.get('quantidade'))[m
[32m+[m[32m                total_qty += qty[m
[32m+[m[32m                if idx == 0:[m
[32m+[m[32m                    first_pid = pid[m
[32m+[m[32m            if first_pid is None:[m
[32m+[m[32m                first_pid = items[0]['id_produto'] if items else None[m
[32m+[m[32m            # insert one movimentacao linking to a representative product and total quantity[m
[32m+[m[32m            if first_pid is not None:[m
[32m+[m[32m                cur.execute('INSERT INTO movimentacoes (id_produto, tipo, quantidade, observacao, data_mov) VALUES (?, ?, ?, ?, datetime("now"))',[m
[32m+[m[32m                            (first_pid, 'saida', total_qty, f'Venda #{venda_id}'))[m
[32m+[m[32m        except Exception:[m
[32m+[m[32m            # ignore mov insertion failures but continue[m
[32m+[m[32m            pass[m
[32m+[m
[32m+[m[32m        conn.commit()[m
[32m+[m[32m        conn.close()[m
[32m+[m[32m        log_event('venda_criada', 'venda', quantidade=len(items), detalhe=f'id_venda={venda_id} revendedor={revendedor_id}')[m
[32m+[m[32m        return jsonify({'mensagem': 'Venda registrada', 'id_venda': venda_id}), 201[m
[32m+[m[32m    except Exception as e:[m
[32m+[m[32m        conn.rollback(); conn.close()[m
[32m+[m[32m        return jsonify({'erro': 'Falha ao registrar venda', 'detalhe': str(e)}), 500[m
[32m+[m
[32m+[m
[32m+[m[32m@app.route('/api/vendas', methods=['GET'])[m
[32m+[m[32mdef listar_vendas():[m
[32m+[m[32m    limit = request.args.get('limit', type=int)[m
[32m+[m[32m    conn = get_db()[m
[32m+[m[32m    cur = conn.cursor()[m
[32m+[m[32m    q = '''SELECT v.id_venda, v.data_venda, v.observacao, r.id_revendedor, r.nome as revendedor_nome,[m
[32m+[m[32m                  v.id_cliente, COALESCE(c.nome, v.cliente_nome) as cliente_nome[m
[32m+[m[32m           FROM vendas v[m
[32m+[m[32m           LEFT JOIN revendedores r ON r.id_revendedor = v.id_revendedor[m
[32m+[m[32m           LEFT JOIN clientes c ON c.id_cliente = v.id_cliente[m
[32m+[m[32m           ORDER BY v.data_venda DESC'''[m
[32m+[m[32m    if limit and limit>0:[m
[32m+[m[32m        q = q + f' LIMIT {limit}'[m
[32m+[m[32m    cur.execute(q)[m
[32m+[m[32m    rows = cur.fetchall()[m
[32m+[m[32m    result = [][m
[32m+[m[32m    for r in rows:[m
[32m+[m[32m        result.append({[m
[32m+[m[32m            'id_venda': r[0], 'data_venda': r[1], 'observacao': r[2], 'id_revendedor': r[3], 'revendedor_nome': r[4], 'id_cliente': r[5], 'cliente_nome': r[6][m
[32m+[m[32m        })[m
[32m+[m[32m    conn.close()[m
[32m+[m[32m    return jsonify(result)[m
[32m+[m
[32m+[m
[32m+[m[32m@app.route('/api/vendas/<int:id_venda>', methods=['GET'])[m
[32m+[m[32mdef buscar_venda(id_venda):[m
[32m+[m[32m    conn = get_db()[m
[32m+[m[32m    cur = conn.cursor()[m
[32m+[m[32m    # select core fields and include optional columns if present[m
[32m+[m[32m    cur.execute("PRAGMA table_info('vendas')")[m
[32m+[m[32m    vcols = [r['name'] for r in cur.fetchall()][m
[32m+[m[32m    extra = [][m
[32m+[m[32m    if 'discount_percent' in vcols: extra.append('v.discount_percent')[m
[32m+[m[32m    if 'total' in vcols: extra.append('v.total')[m
[32m+[m[32m    extras_sql = (', ' + ', '.join(extra)) if extra else ''[m
[32m+[m[32m    sql = f"SELECT v.id_venda, v.data_venda, v.observacao, v.id_revendedor, v.id_cliente, COALESCE(c.nome, v.cliente_nome) as cliente_nome{extras_sql} FROM vendas v LEFT JOIN clientes c ON c.id_cliente = v.id_cliente WHERE v.id_venda=?"[m
[32m+[m[32m    cur.execute(sql, (id_venda,))[m
[32m+[m[32m    vh = cur.fetchone()[m
[32m+[m[32m    if not vh:[m
[32m+[m[32m        conn.close()[m
[32m+[m[32m        return jsonify({'erro': 'Venda n√£o encontrada'}), 404[m
[32m+[m[32m    venda = {[m
[32m+[m[32m        'id_venda': vh[0], 'data_venda': vh[1], 'observacao': vh[2], 'id_revendedor': vh[3], 'id_cliente': vh[4], 'cliente_nome': vh[5][m
[32m+[m[32m    }[m
[32m+[m[32m    idx = 6[m
[32m+[m[32m    if 'discount_percent' in vcols:[m
[32m+[m[32m        venda['discount_percent'] = vh[idx]; idx += 1[m
[32m+[m[32m    if 'total' in vcols:[m
[32m+[m[32m        venda['total'] = vh[idx]; idx += 1[m
[32m+[m[32m    cur.execute('''SELECT vi.id_item, vi.id_produto, vi.quantidade, vi.preco_unitario, p.nome as produto_nome[m
[32m+[m[32m                   FROM venda_items vi LEFT JOIN produtos p ON p.id_produto = vi.id_produto WHERE vi.id_venda=?''', (id_venda,))[m
[32m+[m[32m    items = [][m
[32m+[m[32m    for it in cur.fetchall():[m
[32m+[m[32m        items.append({'id_item': it[0], 'id_produto': it[1], 'quantidade': it[2], 'preco_unitario': it[3], 'produto_nome': it[4]})[m
[32m+[m[32m    venda['items'] = items[m
[32m+[m[32m    conn.close()[m
[32m+[m[32m    return jsonify(venda)[m
[32m+[m
[32m+[m
[32m+[m[32mdef validar_movimentacao_data(data):[m
[32m+[m[32m    errors = {}[m
[32m+[m[32m    # id_produto[m
[32m+[m[32m    try:[m
[32m+[m[32m        id_prod = int(data.get('id_produto'))[m
[32m+[m[32m        if id_prod <= 0:[m
[32m+[m[32m            errors['id_produto'] = 'Produto inv√°lido.'[m
[32m+[m[32m    except Exception:[m
[32m+[m[32m        errors['id_produto'] = 'Produto inv√°lido.'[m
[32m+[m
[32m+[m[32m    # tipo[m
[32m+[m[32m    tipo = (data.get('tipo') or '').strip()[m
[32m+[m[32m    if tipo not in ('entrada', 'saida'):[m
[32m+[m[32m        errors['tipo'] = "Tipo inv√°lido. Deve ser 'entrada' ou 'saida'."[m
[32m+[m
[32m+[m[32m    # quantidade[m
[32m+[m[32m    try:[m
[32m+[m[32m        quantidade = int(data.get('quantidade'))[m
[32m+[m[32m        if quantidade <= 0:[m
[32m+[m[32m            errors['quantidade'] = 'Quantidade deve ser maior que zero.'[m
[32m+[m[32m    except Exception:[m
[32m+[m[32m        errors['quantidade'] = 'Quantidade inv√°lida.'[m
[32m+[m
[32m+[m[32m    observacao = (data.get('observacao') or '').strip()[m
[32m+[m[32m    data_mov = data.get('data_mov')[m
[32m+[m
[32m+[m[32m    cleaned = {[m
[32m+[m[32m        'id_produto': id_prod if 'id_produto' not in errors else None,[m
[32m+[m[32m        'tipo': tipo,[m
[32m+[m[32m        'quantidade': quantidade if 'quantidade' not in errors else None,[m
[32m+[m[32m        'observacao': observacao,[m
[32m+[m[32m        'data_mov': data_mov[m
[32m+[m[32m    }[m
[32m+[m[32m    return cleaned, errors[m
[32m+[m
[32m+[m
[32m+[m[32m@app.route('/api/movimentacoes', methods=['GET'])[m
[32m+[m[32mdef listar_movimentacoes():[m
[32m+[m[32m    """List movimentacoes joined with product. Supports ?limit=n, q, start_date, end_date"""[m
[32m+[m[32m    limit = request.args.get('limit', type=int)[m
[32m+[m[32m    q_param = request.args.get('q', type=str)[m
[32m+[m[32m    start_date = request.args.get('start_date')[m
[32m+[m[32m    end_date = request.args.get('end_date')[m
[32m+[m
[32m+[m[32m    conn = get_db()[m
[32m+[m[32m    cur = conn.cursor()[m
[32m+[m[32m    base = '''SELECT m.id_mov, m.id_produto, m.tipo, m.quantidade, m.observacao, m.data_mov,[m
[32m+[m[32m                     p.nome as produto_nome[m
[32m+[m[32m              FROM movimentacoes m[m
[32m+[m[32m              LEFT JOIN produtos p ON p.id_produto = m.id_produto[m
[32m+[m[32m              WHERE 1=1'''[m
[32m+[m
[32m+[m[32m    params = [][m
[32m+[m[32m    if q_param:[m
[32m+[m[32m        base += ' AND (p.nome LIKE ? OR m.observacao LIKE ?)'[m
[32m+[m[32m        likeq = f'%{q_param}%'[m
[32m+[m[32m        params.extend([likeq, likeq])[m
[32m+[m[32m    if start_date:[m
[32m+[m[32m        base += ' AND m.data_mov >= ?'[m
[32m+[m[32m        params.append(start_date)[m
[32m+[m[32m    if end_date:[m
[32m+[m[32m        base += ' AND m.data_mov <= ?'[m
[32m+[m[32m        params.append(end_date)[m
[32m+[m
[32m+[m[32m    base += ' ORDER BY m.data_mov DESC'[m
[32m+[m[32m    if limit and limit > 0:[m
[32m+[m[32m        base += ' LIMIT ?'[m
[32m+[m[32m        params.append(limit)[m
[32m+[m
[32m+[m[32m    cur.execute(base, params)[m
[32m+[m[32m    rows = cur.fetchall()[m
[32m+[m[32m    conn.close()[m
[32m+[m[32m    result = [][m
[32m+[m[32m    for r in rows:[m
[32m+[m[32m        result.append({[m
[32m+[m[32m            'id_mov': r[0],[m
[32m+[m[32m            'id_produto': r[1],[m
[32m+[m[32m            'tipo': r[2],[m
[32m+[m[32m            'quantidade': r[3],[m
[32m+[m[32m            'observacao': r[4],[m
[32m+[m[32m            'data_mov': r[5],[m
[32m+[m[32m            'produto_nome': r[6][m
[32m+[m[32m        })[m
[32m+[m[32m    return jsonify(result)[m
[32m+[m
[32m+[m
[32m+[m[32m@app.route('/api/movimentacoes', methods=['POST'])[m
[32m+[m[32mdef criar_movimentacao():[m
[32m+[m[32m    data = request.json or {}[m
[32m+[m[32m    cleaned, errors = validar_movimentacao_data(data)[m
[32m+[m[32m    if errors:[m
[32m+[m[32m        return jsonify({'erro': 'Dados inv√°lidos', 'detalhes': errors}), 400[m
[32m+[m
[32m+[m[32m    conn = get_db()[m
[32m+[m[32m    cur = conn.cursor()[m
[32m+[m[32m    try:[m
[32m+[m[32m        # check product exists[m
[32m+[m[32m        cur.execute('SELECT quantidade FROM produtos WHERE id_produto=?', (cleaned['id_produto'],))[m
[32m+[m[32m        row = cur.fetchone()[m
[32m+[m[32m        if not row:[m
[32m+[m[32m            conn.close()[m
[32m+[m[32m            return jsonify({'erro': 'Produto n√£o encontrado.'}), 404[m
[32m+[m
[32m+[m[32m        # update stock[m
[32m+[m[32m        if cleaned['tipo'] == 'entrada':[m
[32m+[m[32m            cur.execute('UPDATE produtos SET quantidade = quantidade + ? WHERE id_produto=?', (cleaned['quantidade'], cleaned['id_produto']))[m
[32m+[m[32m        else:[m
[32m+[m[32m            # saida[m
[32m+[m[32m            estoque_atual = row['quantidade'][m
[32m+[m[32m            if estoque_atual < cleaned['quantidade']:[m
[32m+[m[32m                conn.close()[m
[32m+[m[32m                return jsonify({'erro': 'Estoque insuficiente.'}), 400[m
[32m+[m[32m            cur.execute('UPDATE produtos SET quantidade = quantidade - ? WHERE id_produto=?', (cleaned['quantidade'], cleaned['id_produto']))[m
[32m+[m
[32m+[m[32m        cur.execute('INSERT INTO movimentacoes (id_produto, tipo, quantidade, observacao, data_mov) VALUES (?, ?, ?, ?, ?)',[m
[32m+[m[32m                    (cleaned['id_produto'], cleaned['tipo'], cleaned['quantidade'], cleaned.get('observacao'), cleaned.get('data_mov') or None))[m
[32m+[m[32m        mov_id = cur.lastrowid[m
[32m+[m[32m        conn.commit()[m
[32m+[m[32m        # log[m
[32m+[m[32m        log_event('movimentacao_criada', cleaned['tipo'], quantidade=cleaned['quantidade'], produto_id=cleaned['id_produto'], detalhe=f'id_mov={mov_id}')[m
[32m+[m[32m    except Exception as e:[m
[32m+[m[32m        conn.rollback(); conn.close()[m
[32m+[m[32m        return jsonify({'erro': 'Falha ao registrar movimenta√ß√£o', 'detalhe': str(e)}), 500[m
[32m+[m[32m    conn.close()[m
[32m+[m[32m    return jsonify({'mensagem': 'Movimenta√ß√£o registrada', 'id_mov': mov_id}), 201[m
[32m+[m
[32m+[m
[32m+[m[32m@app.route('/api/movimentacoes/<int:id_mov>', methods=['DELETE'])[m
[32m+[m[32mdef deletar_movimentacao(id_mov):[m
[32m+[m[32m    conn = get_db()[m
[32m+[m[32m    cur = conn.cursor()[m
[32m+[m[32m    cur.execute('SELECT id_mov FROM movimentacoes WHERE id_mov=?', (id_mov,))[m
[32m+[m[32m    if not cur.fetchone():[m
[32m+[m[32m        conn.close()[m
[32m+[m[32m        return jsonify({'erro': 'Movimenta√ß√£o n√£o encontrada.'}), 404[m
[32m+[m[32m    cur.execute('DELETE FROM movimentacoes WHERE id_mov=?', (id_mov,))[m
[32m+[m[32m    conn.commit()[m
[32m+[m[32m    conn.close()[m
[32m+[m[32m    return jsonify({'mensagem': 'Movimenta√ß√£o removida.'})[m
[32m+[m
[32m+[m[32m# Tratamento de erros HTTP[m
[32m+[m
[32m+[m[32m@app.errorhandler(404)[m
[32m+[m[32mdef not_found_error(error):[m
[32m+[m[32m    return render_template('error.html', error='P√°gina n√£o encontrada'), 404[m
[32m+[m
[32m+[m[32m@app.errorhandler(500)[m
[32m+[m[32mdef internal_error(error):[m
[32m+[m[32m    return render_template('error.html', error='Erro interno do servidor'), 500[m
[32m+[m
[32m+[m[32mif __name__ == '__main__':[m
[32m+[m[32m    # Em produ√ß√£o, use waitress ou outro servidor WSGI[m
[32m+[m[32m    # from waitress import serve[m
[32m+[m[32m    # serve(app, host='0.0.0.0', port=8000)[m
[32m+[m[32m    app.run(debug=True)[m
[1mdiff --git a/app/templates/estoque.html b/app/templates/estoque.html[m
[1mnew file mode 100644[m
[1mindex 0000000..7bfb522[m
[1m--- /dev/null[m
[1m+++ b/app/templates/estoque.html[m
[36m@@ -0,0 +1,290 @@[m
[32m+[m[32m{% extends "base.html" %}[m
[32m+[m
[32m+[m[32m{% block title %}Estoque - Tabacaria{% endblock %}[m
[32m+[m
[32m+[m[32m{% block extra_css %}[m
[32m+[m[32m<link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css">[m
[32m+[m[32m{% endblock %}[m
[32m+[m
[32m+[m[32m{% block content %}[m
[32m+[m[32m<div class="header">[m
[32m+[m[32m    <img src="{{ url_for('static', filename='Images/Logo_tabacaria.png') }}" alt="Logo" class="logo">[m
[32m+[m[32m    <div>[m
[32m+[m[32m        <h1>Tabacaria - Estoque</h1>[m
[32m+[m[32m        <p style="color:#999; margin-top:6px;">Visualiza√ß√£o do estoque atual</p>[m
[32m+[m[32m    </div>[m
[32m+[m[32m</div>[m
[32m+[m
[32m+[m[32m    <!-- Grid layout for new product + table -->[m
[32m+[m[32m    <div style="display:grid; grid-template-columns:300px 1fr; gap:20px; align-items:start">[m
[32m+[m[32m      <!-- New product form -->[m
[32m+[m[32m      <div class="panel">[m
[32m+[m[32m        <h2>Novo Produto</h2>[m
[32m+[m[32m        <form id="newProductForm">[m
[32m+[m[32m          <div class="form-group">[m
[32m+[m[32m            <label>Nome *</label>[m
[32m+[m[32m            <input type="text" id="newName" required>[m
[32m+[m[32m          </div>[m
[32m+[m[32m          <div class="form-group">[m
[32m+[m[32m            <label>Categoria</label>[m
[32m+[m[32m            <input type="text" id="newCategory">[m
[32m+[m[32m          </div>[m
[32m+[m[32m          <div class="form-group">[m
[32m+[m[32m            <label>Pre√ßo (R$) *</label>[m
[32m+[m[32m            <input type="number" id="newPrice" step="0.01" required>[m
[32m+[m[32m          </div>[m
[32m+[m[32m          <div class="form-group">[m
[32m+[m[32m            <label>Quantidade Inicial *</label>[m
[32m+[m[32m            <input type="number" id="newQuantity" required>[m
[32m+[m[32m          </div>[m
[32m+[m[32m          <button type="submit" class="btn btn-primary">Cadastrar Produto</button>[m
[32m+[m[32m        </form>[m
[32m+[m[32m      </div>[m
[32m+[m
[32m+[m[32m      <!-- Products table -->[m
[32m+[m[32m      <div class="panel">[m
[32m+[m[32m        <h2 style="margin-bottom:18px; border-bottom:3px solid var(--accent-1); padding-bottom:8px;">üìã Estoque Atual</h2>[m
[32m+[m[32m        <div style="overflow-x:auto">[m
[32m+[m[32m          <table id="tabelaEstoque">[m
[32m+[m[32m            <thead>[m
[32m+[m[32m            <tr>[m
[32m+[m[32m              <th>Nome</th>[m
[32m+[m[32m              <th>Categoria</th>[m
[32m+[m[32m              <th>Pre√ßo</th>[m
[32m+[m[32m              <th>Qtd</th>[m
[32m+[m[32m              <th>C√≥digo</th>[m
[32m+[m[32m              <th>Etiqueta</th>[m
[32m+[m[32m              <th style="width:180px">A√ß√µes</th>[m
[32m+[m[32m            </tr>[m
[32m+[m[32m            </thead>[m
[32m+[m[32m            <tbody id="tabela"></tbody>[m
[32m+[m[32m          </table>[m
[32m+[m[32m        </div>[m
[32m+[m[32m      </div>[m
[32m+[m[32m    </div>[m
[32m+[m
[32m+[m[32m    <!-- Modal de Edi√ß√£o -->[m
[32m+[m[32m    <div class="modal" id="editModal">[m
[32m+[m[32m      <div class="modal-content">[m
[32m+[m[32m        <h3>Editar Produto</h3>[m
[32m+[m[32m        <div class="form-group">[m
[32m+[m[32m          <label>Nome</label>[m
[32m+[m[32m          <input id="editName" type="text">[m
[32m+[m[32m        </div>[m
[32m+[m[32m        <div class="form-row">[m
[32m+[m[32m          <div class="form-group">[m
[32m+[m[32m            <label>Categoria</label>[m
[32m+[m[32m            <input id="editCategory" type="text">[m
[32m+[m[32m          </div>[m
[32m+[m[32m          <div class="form-group">[m
[32m+[m[32m            <label>Pre√ßo (R$)</label>[m
[32m+[m[32m            <input id="editPrice" type="number" step="0.01">[m
[32m+[m[32m          </div>[m
[32m+[m[32m        </div>[m
[32m+[m[32m        <div class="form-group">[m
[32m+[m[32m          <label>Quantidade</label>[m
[32m+[m[32m          <input id="editQuantity" type="number">[m
[32m+[m[32m        </div>[m
[32m+[m[32m        <div class="btn-group">[m
[32m+[m[32m          <button class="btn-primary" id="saveEditBtn">Salvar</button>[m
[32m+[m[32m          <button class="btn-secondary" onclick="closeEditModal()">Cancelar</button>[m
[32m+[m[32m        </div>[m
[32m+[m[32m      </div>[m
[32m+[m[32m    </div>[m
[32m+[m
[32m+[m[32m    </div>[m
[32m+[m
[32m+[m[32m    <script src="{{ url_for('static', filename='js/common.js') }}"></script>[m
[32m+[m[32m    <script>[m
[32m+[m[32m    async function carregarProdutos(){[m
[32m+[m[32m      try {[m
[32m+[m[32m        const res = await fetch('/api/produtos');[m
[32m+[m[32m        if (!res.ok) throw new Error('Erro ao carregar');[m
[32m+[m[32m        const produtos = await res.json();[m
[32m+[m[32m        const tbody = document.getElementById('tabela');[m
[32m+[m[32m        tbody.innerHTML = '';[m
[32m+[m[32m        produtos.forEach(p=>{[m
[32m+[m[32m          tbody.innerHTML += `<tr>[m
[32m+[m[32m            <td>${p.nome}</td>[m
[32m+[m[32m            <td>${p.categoria || ''}</td>[m
[32m+[m[32m            <td>R$ ${Number(p.preco).toFixed(2)}</td>[m
[32m+[m[32m            <td>${p.quantidade}</td>[m
[32m+[m[32m            <td>${p.codigo_barras || ''}</td>[m
[32m+[m[32m            <td>[m
[32m+[m[32m                <img src="/static/barcodes/${p.codigo_barras}.png" width="120" alt="etiqueta" onerror="this.style.display='none'"> <br>[m
[32m+[m[32m                <button class="btn-primary" onclick="imprimirEtiqueta(${p.id_produto})">üñ®Ô∏è Imprimir</button>[m
[32m+[m[32m            </td>[m
[32m+[m[32m            <td>[m
[32m+[m[32m                <button class="btn-primary" onclick="openEditModal(${p.id_produto})">‚úèÔ∏è Editar</button>[m
[32m+[m[32m                <button class="btn-danger" onclick="deleteProductFromTable(${p.id_produto})">üóëÔ∏è Remover</button>[m
[32m+[m[32m            </td>[m
[32m+[m[32m          </tr>`;[m
[32m+[m[32m        });[m
[32m+[m[32m      } catch (err) {[m
[32m+[m[32m        console.error(err);[m
[32m+[m[32m        const tbody = document.getElementById('tabela');[m
[32m+[m[32m        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#999">Erro ao carregar produtos</td></tr>';[m
[32m+[m[32m      }[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    function openEditModal(id) {[m
[32m+[m[32m      // busca produto atual[m
[32m+[m[32m      fetch('/api/produtos')[m
[32m+[m[32m        .then(r=>r.json())[m
[32m+[m[32m        .then(list=>{[m
[32m+[m[32m          const p = list.find(x=>x.id_produto===id);[m
[32m+[m[32m          if (!p) return alert('Produto n√£o encontrado');[m
[32m+[m[32m          document.getElementById('editName').value = p.nome || '';[m
[32m+[m[32m          document.getElementById('editCategory').value = p.categoria || '';[m
[32m+[m[32m          document.getElementById('editPrice').value = Number(p.preco || 0).toFixed(2);[m
[32m+[m[32m          document.getElementById('editQuantity').value = p.quantidade || 0;[m
[32m+[m[32m          document.getElementById('editModal').classList.add('active');[m
[32m+[m[32m          document.getElementById('saveEditBtn').onclick = () => saveEdit(id);[m
[32m+[m[32m        })[m
[32m+[m[32m        .catch(err=>{ console.error(err); alert('Erro ao obter produto'); });[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    function closeEditModal(){ document.getElementById('editModal').classList.remove('active'); }[m
[32m+[m[32m      function closePrintModal(){ document.getElementById('printModal').classList.remove('active'); }[m
[32m+[m
[32m+[m[32m    async function saveEdit(id){[m
[32m+[m[32m      const nome = document.getElementById('editName').value.trim();[m
[32m+[m[32m      const categoria = document.getElementById('editCategory').value.trim();[m
[32m+[m[32m      const preco = parseFloat(document.getElementById('editPrice').value) || 0;[m
[32m+[m[32m      const quantidade = parseInt(document.getElementById('editQuantity').value) || 0;[m
[32m+[m[32m      if(!nome){ alert('Nome obrigat√≥rio'); return; }[m
[32m+[m[32m      try{[m
[32m+[m[32m        const res = await fetch(`/api/produtos/${id}`, {[m
[32m+[m[32m          method:'PUT', headers:{'Content-Type':'application/json'},[m
[32m+[m[32m          body: JSON.stringify({nome, categoria, preco, quantidade})[m
[32m+[m[32m        });[m
[32m+[m[32m        if (!res.ok) {[m
[32m+[m[32m          const data = await res.json().catch(()=>({erro:'erro'}));[m
[32m+[m[32m          throw new Error(data.erro || 'Falha ao salvar');[m
[32m+[m[32m        }[m
[32m+[m[32m        closeEditModal();[m
[32m+[m[32m        carregarProdutos();[m
[32m+[m[32m        alert('Produto atualizado');[m
[32m+[m[32m      } catch (err){ console.error(err); alert('Erro ao atualizar produto'); }[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    async function deleteProductFromTable(id){[m
[32m+[m[32m      if(!confirm('Confirmar remo√ß√£o deste produto?')) return;[m
[32m+[m[32m      try{[m
[32m+[m[32m        const res = await fetch(`/api/produtos/${id}`, { method:'DELETE' });[m
[32m+[m[32m        if (!res.ok) throw new Error('Falha ao remover');[m
[32m+[m[32m        carregarProdutos();[m
[32m+[m[32m      } catch(err){ console.error(err); alert('Erro ao remover produto'); }[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    carregarProdutos();[m
[32m+[m
[32m+[m[32m  function imprimirEtiqueta(id) {[m
[32m+[m[32m    try {[m
[32m+[m[32m      fetch(`/imprimir_etiqueta/${id}`)[m
[32m+[m[32m        .then(response => response.blob())[m
[32m+[m[32m        .then(blob => {[m
[32m+[m[32m          const url = window.URL.createObjectURL(blob);[m
[32m+[m[32m          const a = document.createElement('a');[m
[32m+[m[32m          a.href = url;[m
[32m+[m[32m          a.download = `etiqueta_${id}.pdf`;[m
[32m+[m[32m          document.body.appendChild(a);[m
[32m+[m[32m          a.click();[m
[32m+[m[32m          window.URL.revokeObjectURL(url);[m
[32m+[m[32m          document.body.removeChild(a);[m
[32m+[m[32m        })[m
[32m+[m[32m        .catch(err => {[m
[32m+[m[32m          console.error(err);[m
[32m+[m[32m          alert('Erro ao gerar etiqueta: ' + (err.message || err));[m
[32m+[m[32m        });[m
[32m+[m[32m    } catch(err) {[m
[32m+[m[32m      console.error(err);[m
[32m+[m[32m      alert('Erro ao preparar etiqueta: ' + (err.message || err));[m
[32m+[m[32m    }[m
[32m+[m[32m  }[m
[32m+[m
[32m+[m[32m    // Recarregar tabela com DataTables[m
[32m+[m[32mlet tabelaDT;[m
[32m+[m
[32m+[m[32masync function carregarProdutos(){[m
[32m+[m[32m  try {[m
[32m+[m[32m    const res = await fetch('/api/produtos');[m
[32m+[m[32m    if (!res.ok) throw new Error('Erro ao carregar');[m
[32m+[m[32m    const produtos = await res.json();[m
[32m+[m[32m    const tbody = document.getElementById('tabela');[m
[32m+[m[32m    tbody.innerHTML = '';[m
[32m+[m
[32m+[m[32m    produtos.forEach(p=>{[m
[32m+[m[32m      tbody.innerHTML += `<tr>[m
[32m+[m[32m        <td>${p.nome}</td>[m
[32m+[m[32m        <td>${p.categoria || ''}</td>[m
[32m+[m[32m        <td>R$ ${Number(p.preco).toFixed(2)}</td>[m
[32m+[m[32m        <td>${p.quantidade}</td>[m
[32m+[m[32m        <td>${p.codigo_barras || ''}</td>[m
[32m+[m[32m        <td>[m
[32m+[m[32m            <img src="/static/barcodes/${p.codigo_barras}.png" width="120" alt="etiqueta" onerror="this.style.display='none'"> <br>[m
[32m+[m[32m            <button class="btn-primary" onclick="imprimirEtiqueta(${p.id_produto})">üñ®Ô∏è Imprimir</button>[m
[32m+[m[32m        </td>[m
[32m+[m[32m        <td>[m
[32m+[m[32m            <button class="btn-primary" onclick="openEditModal(${p.id_produto})">‚úèÔ∏è Editar</button>[m
[32m+[m[32m            <button class="btn-danger" onclick="deleteProductFromTable(${p.id_produto})">üóëÔ∏è Remover</button>[m
[32m+[m[32m        </td>[m
[32m+[m[32m      </tr>`;[m
[32m+[m[32m    });[m
[32m+[m
[32m+[m[32m    // Reaplicar DataTable[m
[32m+[m[32m    if (tabelaDT) {[m
[32m+[m[32m      tabelaDT.destroy();[m
[32m+[m[32m    }[m
[32m+[m[32m    tabelaDT = new DataTable('#tabelaEstoque', {[m
[32m+[m[32m      language: {[m
[32m+[m[32m        url: 'https://cdn.datatables.net/plug-ins/1.13.5/i18n/pt-BR.json'[m
[32m+[m[32m      },[m
[32m+[m[32m      pageLength: 10,[m
[32m+[m[32m      ordering: true,[m
[32m+[m[32m      responsive: true[m
[32m+[m[32m    });[m
[32m+[m
[32m+[m[32m  } catch (err) {[m
[32m+[m[32m    console.error(err);[m
[32m+[m[32m    document.getElementById('tabela').innerHTML = '<tr><td colspan="7">Erro ao carregar produtos</td></tr>';[m
[32m+[m[32m  }[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m// Handle new product form[m
[32m+[m[32mdocument.getElementById('newProductForm').addEventListener('submit', async (e) => {[m
[32m+[m[32m  e.preventDefault();[m
[32m+[m[32m  const nome = document.getElementById('newName').value.trim();[m
[32m+[m[32m  const categoria = document.getElementById('newCategory').value.trim();[m
[32m+[m[32m  const preco = parseFloat(document.getElementById('newPrice').value) || 0;[m
[32m+[m[32m  const quantidade = parseInt(document.getElementById('newQuantity').value) || 0;[m
[32m+[m
[32m+[m[32m  try {[m
[32m+[m[32m    const res = await fetch('/api/produtos', {[m
[32m+[m[32m      method: 'POST',[m
[32m+[m[32m      headers: {'Content-Type': 'application/json'},[m
[32m+[m[32m      body: JSON.stringify({nome, categoria, preco, quantidade})[m
[32m+[m[32m    });[m
[32m+[m[32m    if (!res.ok) {[m
[32m+[m[32m      const data = await res.json().catch(() => ({}));[m
[32m+[m[32m      throw new Error(data.erro || 'Falha ao cadastrar');[m
[32m+[m[32m    }[m
[32m+[m[32m    // reset form[m
[32m+[m[32m    e.target.reset();[m
[32m+[m[32m    carregarProdutos();[m
[32m+[m[32m    alert('Produto cadastrado com sucesso!');[m
[32m+[m[32m  } catch(err) {[m
[32m+[m[32m    console.error(err);[m
[32m+[m[32m    alert('Erro ao cadastrar produto: ' + (err.message || err));[m
[32m+[m[32m  }[m
[32m+[m[32m});[m
[32m+[m
[32m+[m[32mcarregarProdutos();[m
[32m+[m[32m  </script>[m
[32m+[m[32m{% endblock %}[m
[32m+[m
[32m+[m[32m{% block extra_js %}[m
[32m+[m[32m<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>[m
[32m+[m[32m<script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>[m
[32m+[m[32m<script src="https://cdnjs.cloudflare.com/ajax/libs/jsbarcode/3.11.5/JsBarcode.all.min.js"></script>[m
[32m+[m[32m{% endblock %}[m
[1mdiff --git a/check_tables.py b/check_tables.py[m
[1mnew file mode 100644[m
[1mindex 0000000..cb244f4[m
[1m--- /dev/null[m
[1m+++ b/check_tables.py[m
[36m@@ -0,0 +1,19 @@[m
[32m+[m[32mimport sqlite3[m
[32m+[m
[32m+[m[32mconn = sqlite3.connect('estoque_tabacaria.db')[m
[32m+[m[32mcur = conn.cursor()[m
[32m+[m
[32m+[m[32m# List all tables[m
[32m+[m[32mcur.execute("SELECT name FROM sqlite_master WHERE type='table'")[m
[32m+[m[32mtables = [row[0] for row in cur.fetchall()][m
[32m+[m[32mprint('Tables in database:', tables)[m
[32m+[m
[32m+[m[32m# Check schema of each table[m
[32m+[m[32mfor table in tables:[m
[32m+[m[32m    cur.execute(f"PRAGMA table_info({table})")[m
[32m+[m[32m    columns = cur.fetchall()[m
[32m+[m[32m    print(f"\nTable {table} columns:")[m
[32m+[m[32m    for col in columns:[m
[32m+[m[32m        print(f"  {col[1]} {col[2]}")[m
[32m+[m
[32m+[m[32mconn.close()[m
\ No newline at end of file[m
[1mdiff --git a/estoque_tabacaria.db b/estoque_tabacaria.db[m
[1mnew file mode 100644[m
[1mindex 0000000..bd1993e[m
Binary files /dev/null and b/estoque_tabacaria.db differ
[1mdiff --git a/estoque_tabacaria.db.bak b/estoque_tabacaria.db.bak[m
[1mnew file mode 100644[m
[1mindex 0000000..96b4d9e[m
Binary files /dev/null and b/estoque_tabacaria.db.bak differ
[1mdiff --git a/recreate_db.py b/recreate_db.py[m
[1mnew file mode 100644[m
[1mindex 0000000..8f10da4[m
[1m--- /dev/null[m
[1m+++ b/recreate_db.py[m
[36m@@ -0,0 +1,17 @@[m
[32m+[m[32mimport os[m
[32m+[m[32mimport sqlite3[m
[32m+[m
[32m+[m[32mprint('Backing up current database...')[m
[32m+[m[32mif os.path.exists('estoque_tabacaria.db'):[m
[32m+[m[32m    os.rename('estoque_tabacaria.db', 'estoque_tabacaria.db.bak')[m
[32m+[m
[32m+[m[32mprint('Creating new database...')[m
[32m+[m[32mconn = sqlite3.connect('estoque_tabacaria.db')[m
[32m+[m
[32m+[m[32mprint('Running schema...')[m
[32m+[m[32mwith open('schema.sql', 'r', encoding='utf-8') as f:[m
[32m+[m[32m    conn.executescript(f.read())[m
[32m+[m
[32m+[m[32mconn.commit()[m
[32m+[m[32mconn.close()[m
[32m+[m[32mprint('Done! Old database backed up as estoque_tabacaria.db.bak')[m
\ No newline at end of file[m
[1mdiff --git a/requirements.txt b/requirements.txt[m
[1mnew file mode 100644[m
[1mindex 0000000..ad1ecb8[m
[1m--- /dev/null[m
[1m+++ b/requirements.txt[m
[36m@@ -0,0 +1,4 @@[m
[32m+[m[32mFlask>=2.0[m
[32m+[m[32mpython-barcode>=0.14[m
[32m+[m[32mPillow>=9.0[m
[32m+[m[32mreportlab>=4.0[m
[1mdiff --git a/schema.sql b/schema.sql[m
[1mnew file mode 100644[m
[1mindex 0000000..e6c675f[m
[1m--- /dev/null[m
[1m+++ b/schema.sql[m
[36m@@ -0,0 +1,77 @@[m
[32m+[m[32mPRAGMA foreign_keys = ON;[m
[32m+[m
[32m+[m[32mCREATE TABLE IF NOT EXISTS produtos ([m
[32m+[m[32m  id_produto INTEGER PRIMARY KEY AUTOINCREMENT,[m
[32m+[m[32m  nome TEXT NOT NULL,[m
[32m+[m[32m  categoria TEXT,[m
[32m+[m[32m  preco REAL NOT NULL DEFAULT 0.0,[m
[32m+[m[32m  quantidade INTEGER NOT NULL DEFAULT 0,[m
[32m+[m[32m  codigo_barras TEXT UNIQUE,[m
[32m+[m[32m  criado_em TEXT DEFAULT (datetime('now'))[m
[32m+[m[32m);[m
[32m+[m
[32m+[m[32mCREATE TABLE IF NOT EXISTS movimentacoes ([m
[32m+[m[32m  id_mov INTEGER PRIMARY KEY AUTOINCREMENT,[m
[32m+[m[32m  id_produto INTEGER NOT NULL,[m
[32m+[m[32m  tipo TEXT CHECK(tipo IN ('entrada','saida')) NOT NULL,[m
[32m+[m[32m  quantidade INTEGER NOT NULL CHECK (quantidade > 0),[m
[32m+[m[32m  observacao TEXT,[m
[32m+[m[32m  data_mov TEXT DEFAULT (datetime('now')),[m
[32m+[m[32m  FOREIGN KEY (id_produto) REFERENCES produtos(id_produto) ON DELETE RESTRICT[m
[32m+[m[32m);[m
[32m+[m
[32m+[m[32mCREATE TABLE IF NOT EXISTS revendedores ([m
[32m+[m[32m  id_revendedor INTEGER PRIMARY KEY AUTOINCREMENT,[m
[32m+[m[32m  nome TEXT NOT NULL,[m
[32m+[m[32m  contato TEXT,[m
[32m+[m[32m  telefone TEXT,[m
[32m+[m[32m  email TEXT,[m
[32m+[m[32m  endereco TEXT,[m
[32m+[m[32m  notas TEXT,[m
[32m+[m[32m  criado_em TIMESTAMP DEFAULT (datetime('now'))[m
[32m+[m[32m);[m
[32m+[m
[32m+[m[32mCREATE TABLE IF NOT EXISTS vendas ([m
[32m+[m[32m  id_venda INTEGER PRIMARY KEY AUTOINCREMENT,[m
[32m+[m[32m  id_revendedor INTEGER,[m
[32m+[m[32m  data_venda TIMESTAMP DEFAULT (datetime('now')),[m
[32m+[m[32m  observacao TEXT,[m
[32m+[m[32m  FOREIGN KEY (id_revendedor) REFERENCES revendedores(id_revendedor) ON DELETE SET NULL[m
[32m+[m[32m);[m
[32m+[m
[32m+[m[32mCREATE TABLE IF NOT EXISTS venda_items ([m
[32m+[m[32m  id_item INTEGER PRIMARY KEY AUTOINCREMENT,[m
[32m+[m[32m  id_venda INTEGER NOT NULL,[m
[32m+[m[32m  id_produto INTEGER NOT NULL,[m
[32m+[m[32m  quantidade INTEGER NOT NULL,[m
[32m+[m[32m  preco_unitario REAL NOT NULL,[m
[32m+[m[32m  FOREIGN KEY (id_venda) REFERENCES vendas(id_venda) ON DELETE CASCADE,[m
[32m+[m[32m  FOREIGN KEY (id_produto) REFERENCES produtos(id_produto) ON DELETE RESTRICT[m
[32m+[m[32m);[m
[32m+[m
[32m+[m[32mCREATE TABLE IF NOT EXISTS clientes ([m
[32m+[m[32m  id_cliente INTEGER PRIMARY KEY AUTOINCREMENT,[m
[32m+[m[32m  nome TEXT NOT NULL,[m
[32m+[m[32m  cpf TEXT UNIQUE,[m
[32m+[m[32m  telefone TEXT NOT NULL,[m
[32m+[m[32m  email TEXT,[m
[32m+[m[32m  endereco TEXT,[m
[32m+[m[32m  cidade TEXT,[m
[32m+[m[32m  estado TEXT,[m
[32m+[m[32m  observacoes TEXT,[m
[32m+[m[32m  ultima_compra TEXT,[m
[32m+[m[32m  criado_em TEXT DEFAULT (datetime('now')),[m
[32m+[m[32m  atualizado_em TEXT DEFAULT (datetime('now'))[m
[32m+[m[32m);[m
[32m+[m
[32m+[m[32mCREATE TABLE IF NOT EXISTS logs ([m
[32m+[m[32m  id_log INTEGER PRIMARY KEY AUTOINCREMENT,[m
[32m+[m[32m  criado_em TIMESTAMP DEFAULT (datetime('now')),[m
[32m+[m[32m  acao TEXT NOT NULL,[m
[32m+[m[32m  tipo TEXT,[m
[32m+[m[32m  quantidade INTEGER,[m
[32m+[m[32m  valor REAL,[m
[32m+[m[32m  produto_id INTEGER,[m
[32m+[m[32m  detalhe TEXT,[m
[32m+[m[32m  FOREIGN KEY (produto_id) REFERENCES produtos(id_produto) ON DELETE SET NULL[m
[32m+[m[32m);[m
[1mdiff --git a/scripts/check_tables.py b/scripts/check_tables.py[m
[1mnew file mode 100644[m
[1mindex 0000000..d8f1614[m
[1m--- /dev/null[m
[1m+++ b/scripts/check_tables.py[m
[36m@@ -0,0 +1,13 @@[m
[32m+[m[32mimport sqlite3[m
[32m+[m
[32m+[m[32mDB = 'estoque_tabacaria.db'[m
[32m+[m[32mconn = sqlite3.connect(DB)[m
[32m+[m[32mcur = conn.cursor()[m
[32m+[m[32mcur.execute("SELECT name FROM sqlite_master WHERE type='table'")[m
[32m+[m[32mrows = cur.fetchall()[m
[32m+[m[32mif not rows:[m
[32m+[m[32m    print('No tables found')[m
[32m+[m[32melse:[m
[32m+[m[32m    for r in rows:[m
[32m+[m[32m        print(r[0])[m
[32m+[m[32mconn.close()[m
[1mdiff --git a/scripts/install_service.ps1 b/scripts/install_service.ps1[m
[1mnew file mode 100644[m
[1mindex 0000000..7d963eb[m
[1m--- /dev/null[m
[1m+++ b/scripts/install_service.ps1[m
[36m@@ -0,0 +1,15 @@[m
[32m+[m[32m# Arquivo que cont√©m comandos para servi√ßo Windows[m
[32m+[m[32m$ServiceName = "TabacariaEstoque"[m
[32m+[m[32m$DisplayName = "Sistema de Controle de Tabacaria"[m
[32m+[m[32m$Description = "Sistema de gest√£o de estoque para tabacaria"[m
[32m+[m
[32m+[m[32m# Caminho do execut√°vel e argumentos[m
[32m+[m[32m$BinPath = "powershell.exe"[m
[32m+[m[32m$Arguments = "-ExecutionPolicy Bypass -WindowStyle Hidden -File `"$PSScriptRoot\start_sistema.ps1`""[m
[32m+[m
[32m+[m[32m# Criar novo servi√ßo[m
[32m+[m[32mNew-Service -Name $ServiceName `[m
[32m+[m[32m            -DisplayName $DisplayName `[m
[32m+[m[32m            -Description $Description `[m
[32m+[m[32m            -BinPath "$BinPath $Arguments" `[m
[32m+[m[32m            -StartupType Automatic[m
\ No newline at end of file[m
[1mdiff --git a/scripts/move_logo.py b/scripts/move_logo.py[m
[1mnew file mode 100644[m
[1mindex 0000000..b6a9603[m
[1m--- /dev/null[m
[1m+++ b/scripts/move_logo.py[m
[36m@@ -0,0 +1,35 @@[m
[32m+[m[32mimport os[m
[32m+[m[32mimport shutil[m
[32m+[m
[32m+[m[32m"""[m
[32m+[m[32mMove Logo_tabacaria.png from Templates/ to static/ if present.[m
[32m+[m[32mRun this script from the repository root (where app.py is) with:[m
[32m+[m[32m    python .\scripts\move_logo.py[m
[32m+[m
[32m+[m[32mThis script is non-destructive: it will not overwrite an existing file in static/ unless you confirm.[m
[32m+[m[32m"""[m
[32m+[m
[32m+[m[32mROOT = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))[m
[32m+[m[32mtemplates_logo = os.path.join(ROOT, 'Templates', 'Logo_tabacaria.png')[m
[32m+[m[32mstatic_logo = os.path.join(ROOT, 'static', 'Logo_tabacaria.png')[m
[32m+[m
[32m+[m[32mdef main():[m
[32m+[m[32m    if not os.path.exists(templates_logo):[m
[32m+[m[32m        print(f'Arquivo n√£o encontrado em Templates/: {templates_logo}')[m
[32m+[m[32m        if os.path.exists(static_logo):[m
[32m+[m[32m            print('Parece que o logo j√° est√° em static/. Nada a fazer.')[m
[32m+[m[32m        return[m
[32m+[m
[32m+[m[32m    if os.path.exists(static_logo):[m
[32m+[m[32m        print(f'J√° existe um arquivo em static/: {static_logo}')[m
[32m+[m[32m        confirm = input('Deseja sobrescrever? [s/N]: ').strip().lower()[m
[32m+[m[32m        if confirm != 's':[m
[32m+[m[32m            print('Opera√ß√£o cancelada.')[m
[32m+[m[32m            return[m
[32m+[m
[32m+[m[32m    os.makedirs(os.path.dirname(static_logo), exist_ok=True)[m
[32m+[m[32m    shutil.move(templates_logo, static_logo)[m
[32m+[m[32m    print(f'Movido {templates_logo} -> {static_logo}')[m
[32m+[m
[32m+[m[32mif __name__ == '__main__':[m
[32m+[m[32m    main()[m
[1mdiff --git a/scripts/setup_client.ps1 b/scripts/setup_client.ps1[m
[1mnew file mode 100644[m
[1mindex 0000000..0fbaae1[m
[1m--- /dev/null[m
[1m+++ b/scripts/setup_client.ps1[m
[36m@@ -0,0 +1,146 @@[m
[32m+[m[32m<#[m
[32m+[m[32m.SYNOPSIS[m
[32m+[m[32mScript de instala√ß√£o do Sistema de Controle de Estoque para Tabacaria.[m
[32m+[m
[32m+[m[32m.DESCRIPTION[m
[32m+[m[32mEste script automatiza a configura√ß√£o completa do sistema em Windows 11, incluindo:[m
[32m+[m[32m- Verifica√ß√£o e valida√ß√£o do Python[m
[32m+[m[32m- Cria√ß√£o do ambiente virtual (.venv)[m
[32m+[m[32m- Instala√ß√£o de todas as depend√™ncias[m
[32m+[m[32m- Cria√ß√£o do banco de dados SQLite[m
[32m+[m[32m- Configura√ß√£o das pastas necess√°rias[m
[32m+[m[32m- Posicionamento correto do logo[m
[32m+[m[32m- Inicializa√ß√£o opcional do aplicativo[m
[32m+[m
[32m+[m[32m.PARAMETER StartApp[m
[32m+[m[32mSe fornecido, inicia o aplicativo ap√≥s a configura√ß√£o.[m
[32m+[m
[32m+[m[32m.EXAMPLE[m
[32m+[m[32m.\scripts\setup_client.ps1[m
[32m+[m[32m    Configura o ambiente sem iniciar o app.[m
[32m+[m
[32m+[m[32m.EXAMPLE[m
[32m+[m[32m.\scripts\setup_client.ps1 -StartApp[m
[32m+[m[32m    Configura o ambiente e inicia o app automaticamente.[m
[32m+[m
[32m+[m[32m.NOTES[m
[32m+[m[32mRequisitos:[m
[32m+[m[32m- Windows 11[m
[32m+[m[32m- Python 3.10 ou superior (64-bit recomendado)[m
[32m+[m[32m- Conex√£o com internet para baixar pacotes[m
[32m+[m[32m- PowerShell 5.1 ou superior[m
[32m+[m
[32m+[m[32mAutor: Sistema profissional desenvolvido para gest√£o de estoque[m
[32m+[m[32mData: Outubro 2023[m
[32m+[m[32m#>[m
[32m+[m
[32m+[m[32mparam([m
[32m+[m[32m    [switch]$StartApp[m
[32m+[m[32m)[m
[32m+[m
[32m+[m[32mfunction Write-Step { param($Text)[m
[32m+[m[32m    Write-Host "`nüìã $Text" -ForegroundColor Cyan[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction Write-Success { param($Text)[m
[32m+[m[32m    Write-Host "‚úÖ $Text" -ForegroundColor Green[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction Write-Warning { param($Text)[m
[32m+[m[32m    Write-Host "‚ö†Ô∏è $Text" -ForegroundColor Yellow[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction Write-Error { param($Text)[m
[32m+[m[32m    Write-Host "‚ùå ERROR: $Text" -ForegroundColor Red[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction ErrExit { param($msg)[m
[32m+[m[32m    Write-Error $msg[m
[32m+[m[32m    exit 1[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m# Header bonito[m
[32m+[m[32m$header = @"[m
[32m+[m
[32m+[m[32m‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó[m
[32m+[m[32m‚ïë     Instala√ß√£o - Controle de Tabacaria    ‚ïë[m
[32m+[m[32m‚ïë           Sistema Profissional            ‚ïë[m
[32m+[m[32m‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù[m
[32m+[m
[32m+[m[32m"@[m
[32m+[m[32mWrite-Host $header -ForegroundColor Magenta[m
[32m+[m
[32m+[m[32m# Verificar Windows 11[m
[32m+[m[32mWrite-Step "Verificando sistema operacional"[m
[32m+[m[32m$osInfo = Get-CimInstance Win32_OperatingSystem[m
[32m+[m[32m$isWin11 = $osInfo.Caption -match "Windows 11"[m
[32m+[m[32mif (-not $isWin11) {[m
[32m+[m[32m    Write-Warning "Sistema n√£o √© Windows 11. O sistema pode funcionar, mas foi otimizado para Windows 11."[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m# Verificar PowerShell[m
[32m+[m[32mWrite-Step "Verificando vers√£o do PowerShell"[m
[32m+[m[32m$psVersion = $PSVersionTable.PSVersion.Major[m
[32m+[m[32mif ($psVersion -lt 5) {[m
[32m+[m[32m    ErrExit "PowerShell 5.1 ou superior √© necess√°rio. Vers√£o atual: $psVersion"[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m# Verificar Python[m
[32m+[m[32m$py = Get-Command python -ErrorAction SilentlyContinue[m
[32m+[m[32mif(-not $py){ ErrExit 'Python not found in PATH. Please install Python 3.10+ and add to PATH.' }[m
[32m+[m[32mWrite-Host "Python detected: $(python --version)"[m
[32m+[m
[32m+[m[32m# Create venv[m
[32m+[m[32mif(-not (Test-Path '.venv')){[m
[32m+[m[32m    Write-Host 'Creating virtual environment .venv...' -ForegroundColor Yellow[m
[32m+[m[32m    python -m venv .venv[m
[32m+[m[32m} else { Write-Host '.venv already exists, skipping creation.' }[m
[32m+[m
[32m+[m[32m$venvPython = Join-Path -Path '.venv' -ChildPath 'Scripts\python.exe'[m
[32m+[m[32mif(-not (Test-Path $venvPython)){ ErrExit "venv python not found at $venvPython" }[m
[32m+[m
[32m+[m[32mWrite-Host 'Upgrading pip and installing requirements...' -ForegroundColor Yellow[m
[32m+[m[32m& $venvPython -m pip install --upgrade pip | Out-Null[m
[32m+[m[32m& $venvPython -m pip install -r requirements.txt[m
[32m+[m[32mif($LASTEXITCODE -ne 0){ ErrExit 'pip install failed. Check errors above.' }[m
[32m+[m
[32m+[m[32m# Create DB from schema.sql[m
[32m+[m[32mif(-not (Test-Path 'estoque_tabacaria.db')){[m
[32m+[m[32m    Write-Host 'Creating SQLite database (estoque_tabacaria.db) from schema.sql' -ForegroundColor Yellow[m
[32m+[m[32m    & $venvPython - <<'PY'[m
[32m+[m[32mimport sqlite3[m
[32m+[m[32mconn = sqlite3.connect('estoque_tabacaria.db')[m
[32m+[m[32mwith open('schema.sql','r',encoding='utf-8') as f:[m
[32m+[m[32m    conn.executescript(f.read())[m
[32m+[m[32mconn.commit()[m
[32m+[m[32mconn.close()[m
[32m+[m[32mprint('DB criado com sucesso')[m
[32m+[m[32mPY[m
[32m+[m[32m} else { Write-Host 'estoque_tabacaria.db already exists, skipping DB creation.' }[m
[32m+[m
[32m+[m[32m# Create static dirs[m
[32m+[m[32mWrite-Host 'Ensuring static directories exist...' -ForegroundColor Yellow[m
[32m+[m[32mNew-Item -ItemType Directory -Force -Path "static\barcodes" | Out-Null[m
[32m+[m[32mNew-Item -ItemType Directory -Force -Path "static\Images" | Out-Null[m
[32m+[m
[32m+[m[32m# Move logo if present in Templates[m
[32m+[m[32m$tplLogo = Join-Path 'Templates' 'Logo_tabacaria.png'[m
[32m+[m[32m$destLogo = Join-Path 'static\Images' 'Logo_tabacaria.png'[m
[32m+[m[32mif(Test-Path $tplLogo){[m
[32m+[m[32m    Write-Host "Found logo at $tplLogo. Moving to $destLogo" -ForegroundColor Green[m
[32m+[m[32m    Move-Item -Force $tplLogo $destLogo[m
[32m+[m[32m} elseif(Test-Path 'Logo_tabacaria.png'){[m
[32m+[m[32m    Write-Host 'Found Logo_tabacaria.png in project root, moving to static\Images' -ForegroundColor Green[m
[32m+[m[32m    Move-Item -Force 'Logo_tabacaria.png' $destLogo[m
[32m+[m[32m} else {[m
[32m+[m[32m    Write-Host 'No logo found in Templates/ or project root. Please place Logo_tabacaria.png in static\Images when available.' -ForegroundColor Yellow[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mWrite-Host "\nSetup finished. To run the app:" -ForegroundColor Cyan[m
[32m+[m[32mWrite-Host ".\.venv\Scripts\Activate.ps1" -ForegroundColor Green[m
[32m+[m[32mWrite-Host "python app.py" -ForegroundColor Green[m
[32m+[m
[32m+[m[32mif($StartApp){[m
[32m+[m[32m    Write-Host 'Starting the application...' -ForegroundColor Cyan[m
[32m+[m[32m    & $venvPython app.py[m
[32m+[m[32m}[m
[1mdiff --git a/scripts/start_sistema.ps1 b/scripts/start_sistema.ps1[m
[1mnew file mode 100644[m
[1mindex 0000000..b79be91[m
[1m--- /dev/null[m
[1m+++ b/scripts/start_sistema.ps1[m
[36m@@ -0,0 +1,62 @@[m
[32m+[m[32m# Script para iniciar o sistema[m
[32m+[m[32m$ErrorActionPreference = 'Stop'[m
[32m+[m[32m$scriptPath = Split-Path -Parent $MyInvocation.MyCommand.Definition[m
[32m+[m[32m$appRoot = Split-Path -Parent $scriptPath[m
[32m+[m
[32m+[m[32m# Fun√ß√£o para verificar se o servidor est√° respondendo[m
[32m+[m[32mfunction Test-ServerResponse {[m
[32m+[m[32m    try {[m
[32m+[m[32m        $response = Invoke-WebRequest -Uri "http://127.0.0.1:5000" -UseBasicParsing -TimeoutSec 1[m
[32m+[m[32m        return $response.StatusCode -eq 200[m
[32m+[m[32m    } catch {[m
[32m+[m[32m        return $false[m
[32m+[m[32m    }[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m# Verificar se j√° est√° rodando[m
[32m+[m[32mif (Test-ServerResponse) {[m
[32m+[m[32m    Write-Host "Sistema j√° est√° rodando. Abrindo no navegador..."[m
[32m+[m[32m    Start-Process "http://127.0.0.1:5000"[m
[32m+[m[32m    exit 0[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m# Ativar ambiente virtual[m
[32m+[m[32mtry {[m
[32m+[m[32m    . "$appRoot\.venv\Scripts\Activate.ps1"[m
[32m+[m[32m} catch {[m
[32m+[m[32m    [System.Windows.Forms.MessageBox]::Show([m
[32m+[m[32m        "Erro ao iniciar o sistema. Por favor, execute o Instalar_Sistema.bat primeiro.",[m
[32m+[m[32m        "Erro de Inicializa√ß√£o",[m
[32m+[m[32m        [System.Windows.Forms.MessageBoxButtons]::OK,[m
[32m+[m[32m        [System.Windows.Forms.MessageBoxIcon]::Error[m
[32m+[m[32m    )[m
[32m+[m[32m    exit 1[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m# Iniciar o servidor[m
[32m+[m[32m$pythonProcess = Start-Process -FilePath "python" -ArgumentList "$appRoot\app.py" -WindowStyle Hidden -PassThru[m
[32m+[m
[32m+[m[32m# Aguardar servidor iniciar (m√°ximo 30 segundos)[m
[32m+[m[32m$maxAttempts = 30[m
[32m+[m[32m$attempts = 0[m
[32m+[m[32mdo {[m
[32m+[m[32m    Start-Sleep -Seconds 1[m
[32m+[m[32m    $attempts++[m
[32m+[m[32m    if ($attempts -eq 1) {[m
[32m+[m[32m        Write-Host "Iniciando sistema..."[m
[32m+[m[32m    }[m
[32m+[m[32m} until ((Test-ServerResponse) -or ($attempts -ge $maxAttempts))[m
[32m+[m
[32m+[m[32mif (Test-ServerResponse) {[m
[32m+[m[32m    # Abrir navegador[m
[32m+[m[32m    Start-Process "http://127.0.0.1:5000"[m
[32m+[m[32m} else {[m
[32m+[m[32m    [System.Windows.Forms.MessageBox]::Show([m
[32m+[m[32m        "Erro ao iniciar o servidor. Por favor, tente novamente ou contate o suporte.",[m
[32m+[m[32m        "Erro de Inicializa√ß√£o",[m
[32m+[m[32m        [System.Windows.Forms.MessageBoxButtons]::OK,[m
[32m+[m[32m        [System.Windows.Forms.MessageBoxIcon]::Error[m
[32m+[m[32m    )[m
[32m+[m[32m    if ($pythonProcess) { Stop-Process -Id $pythonProcess.Id -Force }[m
[32m+[m[32m    exit 1[m
[32m+[m[32m}[m
\ No newline at end of file[m
[1mdiff --git a/static/Images/Logo_tabacaria.png b/static/Images/Logo_tabacaria.png[m
[1mnew file mode 100644[m
[1mindex 0000000..7a713d1[m
Binary files /dev/null and b/static/Images/Logo_tabacaria.png differ
[1mdiff --git a/static/Images/favicon.ico b/static/Images/favicon.ico[m
[1mnew file mode 100644[m
[1mindex 0000000..991aa1a[m
[1m--- /dev/null[m
[1m+++ b/static/Images/favicon.ico[m
[36m@@ -0,0 +1 @@[m
[32m+[m[41m    [m
\ No newline at end of file[m
[1mdiff --git a/static/barcodes/789000000005.png b/static/barcodes/789000000005.png[m
[1mnew file mode 100644[m
[1mindex 0000000..54d260d[m
Binary files /dev/null and b/static/barcodes/789000000005.png differ
[1mdiff --git a/static/barcodes/789000000006.png b/static/barcodes/789000000006.png[m
[1mnew file mode 100644[m
[1mindex 0000000..0e6a3c0[m
Binary files /dev/null and b/static/barcodes/789000000006.png differ
[1mdiff --git a/static/barcodes/789000000007.png b/static/barcodes/789000000007.png[m
[1mnew file mode 100644[m
[1mindex 0000000..c7daa68[m
Binary files /dev/null and b/static/barcodes/789000000007.png differ
[1mdiff --git a/static/barcodes/789000000008.png b/static/barcodes/789000000008.png[m
[1mnew file mode 100644[m
[1mindex 0000000..a92115a[m
Binary files /dev/null and b/static/barcodes/789000000008.png differ
[1mdiff --git a/static/js/common.js b/static/js/common.js[m
[1mnew file mode 100644[m
[1mindex 0000000..7e0f65d[m
[1m--- /dev/null[m
[1m+++ b/static/js/common.js[m
[36m@@ -0,0 +1,35 @@[m
[32m+[m[32m// Fun√ß√µes compartilhadas entre p√°ginas[m
[32m+[m[32mfunction toggleFullScreen() {[m
[32m+[m[32m    const doc = document;[m
[32m+[m[32m    const docEl = document.documentElement;[m
[32m+[m[32m    const isFull = !!(doc.fullscreenElement || doc.webkitFullscreenElement || doc.mozFullScreenElement || doc.msFullscreenElement);[m
[32m+[m
[32m+[m[32m    if (!isFull) {[m
[32m+[m[32m        const request = docEl.requestFullscreen || docEl.webkitRequestFullscreen || docEl.mozRequestFullScreen || docEl.msRequestFullscreen;[m
[32m+[m[32m        if (request) request.call(docEl);[m
[32m+[m[32m    } else {[m
[32m+[m[32m        const exit = doc.exitFullscreen || doc.webkitExitFullscreen || doc.mozCancelFullScreen || doc.msExitFullscreen;[m
[32m+[m[32m        if (exit) exit.call(doc);[m
[32m+[m[32m    }[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction updateFullScreenButton() {[m
[32m+[m[32m    const btn = document.getElementById('fullscreenBtn');[m
[32m+[m[32m    const floating = document.getElementById('floatingFullscreen');[m
[32m+[m[32m    const doc = document;[m
[32m+[m[32m    const isFull = !!(doc.fullscreenElement || doc.webkitFullscreenElement || doc.mozFullScreenElement || doc.msFullscreenElement);[m
[32m+[m[32m    if (btn) btn.textContent = isFull ? '‚§¢ Sair Tela Cheia' : '‚õ∂ Tela Cheia';[m
[32m+[m[32m    if (floating) floating.textContent = isFull ? '‚§¢' : '‚õ∂';[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mdocument.addEventListener('fullscreenchange', updateFullScreenButton);[m
[32m+[m[32mdocument.addEventListener('webkitfullscreenchange', updateFullScreenButton);[m
[32m+[m[32mdocument.addEventListener('mozfullscreenchange', updateFullScreenButton);[m
[32m+[m[32mdocument.addEventListener('MSFullscreenChange', updateFullScreenButton);[m
[32m+[m
[32m+[m[32mdocument.addEventListener('DOMContentLoaded', () => {[m
[32m+[m[32m    updateFullScreenButton();[m
[32m+[m[32m});[m
[32m+[m
[32m+[m[32m// export to window[m
[32m+[m[32mwindow.appCommon = { toggleFullScreen, updateFullScreenButton };[m
[1mdiff --git a/static/js/sistema_products.js b/static/js/sistema_products.js[m
[1mnew file mode 100644[m
[1mindex 0000000..fbee3c3[m
[1m--- /dev/null[m
[1m+++ b/static/js/sistema_products.js[m
[36m@@ -0,0 +1,218 @@[m
[32m+[m[32m/* C√≥digo de gerenciamento de produtos (localStorage) extra√≠do de sistema_estoque_marina.html */[m
[32m+[m[32mlet products = [];[m
[32m+[m[32mlet editingId = null;[m
[32m+[m[32mconst API = '/api/produtos';[m
[32m+[m
[32m+[m[32m// API-only: sempre requisitar ao servidor; n√£o usa localStorage.[m
[32m+[m[32masync function fetchProductsFromServer() {[m
[32m+[m[32m    try {[m
[32m+[m[32m        const res = await fetch(API);[m
[32m+[m[32m        if (!res.ok) throw new Error('Erro ao buscar produtos no servidor');[m
[32m+[m[32m        const list = await res.json();[m
[32m+[m[32m        products = Array.isArray(list) ? list.map(p=>({[m
[32m+[m[32m            id: p.id_produto || p.id || null,[m
[32m+[m[32m            codigo_barras: p.codigo_barras || p.barcode || '',[m
[32m+[m[32m            name: p.nome || p.name || '',[m
[32m+[m[32m            description: p.descricao || p.description || '',[m
[32m+[m[32m            price: Number(p.preco || p.price || 0),[m
[32m+[m[32m            quantity: Number(p.quantidade || p.quantity || 0),[m
[32m+[m[32m            category: p.categoria || p.category || '',[m
[32m+[m[32m            unit: p.unidade || p.unit || ''[m
[32m+[m[32m        })) : [];[m
[32m+[m[32m    } catch (err) {[m
[32m+[m[32m        console.error(err);[m
[32m+[m[32m        showMessage('N√£o foi poss√≠vel carregar produtos do servidor.', 'error');[m
[32m+[m[32m        products = [];[m
[32m+[m[32m    }[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32masync function addProduct() {[m
[32m+[m[32m    const name = document.getElementById('productName').value.trim();[m
[32m+[m[32m    const description = document.getElementById('productDescription').value.trim();[m
[32m+[m[32m    const price = parseFloat(document.getElementById('productPrice').value) || 0;[m
[32m+[m[32m    const quantity = parseInt(document.getElementById('productQuantity').value) || 0;[m
[32m+[m[32m    const category = document.getElementById('productCategory').value.trim();[m
[32m+[m[32m    const unit = document.getElementById('productUnit').value;[m
[32m+[m
[32m+[m[32m    if (!name || isNaN(price) || isNaN(quantity) || !unit) {[m
[32m+[m[32m        showMessage('Preencha nome, pre√ßo, quantidade e unidade!', 'error');[m
[32m+[m[32m        return;[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    try {[m
[32m+[m[32m        if (editingId !== null) {[m
[32m+[m[32m            const res = await fetch(`${API}/${editingId}`, {[m
[32m+[m[32m                method: 'PUT',[m
[32m+[m[32m                headers: {'Content-Type':'application/json'},[m
[32m+[m[32m                body: JSON.stringify({nome:name, categoria:category, preco:price, quantidade:quantity})[m
[32m+[m[32m            });[m
[32m+[m[32m            const data = await res.json();[m
[32m+[m[32m            if (!res.ok) throw new Error(data.erro || 'Falha ao atualizar produto');[m
[32m+[m[32m            showMessage('Produto atualizado com sucesso!', 'success');[m
[32m+[m[32m        } else {[m
[32m+[m[32m            const res = await fetch(API, {[m
[32m+[m[32m                method: 'POST',[m
[32m+[m[32m                headers: {'Content-Type':'application/json'},[m
[32m+[m[32m                body: JSON.stringify({nome:name, categoria:category, preco:price, quantidade:quantity})[m
[32m+[m[32m            });[m
[32m+[m[32m            const data = await res.json();[m
[32m+[m[32m            if (!res.ok) throw new Error(data.erro || 'Falha ao adicionar produto');[m
[32m+[m[32m            showMessage('Produto adicionado com sucesso!', 'success');[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        // Recarrega lista do servidor[m
[32m+[m[32m        await fetchProductsFromServer();[m
[32m+[m[32m        renderProducts();[m
[32m+[m[32m        updateStats();[m
[32m+[m[32m        clearForm();[m
[32m+[m[32m    } catch (err) {[m
[32m+[m[32m        console.error(err);[m
[32m+[m[32m        showMessage('Erro ao salvar produto. Verifique a conex√£o e tente novamente.', 'error');[m
[32m+[m[32m    }[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction renderProducts() { renderFilteredProducts(products); }[m
[32m+[m
[32m+[m[32mfunction renderFilteredProducts(productsToRender) {[m
[32m+[m[32m    const container = document.getElementById('productsList');[m
[32m+[m[32m    if (!productsToRender || productsToRender.length === 0) {[m
[32m+[m[32m        container.innerHTML = '<div class="empty-state"><p>Nenhum produto encontrado</p></div>';[m
[32m+[m[32m        return;[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    container.innerHTML = productsToRender.map(p => `[m
[32m+[m[32m        <div class="product-card">[m
[32m+[m[32m            <h3>${p.name}</h3>[m
[32m+[m[32m            <div class="product-info">[m
[32m+[m[32m                <div><strong>Pre√ßo:</strong> R$ ${p.price.toFixed(2)}</div>[m
[32m+[m[32m                <div><strong>Quantidade:</strong> ${p.quantity} ${p.unit}</div>[m
[32m+[m[32m                ${p.category ? '<div><strong>Categoria:</strong> ' + p.category + '</div>' : ''}[m
[32m+[m[32m                <div><strong>C√≥digo:</strong> ${p.barcode}</div>[m
[32m+[m[32m            </div>[m
[32m+[m[32m            <div class="product-actions">[m
[32m+[m[32m                <button class="btn-success" onclick="openBarcodeModal(${p.id})">üìä C√≥digo</button>[m
[32m+[m[32m                <button class="btn-secondary" onclick="editProduct(${p.id})">‚úèÔ∏è Editar</button>[m
[32m+[m[32m                <button class="btn-danger" onclick="deleteProduct(${p.id})">üóëÔ∏è Remover</button>[m
[32m+[m[32m            </div>[m
[32m+[m[32m        </div>[m
[32m+[m[32m    `).join('');[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction openBarcodeModal(productId) {[m
[32m+[m[32m    const product = products.find(p => p.id === productId);[m
[32m+[m[32m    if (!product) return;[m
[32m+[m
[32m+[m[32m    const nameEl = document.getElementById('barcodeProductName');[m
[32m+[m[32m    const modal = document.getElementById('barcodeModal');[m
[32m+[m[32m    if (nameEl) nameEl.textContent = product.name;[m
[32m+[m[32m    if (modal) modal.classList.add('active');[m
[32m+[m
[32m+[m[32m    setTimeout(() => {[m
[32m+[m[32m        if (window.JsBarcode) JsBarcode("#barcode", product.barcode || product.codigo_barras || '', { format: "CODE128", width: 2, height: 100, displayValue: true });[m
[32m+[m[32m    }, 100);[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction closeModal() { const modal = document.getElementById('barcodeModal'); if (modal) modal.classList.remove('active'); }[m
[32m+[m
[32m+[m[32mfunction printBarcode() { window.print(); }[m
[32m+[m
[32m+[m[32masync function deleteProduct(productId) {[m
[32m+[m[32m    if (!confirm('Tem certeza que deseja remover este produto?')) return;[m
[32m+[m[32m    try {[m
[32m+[m[32m        const res = await fetch(`${API}/${productId}`, { method: 'DELETE' });[m
[32m+[m[32m        if (!res.ok) throw new Error('Falha ao remover');[m
[32m+[m[32m        products = products.filter(p => p.id !== productId);[m
[32m+[m[32m        localStorage.setItem('products', JSON.stringify(products));[m
[32m+[m[32m        renderProducts();[m
[32m+[m[32m        updateStats();[m
[32m+[m[32m        showMessage('Produto removido com sucesso.', 'success');[m
[32m+[m[32m    } catch (err) {[m
[32m+[m[32m        // fallback offline[m
[32m+[m[32m        products = products.filter(p => p.id !== productId);[m
[32m+[m[32m        localStorage.setItem('products', JSON.stringify(products));[m
[32m+[m[32m        renderProducts();[m
[32m+[m[32m        updateStats();[m
[32m+[m[32m        showMessage('Produto removido (offline)', 'success');[m
[32m+[m[32m    }[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction editProduct(productId) {[m
[32m+[m[32m    const product = products.find(p => p.id === productId);[m
[32m+[m[32m    if (!product) return;[m
[32m+[m
[32m+[m[32m    document.getElementById('productName').value = product.name;[m
[32m+[m[32m    document.getElementById('productDescription').value = product.description;[m
[32m+[m[32m    document.getElementById('productPrice').value = product.price;[m
[32m+[m[32m    document.getElementById('productQuantity').value = product.quantity;[m
[32m+[m[32m    document.getElementById('productCategory').value = product.category;[m
[32m+[m[32m    document.getElementById('productUnit').value = product.unit;[m
[32m+[m
[32m+[m[32m    editingId = productId;[m
[32m+[m[32m    const addBtn = document.getElementById('addBtn');[m
[32m+[m[32m    if (addBtn) addBtn.textContent = 'Salvar';[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction clearForm() {[m
[32m+[m[32m    const ids = ['productName','productDescription','productPrice','productQuantity','productCategory','productUnit'];[m
[32m+[m[32m    ids.forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });[m
[32m+[m[32m    editingId = null;[m
[32m+[m[32m    const addBtn = document.getElementById('addBtn'); if (addBtn) addBtn.textContent = '+ Adicionar';[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction showMessage(text, type) {[m
[32m+[m[32m    const container = document.getElementById('successMessage');[m
[32m+[m[32m    if (!container) return;[m
[32m+[m[32m    const className = type === 'success' ? 'success-message' : 'error-message';[m
[32m+[m[32m    container.innerHTML = '<div class="' + className + '">' + text + '</div>';[m
[32m+[m[32m    setTimeout(() => { container.innerHTML = ''; }, 3000);[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction updateStats() {[m
[32m+[m[32m    const totalEl = document.getElementById('totalProducts');[m
[32m+[m[32m    const valEl = document.getElementById('totalValue');[m
[32m+[m[32m    if (totalEl) totalEl.textContent = products.length;[m
[32m+[m[32m    const total = products.reduce((sum, p) => sum + (p.price * p.quantity), 0);[m
[32m+[m[32m    if (valEl) valEl.textContent = 'R$ ' + total.toFixed(2);[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction searchProducts() {[m
[32m+[m[32m    const el = document.getElementById('searchProduct');[m
[32m+[m[32m    if (!el) return renderProducts();[m
[32m+[m[32m    const searchTerm = el.value.trim().toLowerCase();[m
[32m+[m[32m    if (!searchTerm) { renderProducts(); return; }[m
[32m+[m
[32m+[m[32m    const exactMatches = products.filter(product =>[m
[32m+[m[32m        (product.name || '').toLowerCase() === searchTerm ||[m
[32m+[m[32m        (product.barcode || '').toLowerCase() === searchTerm ||[m
[32m+[m[32m        (product.category || '').toLowerCase() === searchTerm ||[m
[32m+[m[32m        String(product.id) === searchTerm[m
[32m+[m[32m    );[m
[32m+[m
[32m+[m[32m    if (exactMatches.length > 0) { renderFilteredProducts(exactMatches); return; }[m
[32m+[m
[32m+[m[32m    const filteredProducts = products.filter(product =>[m
[32m+[m[32m        (product.name || '').toLowerCase().includes(searchTerm) ||[m
[32m+[m[32m        (product.description || '').toLowerCase().includes(searchTerm) ||[m
[32m+[m[32m        (product.category || '').toLowerCase().includes(searchTerm) ||[m
[32m+[m[32m        (product.barcode || '').toLowerCase().includes(searchTerm)[m
[32m+[m[32m    );[m
[32m+[m
[32m+[m[32m    renderFilteredProducts(filteredProducts);[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mdocument.addEventListener('DOMContentLoaded', async () => {[m
[32m+[m[32m    const modal = document.getElementById('barcodeModal');[m
[32m+[m[32m    if (modal) modal.addEventListener('click', (e) => { if (e.target.id === 'barcodeModal') closeModal(); });[m
[32m+[m[32m    await fetchProductsFromServer();[m
[32m+[m[32m    renderProducts();[m
[32m+[m[32m    updateStats();[m
[32m+[m[32m    // expose for inline onclick handlers[m
[32m+[m[32m    window.addProduct = addProduct;[m
[32m+[m[32m    window.openBarcodeModal = openBarcodeModal;[m
[32m+[m[32m    window.closeModal = closeModal;[m
[32m+[m[32m    window.printBarcode = printBarcode;[m
[32m+[m[32m    window.deleteProduct = deleteProduct;[m
[32m+[m[32m    window.editProduct = editProduct;[m
[32m+[m[32m    window.clearForm = clearForm;[m
[32m+[m[32m    window.searchProducts = searchProducts;[m
[32m+[m[32m});[m
[1mdiff --git a/static/style.css b/static/style.css[m
[1mnew file mode 100644[m
[1mindex 0000000..d0918c9[m
[1m--- /dev/null[m
[1m+++ b/static/style.css[m
[36m@@ -0,0 +1,540 @@[m
[32m+[m[32m/* Bold modern theme with larger brand presence */[m
[32m+[m[32m*{ box-sizing: border-box; margin:0; padding:0 }[m
[32m+[m[32m:root {[m
[32m+[m[32m    /* Tema Escuro - Cores Base */[m
[32m+[m[32m    --primary: #e2e8f0;         /* Texto principal (claro) */[m
[32m+[m[32m    --secondary: #94a3b8;       /* Texto secund√°rio */[m
[32m+[m[32m    --accent: #3b82f6;          /* Destaque azul */[m
[32m+[m[41m    [m
[32m+[m[32m    /* Cores de A√ß√£o */[m
[32m+[m[32m    --action-alert: #ef4444;    /* Vermelho alertas */[m
[32m+[m[32m    --action-neutral: #4b5563;  /* Cinza neutro */[m
[32m+[m[41m    [m
[32m+[m[32m    /* Cores de Fundo */[m
[32m+[m[32m    --background: #0f172a;      /* Fundo escuro principal */[m
[32m+[m[32m    --card-background: #1e293b; /* Fundo dos cards */[m
[32m+[m[32m    --text-color: #f1f5f9;      /* Texto claro */[m
[32m+[m[32m    --drawer-bg: rgba(15,23,42,0.98); /* Menu lateral */[m
[32m+[m[41m    [m
[32m+[m[32m    /* Mantendo os mesmos efeitos */[m
[32m+[m[32m    --shadow-subtle: 0 8px 24px rgba(0, 0, 0, 0.2);[m
[32m+[m[32m    --border-radius: 6px;[m
[32m+[m[32m    --transition-speed: 0.3s;[m
[32m+[m
[32m+[m[32m    /* Cores auxiliares para compatibilidade */[m
[32m+[m[32m    --success: #10b981;[m
[32m+[m[32m    --danger: var(--action-alert);[m
[32m+[m[32m    --muted: #64748b;[m
[32m+[m[32m    --accent-1: #60a5fa;[m
[32m+[m[32m    --accent-2: #2563eb;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mhtml, body { height:100%; font-family: 'Inter', 'Georgia', sans-serif; background:var(--background); color:var(--text-color) }[m
[32m+[m[32m.container{ max-width:1200px; margin:36px auto; padding:24px }[m
[32m+[m
[32m+[m[32m/* Larger logo and striking header */[m
[32m+[m[32m.header .logo{ width:120px; height:auto; border-radius:14px; box-shadow: 0 12px 36px rgba(0,0,0,0.2) }[m
[32m+[m[32m.header{[m[41m [m
[32m+[m[32m    background: linear-gradient(135deg, rgba(59,130,246,0.08), rgba(29,78,216,0.04));[m[41m [m
[32m+[m[32m    backdrop-filter: blur(12px);[m
[32m+[m[32m    border: 1px solid rgba(255,255,255,0.06);[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m/* Header */[m
[32m+[m[32m.header{ display:flex; gap:18px; align-items:center; padding:18px; border-radius:12px; box-shadow:var(--shadow-subtle) }[m
[32m+[m[32m.header .logo{ width:84px; height:auto; border-radius:10px }[m
[32m+[m[32m.header h1{ font-size:20px; color:var(--text-color); margin-bottom:4px }[m
[32m+[m[32m.header p{ color:rgba(51,51,51,0.7); font-size:13px; margin:0 }[m
[32m+[m[32m.header .header-actions{ margin-left:auto; display:flex; gap:10px; align-items:center }[m
[32m+[m
[32m+[m[32m/* Panels */[m
[32m+[m[32m.panel{[m[41m [m
[32m+[m[32m    background: var(--card-background);[m
[32m+[m[32m    padding: 20px;[m[41m [m
[32m+[m[32m    border-radius: 12px;[m[41m [m
[32m+[m[32m    /* Mudando a sombra vermelha para uma mais suave */[m
[32m+[m[32m    box-shadow: 0 10px 30px rgba(15, 23, 42, 0.1);[m
[32m+[m[32m}[m
[32m+[m[32m.panel + .panel{ margin-top:18px }[m
[32m+[m[32m.panel h2{[m[41m [m
[32m+[m[32m    /* Mudando o texto vermelho para um tom mais profissional */[m
[32m+[m[32m    color: var(--primary);[m
[32m+[m[32m    font-size: 18px;[m[41m [m
[32m+[m[32m    margin-bottom: 16px;[m
[32m+[m[32m}[m
[32m+[m[32m/* decorative heading bar */[m
[32m+[m[32m.panel h2{ position:relative; padding-left:12px }[m
[32m+[m[32m.panel h2:before{ content:''; position:absolute; left:0; top:6px; width:6px; height:26px; border-radius:4px; background: linear-gradient(180deg,var(--accent-1),var(--accent-2)); box-shadow:0 6px 18px rgba(124,154,146,0.06) }[m
[32m+[m
[32m+[m[32m/* Layout */[m
[32m+[m[32m.main-grid{ display:grid; grid-template-columns: 1fr 420px; gap:20px; align-items:start }[m
[32m+[m[32m@media (max-width:980px){ .main-grid{ grid-template-columns: 1fr } }[m
[32m+[m
[32m+[m[32m/* Forms */[m
[32m+[m[32m.form-group{ margin-bottom:12px }[m
[32m+[m[32m.form-group label{ display:block; color:var(--muted); font-size:13px; margin-bottom:6px }[m
[32m+[m[32m.form-group input, .form-group textarea, .form-group select{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid #e6edf3; background:#fbfeff; font-size:14px; transition:box-shadow .18s, transform .12s }[m
[32m+[m[32m.form-group input:focus, .form-group textarea:focus, .form-group select:focus{ outline:none; box-shadow:0 6px 20px rgba(185,28,28,0.12); transform:translateY(-1px) }[m
[32m+[m[32m.form-row{ display:grid; grid-template-columns: 1fr 1fr; gap:12px }[m
[32m+[m
[32m+[m[32m/* Buttons */[m
[32m+[m[32m.btn{ display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 14px; border-radius:10px; border:0; cursor:pointer; font-weight:600; transition: transform .12s, box-shadow .12s }[m
[32m+[m[32m.btn:active{ transform:translateY(1px) }[m
[32m+[m
[32m+[m[32m/* Navega√ß√£o por grupos */[m
[32m+[m[32m.nav-group {[m[41m [m
[32m+[m[32m    margin: 15px 0;[m
[32m+[m[32m    padding-top: 15px;[m
[32m+[m[32m    border-top: 1px solid rgba(255,255,255,0.1);[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m.nav-group-title {[m
[32m+[m[32m    display: block;[m
[32m+[m[32m    color: #adacff;[m
[32m+[m[32m    font-size: 12px;[m
[32m+[m[32m    text-transform: uppercase;[m
[32m+[m[32m    letter-spacing: 0.5px;[m
[32m+[m[32m    margin: 0 15px 10px;[m
[32m+[m[32m    font-weight: 500;[m
[32m+[m[32m}[m
[32m+[m[32m.btn-primary{ background: var(--primary); color:white; box-shadow:0 8px 26px rgba(0,0,0,0.12) }[m
[32m+[m[32m.btn-secondary{ background: #f3f4f6; color:#111827; border:1px solid #e6edf3 }[m
[32m+[m[32m.btn-danger{ background:var(--danger); color:white }[m
[32m+[m[32m.btn-ghost{ background:transparent; color:var(--muted); border:1px dashed #e6edf3 }[m
[32m+[m[32m.btn:hover{ transform:translateY(-3px) }[m
[32m+[m
[32m+[m[32m/* Table */[m
[32m+[m[32m.table-wrap{ overflow:auto }[m
[32m+[m[32mtable{ width:100%; border-collapse:collapse; font-size:14px }[m
[32m+[m[32mth,td{ text-align:left; padding:12px 10px; border-bottom:1px solid #f1f5f9 }[m
[32m+[m[32mth{[m[41m [m
[32m+[m[32m    color: var(--primary);[m
[32m+[m[32m    font-weight: 700;[m
[32m+[m[32m    font-size: 13px;[m
[32m+[m[32m    background: linear-gradient(90deg, rgba(59,130,246,0.04), transparent);[m
[32m+[m[32m}[m
[32m+[m[32mtr:hover td{[m[41m [m
[32m+[m[32m    background: linear-gradient(90deg, rgba(59,130,246,0.02), transparent);[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m.action-buttons{ display:flex; gap:8px }[m
[32m+[m[32m.badge{ padding:6px 10px; border-radius:999px; font-weight:700; font-size:12px }[m
[32m+[m[32m.badge-success{ background: rgba(16, 185, 129, 0.1); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.2); }[m
[32m+[m[32m.badge-danger{ background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.2); }[m
[32m+[m
[32m+[m[32m/* Cards / Stats */[m
[32m+[m[32m.stats{ display:flex; gap:12px; margin-bottom:10px }[m
[32m+[m[32m.stat{ background:linear-gradient(180deg,#ffffff,#fbfdff); padding:12px 14px; border-radius:10px; box-shadow:0 8px 24px rgba(2,6,23,0.04) }[m
[32m+[m[32m.stat h3{ margin:0; font-size:14px }[m
[32m+[m[32m.stat p{ margin:6px 0 0; font-weight:700 }[m
[32m+[m
[32m+[m[32m/* small ornament under header */[m
[32m+[m[32m.header { border-bottom:1px solid rgba(0,0,0,0.04) }[m
[32m+[m
[32m+[m[32m/* little icon spacing for buttons */[m
[32m+[m[32m.btn svg, .btn img{ width:18px; height:18px; display:inline-block; vertical-align:middle }[m
[32m+[m[32m.btn{ gap:10px }[m
[32m+[m
[32m+[m[32m/* Modal */[m
[32m+[m[32m.modal{ display:none; position:fixed; inset:0; background: rgba(2,6,23,0.6); align-items:center; justify-content:center; z-index:90 }[m
[32m+[m[32m.modal {[m
[32m+[m[32m    background: rgba(15, 23, 42, 0.8);[m
[32m+[m[32m    backdrop-filter: blur(8px);[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m.modal-content {[m
[32m+[m[32m    background: var(--card-background);[m
[32m+[m[32m    border: 1px solid rgba(255, 255, 255, 0.05);[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m/* Etiqueta e √°rea de impress√£o */[m
[32m+[m[32m.print-area {[m
[32m+[m[32m    padding: 10px;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m.etiqueta {[m
[32m+[m[32m    width: 5cm; /* 5cm largura */[m
[32m+[m[32m    height: 3cm; /* 3cm altura */[m
[32m+[m[32m    background: white;[m
[32m+[m[32m    padding: 0.2cm;[m
[32m+[m[32m    display: flex;[m
[32m+[m[32m    flex-direction: column;[m
[32m+[m[32m    align-items: center;[m
[32m+[m[32m    justify-content: center;[m
[32m+[m[32m    margin: 0 auto;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m#printBarcodeImg {[m
[32m+[m[32m    width: 4.6cm; /* Deixa margem para a borda */[m
[32m+[m[32m    height: auto;[m
[32m+[m[32m    margin-bottom: 0.2cm;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m.product-name {[m
[32m+[m[32m    font-size: 24px;[m
[32m+[m[32m    text-align: center;[m
[32m+[m[32m    margin-top: -0.5cm;[m
[32m+[m[32m    font-family: Arial, sans-serif;[m
[32m+[m[32m    word-wrap: break-word;[m
[32m+[m[32m    width: 100%;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m/* Media Query para Impress√£o */[m
[32m+[m[32m@media print {[m
[32m+[m[32m    body * {[m
[32m+[m[32m        visibility: hidden;[m
[32m+[m[32m    }[m
[32m+[m[32m    .print-area, .print-area * {[m
[32m+[m[32m        visibility: visible;[m
[32m+[m[32m    }[m
[32m+[m[32m    .print-area {[m
[32m+[m[32m        position: absolute;[m
[32m+[m[32m        left: 0;[m
[32m+[m[32m        top: 0;[m
[32m+[m[32m        padding: 0;[m
[32m+[m[32m    }[m
[32m+[m[32m    .modal {[m
[32m+[m[32m        background: none;[m
[32m+[m[32m        align-items: flex-start;[m
[32m+[m[32m        justify-content: flex-start;[m
[32m+[m[32m    }[m
[32m+[m[32m    .modal-content {[m
[32m+[m[32m        box-shadow: none;[m
[32m+[m[32m        padding: 0;[m
[32m+[m[32m        margin: 0;[m
[32m+[m[32m    }[m
[32m+[m[32m    .btn {[m
[32m+[m[32m        display: none;[m
[32m+[m[32m    }[m
[32m+[m[32m}[m
[32m+[m[32m.modal.active { display: flex; }[m
[32m+[m
[32m+[m[32m.print-modal-content {[m
[32m+[m[32m    background: white;[m
[32m+[m[32m    padding: 20px;[m
[32m+[m[32m    border-radius: 8px;[m
[32m+[m[32m    min-width: 400px;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m/* √Årea de impress√£o */[m
[32m+[m[32m.print-area {[m
[32m+[m[32m    background: var(--card-background);[m
[32m+[m[32m    box-shadow: 0 8px 24px rgba(15, 23, 42, 0.2);[m
[32m+[m[32m    padding: 20px;[m
[32m+[m[32m    display: flex;[m
[32m+[m[32m    justify-content: center;[m
[32m+[m[32m    align-items: center;[m
[32m+[m[32m    min-height: 200px;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m.print-area img {[m
[32m+[m[32m    max-width: 300px;[m
[32m+[m[32m    height: auto;[m
[32m+[m[32m    display: block;[m
[32m+[m[32m    margin: 0 auto;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m/* Ajustes para impress√£o */[m
[32m+[m[32m@media print {[m
[32m+[m[32m    body * {[m
[32m+[m[32m        visibility: hidden;[m
[32m+[m[32m    }[m
[32m+[m[32m    .print-area, .print-area * {[m
[32m+[m[32m        visibility: visible;[m
[32m+[m[32m    }[m
[32m+[m[32m    .print-area {[m
[32m+[m[32m        position: fixed;[m
[32m+[m[32m        left: 0;[m
[32m+[m[32m        top: 0;[m
[32m+[m[32m        width: 100%;[m
[32m+[m[32m        height: 100%;[m
[32m+[m[32m        margin: 0;[m
[32m+[m[32m        padding: 0;[m
[32m+[m[32m    }[m
[32m+[m[32m    .print-modal-content {[m
[32m+[m[32m        border: none;[m
[32m+[m[32m        box-shadow: none;[m
[32m+[m[32m    }[m
[32m+[m[32m    .btn-secondary {[m
[32m+[m[32m        display: none;[m
[32m+[m[32m    }[m
[32m+[m[32m}[m
[32m+[m[32m.modal.active { display: flex; }[m
[32m+[m
[32m+[m[32m/* √Årea de impress√£o */[m
[32m+[m[32m.print-area {[m
[32m+[m[32m    background: white;[m
[32m+[m[32m    padding: 20px;[m
[32m+[m[32m    display: flex;[m
[32m+[m[32m    justify-content: center;[m
[32m+[m[32m    align-items: center;[m
[32m+[m[32m    min-height: 200px;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m/* Ajustes para impress√£o */[m
[32m+[m[32m@media print {[m
[32m+[m[32m    body * {[m
[32m+[m[32m        visibility: hidden;[m
[32m+[m[32m    }[m
[32m+[m[32m    .print-area, .print-area * {[m
[32m+[m[32m        visibility: visible;[m
[32m+[m[32m    }[m
[32m+[m[32m    .print-area {[m
[32m+[m[32m        position: fixed;[m
[32m+[m[32m        left: 0;[m
[32m+[m[32m        top: 0;[m
[32m+[m[32m        width: 100%;[m
[32m+[m[32m        height: 100%;[m
[32m+[m[32m    }[m
[32m+[m[32m    .print-modal-content {[m
[32m+[m[32m        border: none;[m
[32m+[m[32m        box-shadow: none;[m
[32m+[m[32m        padding: 0;[m
[32m+[m[32m    }[m
[32m+[m[32m}[m
[32m+[m[32m.modal.active{ display:flex }[m
[32m+[m[32m.modal-content{ width:100%; max-width:520px; background:var(--card); padding:20px; border-radius:12px }[m
[32m+[m
[32m+[m[32m/* small utilities */[m
[32m+[m[32m.muted{ color:var(--muted) }[m
[32m+[m[32m.text-center{ text-align:center }[m
[32m+[m
[32m+[m[32m/* Alerts */[m
[32m+[m[32m.alert{ padding:10px 14px; border-radius:8px; margin-bottom:12px; font-weight:600 }[m
[32m+[m[32m.alert-success{[m[41m [m
[32m+[m[32m    background: rgba(16, 185, 129, 0.1);[m[41m [m
[32m+[m[32m    color: #10b981;[m[41m [m
[32m+[m[32m    border: 1px solid rgba(16, 185, 129, 0.2);[m[41m [m
[32m+[m[32m}[m
[32m+[m[32m.alert-danger{[m[41m [m
[32m+[m[32m    background: rgba(239, 68, 68, 0.1);[m[41m [m
[32m+[m[32m    color: #ef4444;[m[41m [m
[32m+[m[32m    border: 1px solid rgba(239, 68, 68, 0.2);[m[41m [m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m/* Side Drawer Navigation */[m
[32m+[m[32m.side-drawer {[m
[32m+[m[32m        position: fixed;[m
[32m+[m[32m        top: 0;[m
[32m+[m[32m        left: 0;[m
[32m+[m[32m        width: 300px;[m
[32m+[m[32m        height: 100vh;[m
[32m+[m[32m        background: var(--drawer-bg);[m
[32m+[m[32m        box-shadow: var(--shadow-subtle);[m
[32m+[m[32m        color: var(--background);[m
[32m+[m[32m        transition: transform var(--transition-speed) ease;[m
[32m+[m[32m        z-index: 1000;[m
[32m+[m[32m        padding: 20px;[m
[32m+[m[32m        display: flex;[m
[32m+[m[32m        flex-direction: column;[m
[32m+[m[32m        gap: 12px;[m
[32m+[m[32m        transform: translateX(-100%);[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m.side-drawer.active { transform: translateX(0); }[m
[32m+[m
[32m+[m[32m.side-drawer .drawer-logo { border-bottom: 1px solid rgba(255,255,255,0.06); margin-bottom: 15px; padding-bottom:12px }[m
[32m+[m
[32m+[m[32m.side-drawer a { color: var(--text-color); text-decoration: none; padding: 14px 25px; display:flex; align-items:center; gap:15px; transition: background-color var(--transition-speed), transform 0.2s ease-out }[m
[32m+[m[32m.side-drawer a:hover {[m[41m [m
[32m+[m[32m    background-color: rgba(59,130,246,0.08);[m
[32m+[m[32m    transform: translateX(5px);[m
[32m+[m[32m    font-weight: 500;[m
[32m+[m[32m}[m
[32m+[m[32m.side-drawer a.active { background-color: var(--primary); box-shadow: inset 5px 0 0 0 var(--accent); color: var(--card-background); font-weight:700 }[m
[32m+[m
[32m+[m[32m.side-drawer .nav-item { display:flex; align-items:center; gap:12px }[m
[32m+[m[32m.side-drawer .nav-item i { width:24px; text-align:center }[m
[32m+[m
[32m+[m[32m.drawer-handle { position: absolute; top: 50%; right: -28px; width:28px; height:68px; background: var(--primary); border-radius: 0 8px 8px 0; display:flex; align-items:center; justify-content:center; color:var(--card-background); cursor:pointer; transform:translateY(-50%) }[m
[32m+[m[32m.drawer-handle:after { content: '‚â°'; font-size:20px }[m
[32m+[m
[32m+[m[32m/* Drawer Handle */[m
[32m+[m[32m.drawer-handle {[m
[32m+[m[32m  position: absolute;[m
[32m+[m[32m  top: 50%;[m
[32m+[m[32m  right: -24px;[m
[32m+[m[32m  width: 24px;[m
[32m+[m[32m  height: 60px;[m
[32m+[m[32m  background: var(--accent-1);[m
[32m+[m[32m  border-radius: 0 8px 8px 0;[m
[32m+[m[32m  display: flex;[m
[32m+[m[32m  align-items: center;[m
[32m+[m[32m  justify-content: center;[m
[32m+[m[32m  color: white;[m
[32m+[m[32m  cursor: pointer;[m
[32m+[m[32m  transform: translateY(-50%);[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m.drawer-handle:after {[m
[32m+[m[32m  content: "‚â°";[m
[32m+[m[32m  font-size: 20px;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m/* Logo in drawer */[m
[32m+[m[32m.side-drawer .drawer-logo {[m
[32m+[m[32m  padding: 20px 0;[m
[32m+[m[32m  text-align: center;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m.side-drawer .drawer-logo img {[m
[32m+[m[32m  width: 100px;[m
[32m+[m[32m  height: auto;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m/* Floating fullscreen button */[m
[32m+[m[32m#floatingFullscreen{ position:fixed; left:16px; bottom:16px; z-index:2000; padding:10px 12px; border-radius:10px; background:var(--card); border:1px solid #eef2ff; box-shadow:0 8px 24px rgba(2,6,23,0.06); cursor:pointer }[m
[32m+[m[32m#floatingFullscreen {[m
[32m+[m[32m    background: var(--card-background);[m
[32m+[m[32m    border: 1px solid rgba(255, 255, 255, 0.05);[m
[32m+[m[32m    box-shadow: 0 8px 24px rgba(15, 23, 42, 0.12);[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m/* subtle entrance animation for panels */[m
[32m+[m[32m@keyframes fadeInUp{ from{ opacity:0; transform:translateY(8px) } to{ opacity:1; transform:none } }[m
[32m+[m[32m.panel{ animation: fadeInUp .28s ease both }[m
[32m+[m
[32m+[m[32m/* Button primary with border/shine animation */[m
[32m+[m[32m.button-primary, .btn-primary {[m
[32m+[m[32m    background: var(--primary);[m
[32m+[m[32m    color: var(--card-background);[m
[32m+[m[32m    border: 2px solid var(--primary);[m
[32m+[m[32m    border-radius: var(--border-radius);[m
[32m+[m[32m    padding: 10px 20px;[m
[32m+[m[32m    cursor: pointer;[m
[32m+[m[32m    position: relative;[m
[32m+[m[32m    overflow: hidden;[m
[32m+[m[32m    transition: all var(--transition-speed);[m
[32m+[m[32m}[m
[32m+[m[32m.button-primary::after, .btn-primary::after {[m
[32m+[m[32m    content: '';[m
[32m+[m[32m    position: absolute;[m
[32m+[m[32m    width: 100%;[m
[32m+[m[32m    height: 100%;[m
[32m+[m[32m    top: 0; left: 0;[m
[32m+[m[32m    background-color: rgba(255,255,255,0.12);[m
[32m+[m[32m    transform: scaleX(0);[m
[32m+[m[32m    transform-origin: left;[m
[32m+[m[32m    transition: transform 0.4s ease-out;[m
[32m+[m[32m    z-index:1;[m
[32m+[m[32m}[m
[32m+[m[32m.button-primary:hover::after, .btn-primary:hover::after { transform: scaleX(1); }[m
[32m+[m[32m.button-primary:hover, .btn-primary:hover {[m[41m [m
[32m+[m[32m    box-shadow: 0 8px 30px rgba(59,130,246,0.2);[m
[32m+[m[32m    transform: translateY(-2px)[m[41m [m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m/* Bot√£o de Remover/Excluir */[m
[32m+[m[32m.button-alert, .btn-danger {[m
[32m+[m[32m    background: var(--action-alert);[m
[32m+[m[32m    color: var(--text-color);[m
[32m+[m[32m    border: none;[m
[32m+[m[32m    border-radius: var(--border-radius);[m
[32m+[m[32m    padding: 10px 20px;[m
[32m+[m[32m    cursor: pointer;[m
[32m+[m[32m    transition: all var(--transition-speed);[m
[32m+[m[32m    position: relative;[m
[32m+[m[32m    overflow: hidden;[m
[32m+[m[32m}[m
[32m+[m[32m.button-alert:hover, .btn-danger:hover {[m
[32m+[m[32m    background: #FF4500;[m
[32m+[m[32m    box-shadow: 0 4px 10px rgba(220, 20, 60, 0.5);[m
[32m+[m[32m    transform: translateY(-1px);[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m/* Bot√£o de Cancelar/Imprimir (Neutro) */[m
[32m+[m[32m.button-neutral, .btn-secondary {[m
[32m+[m[32m    background: var(--action-neutral);[m
[32m+[m[32m    color: var(--text-color);[m
[32m+[m[32m    border: 2px solid var(--action-neutral);[m
[32m+[m[32m    border-radius: var(--border-radius);[m
[32m+[m[32m    padding: 10px 20px;[m
[32m+[m[32m    cursor: pointer;[m
[32m+[m[32m    transition: all var(--transition-speed);[m
[32m+[m[32m    position: relative;[m
[32m+[m[32m    overflow: hidden;[m
[32m+[m[32m}[m
[32m+[m[32m.button-neutral:hover, .btn-secondary:hover {[m
[32m+[m[32m    background: #666666;[m
[32m+[m[32m    box-shadow: 0 4px 10px rgba(85, 85, 85, 0.5);[m
[32m+[m[32m    transform: translateY(-1px);[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m/* Falling box and toast styles */[m
[32m+[m[32m.falling-box { background: var(--accent); color: #222; padding:8px 12px; border-radius:8px; box-shadow:0 8px 24px rgba(0,0,0,0.08) }[m
[32m+[m[32m.toast-success { background: rgba(16, 185, 129, 0.1); color: var(--text-color); box-shadow: 0 8px 26px rgba(16, 185, 129, 0.12) }[m
[32m+[m
[32m+[m[32m/* Garantia de contraste para texto */[m
[32m+[m[32m.header h1, .header p,[m
[32m+[m[32m.card h1, .card h2, .card h3, .card p, .card label,[m
[32m+[m[32m.form-group label, .nav-group-title {[m
[32m+[m[32m    color: var(--text-color);[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m/* Form elements com contraste */[m
[32m+[m[32minput[type="text"],[m
[32m+[m[32minput[type="number"],[m
[32m+[m[32mselect, textarea {[m
[32m+[m[32m    background-color: #444444;[m
[32m+[m[32m    color: var(--text-color);[m
[32m+[m[32m    border: 1px solid #555555;[m
[32m+[m[32m    border-radius: var(--border-radius);[m
[32m+[m[32m    padding: 8px 12px;[m
[32m+[m[32m}[m
[32m+[m[32minput[type="text"]:focus,[m
[32m+[m[32minput[type="number"]:focus,[m
[32m+[m[32mselect:focus, textarea:focus {[m
[32m+[m[32m    border-color: var(--primary);[m
[32m+[m[32m    box-shadow: 0 0 0 2px rgba(178, 34, 34, 0.2);[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m/* Cards / Modules for dark theme */[m
[32m+[m[32m.card {[m
[32m+[m[32m    background-color: var(--card-background);[m
[32m+[m[32m    border-radius: var(--border-radius);[m
[32m+[m[32m    box-shadow: var(--shadow-subtle);[m
[32m+[m[32m    padding: 20px;[m
[32m+[m[32m    transition: transform var(--transition-speed), background-color var(--transition-speed);[m
[32m+[m[32m}[m
[32m+[m[32m.card:hover {[m[41m [m
[32m+[m[32m    background-color: var(--card-background);[m
[32m+[m[32m    transform: translateY(-2px);[m
[32m+[m[32m    box-shadow: 0 12px 36px rgba(15, 23, 42, 0.12);[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m/* Elementos de Formul√°rio (Melhora o contraste) */[m
[32m+[m[32minput[type="text"],[m
[32m+[m[32minput[type="number"],[m
[32m+[m[32mselect, textarea {[m
[32m+[m[32m    background-color: #444444; /* Fundo do input mais claro que o card */[m
[32m+[m[32m    color: var(--text-color);[m
[32m+[m[32m    border: 1px solid #555555;[m
[32m+[m[32m    border-radius: var(--border-radius);[m
[32m+[m[32m    padding: 8px 12px;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m/* Cards hover floating effect */[m
[32m+[m[32m.stat{ transition: box-shadow 0.3s, transform 0.3s }[m
[32m+[m[32m.stat:hover{ box-shadow: var(--shadow-subtle); transform: translateY(-4px) }[m
[32m+[m
[32m+[m[32m/* Responsive tweaks */[m
[32m+[m[32m@media (max-width:700px){ .header{ flex-direction:column; align-items:flex-start } .header .header-actions{ width:100%; justify-content:space-between } .form-row{ grid-template-columns:1fr } }[m
[32m+[m
[32m+[m[32m/* small adjustments for forms and index actions */[m
[32m+[m[32m.actions{ display:flex; gap:10px; flex-wrap:wrap }[m
[32m+[m
[32m+[m[32m/* DataTables compatibility minor overrides */[m
[32m+[m[32m.dataTables_wrapper .dataTables_paginate .paginate_button{ background:transparent; border:0 }[m
[32m+[m
[32m+[m[32m/* end of unified stylesheet */[m
[32m+[m
[32m+[m[32m/* Print modal & print rules for labels */[m
[32m+[m[32m.print-modal-content{ max-width:360px; padding:16px }[m
[32m+[m[32m.print-area{ width:50mm; height:30mm; margin:0 auto; display:block; background:#fff; padding:6px; border-radius:6px; box-shadow:0 8px 20px rgba(0,0,0,0.06); }[m
[32m+[m
[32m+[m[32m/* When printing, hide all except the print-area so the printer prints only the label at correct size */[m
[32m+[m[32m@media print{[m
[32m+[m[32m  body *{ visibility: hidden !important }[m
[32m+[m[32m  .print-area, .print-area * { visibility: visible !important }[m
[32m+[m[32m  .print-area{ position: absolute !important; left: 0; top: 0; margin: 0; }[m
[32m+[m[32m}[m
