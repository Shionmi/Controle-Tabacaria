{% extends "base.html" %}

{% block title %}Histórico de Movimentações{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css">
<style>
    /* Custom overrides for DataTables to match theme */
    .dataTables_wrapper .dataTables_length, 
    .dataTables_wrapper .dataTables_filter, 
    .dataTables_wrapper .dataTables_info, 
    .dataTables_wrapper .dataTables_processing, 
    .dataTables_wrapper .dataTables_paginate {
        color: var(--text-muted) !important;
        margin-bottom: 16px;
    }
    .dataTables_wrapper .dataTables_filter input {
        background: rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.1);
        color: var(--text-main);
        border-radius: var(--radius-sm);
        padding: 6px 12px;
    }
    table.dataTable tbody tr { background-color: transparent !important; }
    table.dataTable tbody td { border-color: rgba(255,255,255,0.05) !important; }

    .filter-grid {
        display: grid;
        grid-template-columns: 1fr auto auto auto auto;
        gap: 16px;
        align-items: end;
        margin-bottom: 24px;
        background: var(--bg-card);
        padding: 20px;
        border-radius: var(--radius-md);
        border: 1px solid rgba(255,255,255,0.05);
    }

    @media (max-width: 1024px) {
        .filter-grid {
            grid-template-columns: 1fr;
        }
    }

    .form-group label {
        color: var(--text-muted);
        font-size: 0.85rem;
        margin-bottom: 6px;
        display: block;
        font-weight: 500;
    }

    .form-group input {
        background: var(--bg-body);
        border: 1px solid rgba(255,255,255,0.1);
        color: var(--text-main);
        border-radius: var(--radius-sm);
        padding: 10px 12px;
        width: 100%;
        height: 42px;
    }

    .form-group input:focus {
        border-color: var(--accent-primary);
    }

    .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    .status-entrada { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
    .status-saida { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-title">
        <h1>Histórico de Movimentações</h1>
        <p>Entradas e saídas de estoque</p>
    </div>
</div>

<div id="movAlert"></div>

<div class="filter-grid">
    <div class="form-group" style="margin-bottom: 0;">
        <label>Pesquisar</label>
        <input id="q" placeholder="Produto ou observação..." autocomplete="off">
    </div>
    <div class="form-group" style="margin-bottom: 0;">
        <label>Data Início</label>
        <input id="start_date" type="date">
    </div>
    <div class="form-group" style="margin-bottom: 0;">
        <label>Data Fim</label>
        <input id="end_date" type="date">
    </div>
    <button class="btn btn-primary" id="btnFilter" style="height: 42px;">
        <i class="fas fa-filter"></i> Filtrar
    </button>
    <button class="btn btn-secondary" id="btnClear" style="height: 42px;">
        <i class="fas fa-times"></i> Limpar
    </button>
</div>

<div class="panel">
    <h2>Movimentações</h2>
    <div style="overflow-x: auto;">
        <table id="tabelaMovimentacoes" class="display" style="width:100%">
            <thead>
                <tr>
                    <th>ID Venda</th>
                    <th>Cliente / Produto</th>
                    <th>Tipo</th>
                    <th>Qtd</th>
                    <th>Data</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody id="tabela">
                <!-- Populated by JS -->
            </tbody>
        </table>
    </div>
</div>

<!-- Modal de Detalhes -->
<div class="modal" id="detailsModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Detalhes da Movimentação</h2>
            <button class="close-modal" onclick="closeDetailsModal()">&times;</button>
        </div>
        <div class="modal-body" id="modalBodyContent">
            <!-- Populated by JS -->
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeDetailsModal()">Fechar</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
<script>
    const API = '/api/movimentacoes';
    const tableBody = document.getElementById('tabela');
    const movAlert = document.getElementById('movAlert');
    let movimentacoesCache = {};
    let tabelaDT = null;

    function showAlert(msg, ok=true){ 
        movAlert.innerHTML = `<div style="padding: 12px; margin-bottom: 16px; border-radius: var(--radius-sm); background: ${ok ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)'}; color: ${ok ? '#10b981' : '#ef4444'}; border: 1px solid ${ok ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)'};">${msg}</div>`; 
        setTimeout(()=>movAlert.innerHTML='',5000); 
    }

    async function loadMov(limit=1000){ // Increased limit for DataTables
        try{
            const q = document.getElementById('q').value.trim();
            const start = document.getElementById('start_date').value || null;
            const end = document.getElementById('end_date').value || null;
            const params = new URLSearchParams();
            if(limit) params.set('limit', limit);
            if(q) params.set('q', q);
            if(start) params.set('start_date', start + ' 00:00:00');
            if(end) params.set('end_date', end + ' 23:59:59');

            const res = await fetch(API + '?' + params.toString());
            if(!res.ok) throw new Error('Falha ao carregar movimentações');
            const data = await res.json();
            
            // Clear cache
            movimentacoesCache = {};
            data.forEach(m => movimentacoesCache[m.id_mov] = m);

            // Destroy existing DataTable
            if ($.fn.DataTable.isDataTable('#tabelaMovimentacoes')) {
                $('#tabelaMovimentacoes').DataTable().destroy();
            }

            tableBody.innerHTML = '';

            if(!data.length) { 
                // Let DataTables handle empty state or show custom message
                // But if we init DataTables on empty table, it shows "No data available"
            } else {
                data.forEach(m => {
                    let vendaIdDisplay = '-';
                    let mainInfo = m.produto_nome || '?';
                    
                    if(m.venda){
                        vendaIdDisplay = `<span style="color: var(--accent-gold); font-weight: bold;">#${m.venda.id_venda}</span>`;
                        mainInfo = m.venda.cliente_nome;
                    } else {
                        mainInfo = `<span style="color: var(--text-muted);">${m.produto_nome}</span>`;
                    }

                    const tipoClass = m.tipo === 'entrada' ? 'status-entrada' : 'status-saida';
                    
                    tableBody.innerHTML += `
                        <tr>
                            <td>${vendaIdDisplay}</td>
                            <td>${mainInfo}</td>
                            <td><span class="status-badge ${tipoClass}">${m.tipo.toUpperCase()}</span></td>
                            <td>${m.quantidade}</td>
                            <td>${new Date(m.data_mov).toLocaleString('pt-BR')}</td>
                            <td>
                                <button class="btn btn-info" style="padding: 6px 10px;" onclick="openDetailsModal(${m.id_mov})" title="Detalhes">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
            }

            // Initialize DataTable
            tabelaDT = $('#tabelaMovimentacoes').DataTable({
                language: { url: '//cdn.datatables.net/plug-ins/1.13.5/i18n/pt-BR.json' },
                pageLength: 10,
                lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Todos"]],
                order: [[4, 'desc']] // Order by Date desc
            });

        } catch(err){
            console.error(err);
            showAlert('Erro ao carregar dados', false);
        }
    }

    function openDetailsModal(id){
        const m = movimentacoesCache[id];
        if(!m) return;

        const modalBody = document.getElementById('modalBodyContent');
        let content = '';

        if(m.venda){
            const valorItem = (m.produto_preco || 0) * m.quantidade;
            content = `
                <div style="margin-bottom: 16px;">
                    <h3 style="color: var(--accent-gold); margin-bottom: 8px;">Venda #${m.venda.id_venda}</h3>
                    <p><strong>Cliente:</strong> ${m.venda.cliente_nome}</p>
                    <p><strong>Data:</strong> ${new Date(m.venda.data_venda).toLocaleString('pt-BR')}</p>
                    <p><strong>Forma de Pagamento:</strong> ${m.venda.forma_pagamento || 'Não especificado'}</p>
                    <p><strong>Total da Venda:</strong> R$ ${Number(m.venda.total || 0).toFixed(2)}</p>
                </div>
                <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: var(--radius-sm);">
                    <h4 style="margin-bottom: 8px;">Item Movimentado</h4>
                    <p><strong>Produto:</strong> ${m.produto_nome}</p>
                    <p><strong>Quantidade:</strong> ${m.quantidade}</p>
                    <p><strong>Valor Unitário (aprox):</strong> R$ ${Number(m.produto_preco || 0).toFixed(2)}</p>
                    <p><strong>Subtotal Item:</strong> R$ ${valorItem.toFixed(2)}</p>
                </div>
            `;
        } else {
            content = `
                <div style="margin-bottom: 16px;">
                    <h3 style="color: var(--text-main); margin-bottom: 8px;">Movimentação Manual / Outra</h3>
                    <p><strong>Produto:</strong> ${m.produto_nome}</p>
                    <p><strong>Tipo:</strong> <span class="status-badge ${m.tipo === 'entrada' ? 'status-entrada' : 'status-saida'}">${m.tipo.toUpperCase()}</span></p>
                    <p><strong>Quantidade:</strong> ${m.quantidade}</p>
                    <p><strong>Data:</strong> ${new Date(m.data_mov).toLocaleString('pt-BR')}</p>
                </div>
                <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: var(--radius-sm);">
                    <h4 style="margin-bottom: 8px;">Observações</h4>
                    <p>${m.observacao || 'Sem observações'}</p>
                </div>
            `;
        }

        modalBody.innerHTML = content;
        document.getElementById('detailsModal').classList.add('active');
    }

    function closeDetailsModal(){
        document.getElementById('detailsModal').classList.remove('active');
    }

    document.getElementById('btnFilter').addEventListener('click', () => loadMov(1000));
    document.getElementById('btnClear').addEventListener('click', () => {
        document.getElementById('q').value = '';
        document.getElementById('start_date').value = '';
        document.getElementById('end_date').value = '';
        loadMov(1000);
    });

    // Initial load
    document.addEventListener('DOMContentLoaded', () => loadMov(1000));
</script>
{% endblock %}
