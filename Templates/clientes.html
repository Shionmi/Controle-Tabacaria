{% extends "base.html" %}

{% block title %}Clientes - Tabacaria{% endblock %}

{% block content %}
<div class="header">
    <img src="{{ url_for('static', filename='Images/Logo_tabacaria.png') }}" alt="Logo" class="logo">
    <div>
        <h1 style="font-size:20px;">Gerenciamento de Clientes</h1>
        <p style="color:#999;margin-top:6px">Lista de clientes cadastrados</p>
    </div>
</div>

<div class="panel">
    <div class="action-bar">
    <input type="text" id="busca" placeholder="Buscar cliente..." class="search-input">
    <button type="button" class="btn btn-primary" onclick="window.location.href='/registrar_cliente'">Novo Cliente</button>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>CPF</th>
                    <th>Telefone</th>
                    <th>Email</th>
                    <th>Cidade</th>
                    <th>Estado</th>
                    <th>√öltima Compra</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
                    <tbody id="lista-clientes">
                    </tbody>
                </table>
            </div>
        </div>
        
        <script>
                async function carregarClientes() {
            try {
                const res = await fetch('/api/clientes');
                if (!res.ok) throw new Error('Erro ao carregar clientes');
                const clientes = await res.json();
        
                const tbody = document.getElementById('lista-clientes');
                tbody.innerHTML = '';
        
                clientes.forEach(c => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${c.nome}</td>
                            <td>${c.cpf || '-'}</td>
                            <td>${c.telefone}</td>
                            <td>${c.email || '-'}</td>
                            <td>${c.cidade || '-'}</td>
                            <td>${c.estado || '-'}</td>
                            <td>${c.ultima_compra || '-'}</td>
                            <td>
                                <button class="btn btn-primary" onclick="editarCliente(${c.id_cliente})">‚úèÔ∏è Editar</button>
                                <button class="btn btn-danger" onclick="excluirCliente(${c.id_cliente})">üóëÔ∏è Excluir</button>
                            </td>
                        </tr>
                    `;
                });
        
                if (clientes.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center">Nenhum cliente cadastrado</td></tr>';
                }
        
            } catch (err) {
                console.error(err);
                document.getElementById('lista-clientes').innerHTML = 
                    '<tr><td colspan="8" style="text-align:center;color:red">Erro ao carregar clientes</td></tr>';
            }
        }

        // Editar cliente
        async function editarCliente(id) {
            try {
                const res = await fetch(`/api/clientes/${id}`);
                if (!res.ok) throw new Error('Cliente n√£o encontrado');
        
                const cliente = await res.json();
        
                document.getElementById('edit-id').value = cliente.id_cliente;
                document.getElementById('edit-nome').value = cliente.nome || '';
                document.getElementById('edit-cpf').value = cliente.cpf || '';
                document.getElementById('edit-telefone').value = cliente.telefone || '';
                document.getElementById('edit-email').value = cliente.email || '';
                document.getElementById('edit-endereco').value = cliente.endereco || '';
                document.getElementById('edit-cidade').value = cliente.cidade || '';
                document.getElementById('edit-estado').value = cliente.estado || '';
                document.getElementById('edit-observacoes').value = cliente.observacoes || '';
        
                document.getElementById('modal-edicao').classList.add('active');
            } catch (err) {
                console.error(err);
                alert('Erro ao carregar dados do cliente');
            }
        }

        // Excluir cliente
        async function excluirCliente(id) {
            if (!confirm('Tem certeza que deseja excluir este cliente?')) return;
    
            try {
                const res = await fetch(`/api/clientes/${id}`, { method: 'DELETE' });
                if (!res.ok) throw new Error('Erro ao excluir cliente');
        
                alert('Cliente exclu√≠do com sucesso!');
                carregarClientes();
            } catch (err) {
                console.error(err);
                alert('Erro ao excluir cliente');
            }
        }

        // Fechar modal
        function fecharModal() {
            document.getElementById('modal-edicao').classList.remove('active');
        }

        // Handle edi√ß√£o
        document.getElementById('form-editar').addEventListener('submit', async (e) => {
            e.preventDefault();
    
            const id = document.getElementById('edit-id').value;
            const cliente = {
                nome: document.getElementById('edit-nome').value.trim(),
                cpf: document.getElementById('edit-cpf').value.trim(),
                telefone: document.getElementById('edit-telefone').value.trim(),
                email: document.getElementById('edit-email').value.trim(),
                endereco: document.getElementById('edit-endereco').value.trim(),
                cidade: document.getElementById('edit-cidade').value.trim(),
                estado: document.getElementById('edit-estado').value.trim().toUpperCase(),
                observacoes: document.getElementById('edit-observacoes').value.trim()
            };
    
            try {
                const res = await fetch(`/api/clientes/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(cliente)
                });
        
                const data = await res.json();
        
                if (res.ok) {
                    alert('Cliente atualizado com sucesso!');
                    fecharModal();
                    carregarClientes();
                } else {
                    alert(data.erro || 'Erro ao atualizar cliente');
                }
            } catch (err) {
                console.error(err);
                alert('Erro ao atualizar cliente');
            }
        });

        // Busca
        document.getElementById('busca').addEventListener('input', (e) => {
            const busca = e.target.value.toLowerCase();
            const linhas = document.querySelectorAll('#lista-clientes tr');
    
            linhas.forEach(linha => {
                const texto = linha.textContent.toLowerCase();
                linha.style.display = texto.includes(busca) ? '' : 'none';
            });
        });
</script>

                <!-- Preenchido via JavaScript -->
            </tbody>
        </table>
    </div>
</div>

<!-- Modal de Edi√ß√£o -->
<div id="modal-edicao" class="modal">
    <div class="modal-content">
        <h2>Editar Cliente</h2>
        <form id="form-editar">
            <input type="hidden" id="edit-id">
            
            <div class="form-row">
                <div class="form-group">
                    <label for="edit-nome">Nome</label>
                    <input id="edit-nome" required>
                </div>
                <div class="form-group">
                    <label for="edit-cpf">CPF</label>
                    <input id="edit-cpf">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="edit-telefone">Telefone</label>
                    <input id="edit-telefone" required type="tel">
                </div>
                <div class="form-group">
                    <label for="edit-email">E-mail</label>
                    <input id="edit-email" type="email">
                </div>
            </div>

            <div class="form-group">
                <label for="edit-endereco">Endere√ßo</label>
                <input id="edit-endereco">
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="edit-cidade">Cidade</label>
                    <input id="edit-cidade">
                </div>
                <div class="form-group">
                    <label for="edit-estado">Estado</label>
                    <input id="edit-estado" maxlength="2" style="text-transform: uppercase;">
                </div>
            </div>

            <div class="form-group">
                <label for="edit-observacoes">Observa√ß√µes</label>
                <textarea id="edit-observacoes" rows="3"></textarea>
            </div>

            <div class="btn-group">
                <button type="submit" class="btn btn-primary">Salvar Altera√ß√µes</button>
                <button type="button" class="btn btn-secondary" onclick="fecharModal()">Cancelar</button>
            </div>
        </form>
    </div>
</div>

<script src="{{ url_for('static', filename='js/common.js') }}"></script>
<script>
const API = '/api/clientes';
let clientes = [];

// Formatar datas para exibi√ß√£o
function formatarData(data) {
    if (!data) return '-';
    return new Date(data).toLocaleDateString('pt-BR');
}

// Carregar lista de clientes
async function carregarClientes() {
    try {
        const response = await fetch(API);
        clientes = await response.json();
        renderizarClientes();
    } catch (err) {
        showMessage('Erro ao carregar clientes: ' + err.message, 'error');
    }
}

// Renderizar lista de clientes
function renderizarClientes() {
    const tbody = document.getElementById('lista-clientes');
    const busca = document.getElementById('busca').value.toLowerCase();
    
    const clientesFiltrados = clientes.filter(cliente => 
        cliente.nome.toLowerCase().includes(busca) ||
        (cliente.cpf && cliente.cpf.includes(busca)) ||
        (cliente.telefone && cliente.telefone.includes(busca))
    );

    tbody.innerHTML = clientesFiltrados.map(cliente => `
        <tr>
            <td>${cliente.nome}</td>
            <td>${cliente.cpf || '-'}</td>
            <td>${cliente.telefone || '-'}</td>
            <td>${cliente.email || '-'}</td>
            <td>${cliente.cidade || '-'}</td>
            <td>${cliente.estado || '-'}</td>
            <td>${formatarData(cliente.ultima_compra)}</td>
            <td>
                <button onclick="editarCliente(${cliente.id_cliente})" class="btn-icon" title="Editar">
                    <i class="fas fa-edit"></i>
                </button>
                <button onclick="excluirCliente(${cliente.id_cliente})" class="btn-icon" title="Excluir">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

// Busca din√¢mica
document.getElementById('busca').addEventListener('input', renderizarClientes);

// Formatadores de input
function formatarCPF(e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length > 11) value = value.slice(0, 11);
    if (value.length > 9) value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
    else if (value.length > 6) value = value.replace(/(\d{3})(\d{3})(\d{3})/, '$1.$2.$3');
    else if (value.length > 3) value = value.replace(/(\d{3})(\d{3})/, '$1.$2');
    e.target.value = value;
}

function formatarTelefone(e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length > 11) value = value.slice(0, 11);
    if (value.length > 10) value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
    else if (value.length > 6) value = value.replace(/(\d{2})(\d{4})(\d+)/, '($1) $2-$3');
    else if (value.length > 2) value = value.replace(/(\d{2})(\d+)/, '($1) $2');
    e.target.value = value;
}

document.getElementById('edit-cpf').addEventListener('input', formatarCPF);
document.getElementById('edit-telefone').addEventListener('input', formatarTelefone);

// Fun√ß√µes do modal
function abrirModal() {
    document.getElementById('modal-edicao').style.display = 'block';
}

function fecharModal() {
    document.getElementById('modal-edicao').style.display = 'none';
}

// Editar cliente
async function editarCliente(id) {
    try {
        const response = await fetch(`${API}/${id}`);
        const cliente = await response.json();

        document.getElementById('edit-id').value = cliente.id_cliente;
        document.getElementById('edit-nome').value = cliente.nome;
        document.getElementById('edit-cpf').value = cliente.cpf || '';
        document.getElementById('edit-telefone').value = cliente.telefone || '';
        document.getElementById('edit-email').value = cliente.email || '';
        document.getElementById('edit-endereco').value = cliente.endereco || '';
        document.getElementById('edit-cidade').value = cliente.cidade || '';
        document.getElementById('edit-estado').value = cliente.estado || '';
        document.getElementById('edit-observacoes').value = cliente.observacoes || '';

        abrirModal();
    } catch (err) {
        showMessage('Erro ao carregar dados do cliente: ' + err.message, 'error');
    }
}

// Excluir cliente
async function excluirCliente(id) {
    if (!confirm('Tem certeza que deseja excluir este cliente?')) return;

    try {
        const response = await fetch(`${API}/${id}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            showMessage('Cliente exclu√≠do com sucesso!', 'success');
            carregarClientes();
        } else {
            const error = await response.json();
            showMessage(error.mensagem || 'Erro ao excluir cliente', 'error');
        }
    } catch (err) {
        showMessage('Erro ao excluir cliente: ' + err.message, 'error');
    }
}

// Enviar formul√°rio de edi√ß√£o
document.getElementById('form-editar').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const id = document.getElementById('edit-id').value;
    const cliente = {
        nome: document.getElementById('edit-nome').value,
        cpf: document.getElementById('edit-cpf').value,
        telefone: document.getElementById('edit-telefone').value,
        email: document.getElementById('edit-email').value,
        endereco: document.getElementById('edit-endereco').value,
        cidade: document.getElementById('edit-cidade').value,
        estado: document.getElementById('edit-estado').value.toUpperCase(),
        observacoes: document.getElementById('edit-observacoes').value
    };

    try {
        const response = await fetch(`${API}/${id}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(cliente)
        });

        if (response.ok) {
            showMessage('Cliente atualizado com sucesso!', 'success');
            fecharModal();
            carregarClientes();
        } else {
            const error = await response.json();
            showMessage(error.mensagem || 'Erro ao atualizar cliente', 'error');
        }
    } catch (err) {
        showMessage('Erro ao atualizar cliente: ' + err.message, 'error');
    }
});

// Carregar lista inicial
carregarClientes();
</script>

<style>
.action-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.search-input {
    flex: 1;
    max-width: 300px;
    margin-right: 20px;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.table-container {
    overflow-x: auto;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 20px;
}

th, td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #ddd;
}

th {
    background-color: #f5f5f5;
    font-weight: 600;
}

tr:hover {
    background-color: #f9f9f9;
}

.btn-icon {
    background: none;
    border: none;
    color: #666;
    cursor: pointer;
    padding: 4px 8px;
    margin: 0 2px;
}

.btn-icon:hover {
    color: #000;
}

/* Modal */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: #fff;
    margin: 50px auto;
    padding: 20px;
    border-radius: 8px;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
}

/* Estilos adicionais para o formul√°rio de edi√ß√£o */
#form-editar .form-group {
    margin-bottom: 15px;
}

#form-editar label {
    display: block;
    margin-bottom: 5px;
    color: #666;
    font-weight: 500;
}

#form-editar input,
#form-editar textarea {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

#form-editar textarea {
    resize: vertical;
}
</style>
{% endblock %}